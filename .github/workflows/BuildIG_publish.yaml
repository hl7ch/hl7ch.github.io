name: Build IG and publish

on:
  workflow_dispatch:
    inputs:
      orgrepo:
        description: 'Github repository of the IG e.g. hl7ch/ch-ig'
        required: true
        default: 'hl7ch/ch-'
        type: string
      version:
        description: 'Version of the IG'
        required: true
        default: '1.0.0'
        type: string
      publish:
        description: 'Publish to github / fhir.ch if build is successful'
        required: true
        default: true
        type: boolean

# The following jobs are equal for all IGs and can be moved to a common composite-action if 'uses'-support is added, see:
# https://github.com/actions/runner/blob/main/docs/adrs/1144-composite-actions.md
jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: 'write'
    env:
      orgrepo: "${{ github.event.inputs.orgrepo }}"
      version: "${{ github.event.inputs.version }}"
      publish: "${{ github.event.inputs.publish }}"
    steps:
      - name: ğŸ“¦ Build and test with Rake        
        run: |
          sudo apt-get update
          sudo apt-get install ruby-full
          sudo gem install jekyll

      - name: ğŸ“¦ Install modules
        run: npm install -g fsh-sushi

      - name: â˜• Setup Java 21
        uses: actions/setup-java@v3
        with:
          java-version: 21
          distribution: adopt

      - name: ğŸ“ Get the repo name
        id: repo_name
        run: echo "::set-output name=repo::$(echo ${{ env.orgrepo }} | cut -d '/' -f 2)"
        shell: bash

      - name: ğŸ“ Change to workspace
        run: echo "Changing to workspace "
        working-directory: ${{ github.workspace }}          

      - name: ğŸ“ Workspace
        run: echo "${{ github.workspace }}"
        shell: bash

      - uses: actions/checkout@v4
        with:
          sparse-checkout: |
            .github
            assets
            templates
            ig-history
            ig-registry
            ig/${{ steps.repo_name.outputs.repo }}

      - uses: actions/checkout@v4
        if: ${{ steps.repo_name.outputs.repo == 'ch-term' }}
        with:
          sparse-checkout: |
            .github
            assets
            templates
            ig-history
            ig-registry
            ig/ch-term
            ig/ch-epr-term

      - uses: actions/checkout@v4
        if: ${{ steps.repo_name.outputs.repo == 'ch-epr-fhir' }}
        with:
          sparse-checkout: |
            .github
            assets
            templates
            ig-history
            ig-registry
            ig/ch-epr-fhir
            ig/ch-epr-mhealth

      - uses: actions/checkout@v4
        with:
          repository: ${{ env.orgrepo }}
          path: ${{ steps.repo_name.outputs.repo }} 
        
      - name: ğŸ“¥ Download IG Publisher
        run: |
              wget -q https://github.com/HL7/fhir-ig-publisher/releases/latest/download/publisher.jar
              ls -all ./publisher.jar

      - name: ğŸ“ List path
        run: ls -R ./

      # Builds the HTML page for the IG.
      - name: ğŸƒâ€â™‚ï¸ Run IG Publisher local
        timeout-minutes: 45 # We need a long timeout here
        run: |
              cd ${{ steps.repo_name.outputs.repo }}
              java -Xmx8192m -jar ../publisher.jar  -ig .
              cd ..

      - name: ğŸƒâ€â™‚ï¸ Run Publication
        timeout-minutes: 135 # We need a long timeout here
        run: |
              java -jar -Dfile.encoding=UTF-8 -Xms3550m -Xmx3550m ./publisher.jar -go-publish -source ${{ steps.repo_name.outputs.repo }} -web $PWD -registry ig-registry/fhir-ig-list.json -history ig-history -templates ./templates -temp $PWD/buildtmp

      - name: ğŸ™ Clean download git repo
        run: rm -rf ${{ steps.repo_name.outputs.repo }}
        shell: bash

      - name: ğŸ™ Commit and push changes
        if: ${{ env.publish }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "${{ steps.repo_name.outputs.repo }} - ${{ env.version }}"
          git push

      - id: 'auth'
        if: ${{ env.publish }}
        uses: 'google-github-actions/auth@v2'
        with:                                     
          workload_identity_provider: 'projects/436430299306/locations/global/workloadIdentityPools/pool1/providers/oidc-github-provider'
          service_account: 'github-fhir-ch@fhir-ch.iam.gserviceaccount.com'

      - name: 'â˜ï¸ Set up Cloud SDK'
        if: ${{ env.publish }}
        uses: 'google-github-actions/setup-gcloud@v2'
        with:
          version: '>= 363.0.0'

      - name: 'â˜ï¸ Use gcloud CLI'
        if: ${{ env.publish }}
        run: 'gcloud info'

      - name: 'ğŸšš Publish IG to fhir.ch ğŸš€ ğŸš€ ğŸš€ '
        if: ${{ env.publish }}
        run: |
          gsutil -m rsync ./ig/${{ steps.repo_name.outputs.repo }} gs://fhir-ch-www/ig/${{ steps.repo_name.outputs.repo }}
          gsutil -m rsync -r ./ig/${{ steps.repo_name.outputs.repo }}/assets gs://fhir-ch-www/ig/${{ steps.repo_name.outputs.repo }}/assets
          gsutil -m rsync -r ./ig/${{ steps.repo_name.outputs.repo }}/${{ env.version }} gs://fhir-ch-www/ig/${{ steps.repo_name.outputs.repo }}/${{ env.version }}
          gsutil cp ./package-feed.xml gs://fhir-ch-www/
          gsutil cp ./package-registry.json gs://fhir-ch-www/
          gsutil cp ./publication-feed.xml gs://fhir-ch-www/