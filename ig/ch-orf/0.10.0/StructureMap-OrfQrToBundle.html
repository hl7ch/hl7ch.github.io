<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE HTML>
<html xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type"/>
    <title>CH.FHIR.IG.CH-ORF\Map ORF - FHIR v4.0.1</title>

    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta name="author" content="http://hl7.org/fhir"/>

    <link href="fhir.css" rel="stylesheet"/>

    <!-- Bootstrap core CSS -->
    <link href="assets/css/bootstrap-fhir.css" rel="stylesheet"/>

    <!-- Project extras -->
    <link href="assets/css/project.css" rel="stylesheet"/>
    <link href="assets/css/pygments-manni.css" rel="stylesheet"/>
    <link href="assets/css/jquery-ui.css" rel="stylesheet"/>
  	<link href="assets/css/prism.css" rel="stylesheet" />
    <!-- Placeholder for child template CSS declarations -->
    <link href="assets/css/hl7.css" rel="stylesheet"/>
    <link href="assets/css/fhir.css" rel="stylesheet"/>

    <script type="text/javascript" src="fhir-table-scripts.js"> </script>

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="assets/js/html5shiv.js"></script>
    <script src="assets/js/respond.min.js"></script>
    <![endif]-->

    <!-- Favicons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="assets/ico/apple-touch-icon-144-precomposed.png"/>
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="assets/ico/apple-touch-icon-114-precomposed.png"/>
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="assets/ico/apple-touch-icon-72-precomposed.png"/>
    <link rel="apple-touch-icon-precomposed" href="assets/ico/apple-touch-icon-57-precomposed.png"/>
    <link rel="shortcut icon" href="assets/ico/favicon.png"/>
  </head>
  <body onload="document.body.style.opacity='1'">

	  <script src="assets/js/prism.js"></script>

    <style type="text/css">h2{--heading-prefix:"10.26"}
    h3,h4,h5,h6{--heading-prefix:"10.26"}</style>
    <div id="segment-header" class="segment">  <!-- segment-header -->
      <div class="container">  <!-- container -->
        <!-- Placeholder for child template header declarations -->

            <!--
<div id="family-nav">
	<a id="logo" no-external="true" href="http://hl7.org/fhir"> <img
		alt="logo fhir" src="assets/images/fhir-logo-www.png" />
	</a>
</div>
-->


            <div id="hl7-nav">
    <a id="hl7-logo" no-external="true" href="http://www.hl7.ch">
        <img alt="visit the hl7 website" height="50" src="hl7-logo.png" />
    </a>            
</div>

        <div id="ig-status">
          <p><span style="font-size:12pt;font-weight:bold">CH ORF (R4)</span><br/>0.10.0 - STU 1 Ballot</p>
        </div>
      </div> <!-- /container -->
    </div>  <!-- /segment-header -->

    <div id="segment-navbar" class="segment">  <!-- segment-navbar -->
      <div id="stripe"> </div>
      <div class="container">  <!-- container -->
        <!-- HEADER CONTENT -->

        <nav class="navbar navbar-inverse">
          <!--status-bar-->
          <div class="container">
            <button data-target=".navbar-inverse-collapse" class="navbar-toggle" data-toggle="collapse" type="button">
              <span class="icon-bar"> </span>
              <span class="icon-bar"> </span>
              <span class="icon-bar"> </span>
            </button>
            <a class="navbar-brand hidden" href="http://hl7.org/fhir/R4/index.html">FHIR</a>
            <div class="nav-collapse collapse navbar-inverse-collapse">
              <ul xmlns="http://www.w3.org/1999/xhtml" class="nav navbar-nav">
  <!--<li>
    <a href="toc.html">Table of Contents</a>
  </li>-->
  <li>
    <a href="index.html">Home</a>
  </li>
  <li class="dropdown">
    <a data-toggle="dropdown" href="#" class="dropdown-toggle">Use Cases<b class="caret">
      </b>
    </a>
    <ul class="dropdown-menu">
      <li>
        <a href="usecase-english.html">English</a>
      </li>
      <li>
        <a href="usecase-german.html">German</a>
      </li>
      <li>
        <a href="usecase-french.html">French</a>
      </li>
    </ul>
  </li>
  <li>
    <a href="questionnaire.html">Questionnaire</a>
  </li>
  <li>
    <a href="document.html">Document</a>
  </li>
  <li>
    <a href="profiles.html">Profiles</a>
  </li>
  <li>
    <a href="extensions.html">Extensions</a>
  </li>
  <li>
    <a href="terminology.html">Terminology</a>
  </li>
  <li>
    <a href="artifacts.html">Artifacts</a>
  </li>
</ul>
            </div>  <!-- /.nav-collapse -->
          </div>  <!-- /.container -->
        </nav>  <!-- /.navbar -->
      <!-- /HEADER CONTENT -->
      </div>  <!-- /container -->
    </div>  <!-- /segment-navbar -->
    <!--status-bar-->

    <div id="segment-breadcrumb" class="segment">  <!-- segment-breadcrumb -->
      <div class="container">  <!-- container -->
        <ul class="breadcrumb">
          <li><a href='toc.html'><b>Table of Contents</b></a></li><li><a href='artifacts.html'><b>Artifacts Summary</b></a></li><li><b>Map ORF</b></li>

        </ul>
      </div>  <!-- /container -->
    </div>  <!-- /segment-breadcrumb -->

    <a name="top"> </a>
    <div id="segment-content" class="segment">  <!-- segment-content -->
      <div class="container">  <!-- container -->
        <div class="row">
          <div class="inner-wrapper">

<div class="col-12">
  <!--ReleaseHeader--><p id="publish-box">This page is part of the CH ORF (R4) (v0.10.0: <a data-no-external="true" href="https://confluence.hl7.org/display/HL7/HL7+Balloting" title="Standard for Trial-Use">STU</a> 1) based on <a data-no-external="true" href="http://hl7.org/fhir/R4">FHIR (HL7® FHIR® Standard) R4</a>. The current version which supersedes this version is <a data-no-external="true" href="http://fhir.ch/ig/ch-orf">3.0.2</a>.  For a full list of available versions, see the <a data-no-external="true" href="http://fhir.ch/ig/ch-orf/history.html">Directory of published versions</a></p><!--EndReleaseHeader-->

  






<ul class="nav nav-tabs">

  <li class="active">
    <a href="#">Narrative Content</a>
  </li>


  
    <li>
      <a href="StructureMap-OrfQrToBundle.xml.html">XML</a>
    </li>
  


  
    <li>
      <a href="StructureMap-OrfQrToBundle.json.html">JSON</a>
    </li>
  


  
    <li>
      <a href="StructureMap-OrfQrToBundle.ttl.html">TTL</a>
    </li>
  



</ul>


  <a name="root"> </a>


  <h2 id="root">StructureMap: Map ORF</h2>


  


  <!-- insert intro if present -->
  



  <div xmlns="http://www.w3.org/1999/xhtml">
         <pre>map &quot;http://fhir.ch/ig/ch-orf/StructureMap/OrfQrToBundle&quot; = &quot;OrfQrToBundle&quot;

// ORF QuestionnaireResponse to Bundle
// 2021-01-11 Oliver Egger, copyright ahdis ag, Apache License
// QRF Questionnaire: http://build.fhir.org/ig/hl7ch/ch-orf/Questionnaire-order-referral-form.html
// QRF QuestionnaireResponse: http://build.fhir.org/ig/hl7ch/ch-orf/QuestionnaireResponse-order-referral-form.xml.html
// Bundle: http://build.fhir.org/ig/hl7ch/ch-orf/StructureDefinition-ch-orf-document.html

uses &quot;http://hl7.org/fhir/StructureDefinition/QuestionnaireResponse&quot; alias QuestionnaireResponse as source
uses &quot;http://hl7.org/fhir/StructureDefinition/Bundle&quot; alias Bundle as target
uses &quot;http://hl7.org/fhir/StructureDefinition/Patient&quot; alias Patient as target
uses &quot;http://hl7.org/fhir/StructureDefinition/Organization&quot; alias Organization as target
uses &quot;http://hl7.org/fhir/StructureDefinition/Practitioner&quot; alias Practitioner as target
uses &quot;http://hl7.org/fhir/StructureDefinition/PractitionerRole&quot; alias PractitionerRole as target
uses &quot;http://hl7.org/fhir/StructureDefinition/ServiceRequest&quot; alias ServiceRequest as target
uses &quot;http://hl7.org/fhir/StructureDefinition/BackboneElement&quot; alias BackboneElement as target

group OrfQrToBundle(source qr : QuestionnaireResponse, target bundle : Bundle) {
  qr -&gt;  bundle.identifier as documentIdentifier,  documentIdentifier.system = 'urn:ietf:rfc:3986',  uuid() as uuidDoc,  documentIdentifier.value = append('urn:uuid:', uuidDoc) &quot;documentIdentifier&quot;;
  qr as qrcp -&gt;  bundle.entry as e,  e.resource = create('Composition') as composition,  composition.id = uuid() as uuid,  e.fullUrl = append('urn:uuid:', uuid),  bundle.entry as e2,  bundle.timestamp = (now()) as timestamp,  composition.date = timestamp,  e2.resource = create('Patient') as patient,  patient.id = uuid() as uuid2,  e2.fullUrl = append('urn:uuid:', uuid2),  bundle.entry as e4,  e4.resource = qrcp as questionnaireresp,  questionnaireresp.id = uuid() as uuid4,  e4.fullUrl = append('urn:uuid:', uuid4),  bundle.entry as e5,  e5.resource = create('ServiceRequest') as servicerequest,  servicerequest.id = uuid() as uuid5,  e5.fullUrl = append('urn:uuid:', uuid5) then {
    qr.questionnaire as can -&gt;  bundle.entry as e6,  e6.resource = (can.resolve()) as q,  q.id = uuid() as uuid6,  e6.fullUrl = append('urn:uuid:', uuid6) then QrToBundle(qr, q, patient, questionnaireresp, servicerequest, composition, bundle) &quot;orfbundle&quot;;
  } &quot;orfbundle&quot;;
}

group QrToGroups(source qr : QuestionnaireResponse, target patient : Patient, target bundle : Bundle, target composition : Composition, target serviceRequest : ServiceRequest) {
  qr.item as grp where linkId = 'order' then OrderItems(grp, bundle, composition, serviceRequest) &quot;grporder&quot;;
  qr.item as grp where linkId = 'receiver' then ReceiverInit(grp, bundle, composition, serviceRequest) &quot;receiver&quot;;
  qr.item as grp where linkId = 'patient' then PatientItems(grp, patient) &quot;grppatient&quot;;
  qr.item as grp where linkId = 'requestedEncounter' then RequestedEncounterItems(grp, bundle, patient, serviceRequest) &quot;grprequestedencounter&quot;;
  qr.item as grp where linkId = 'coverage' then Coverage(grp, bundle, patient, serviceRequest) &quot;grprequestedencounter&quot;;
  qr.item as grp where linkId = 'sender' then SenderAuthorInit(grp, bundle, composition, serviceRequest) &quot;grpsender&quot;;
  qr.item as grp where linkId = 'receiverCopies' then ReceiverCopy(grp, bundle, composition, serviceRequest) &quot;grpsender&quot;;
  qr.item as grp where linkId = 'appointment' then Appointment(grp, bundle, composition, serviceRequest) &quot;grpsender&quot;;
  qr.item as grp where linkId = 'note' then Note(grp, serviceRequest) &quot;note&quot;;
}

group OrderItems(source src : BackboneElement, target bundle : Bundle, target composition, target serviceRequest : ServiceRequest) {
  src.item as item where ((linkId.value = 'order.title') and answer.exists()) -&gt; composition.title = (item.answer.valueString) &quot;title&quot;;
  src.item as item where ((linkId.value = 'order.type') and answer.exists()) then {
    item.answer as answer then {
      answer.value : Coding as coding -&gt;  composition.type as comptype,  comptype.coding = coding &quot;type&quot;;
    };
  } &quot;type&quot;;
  src.item as item where ((linkId.value = 'order.category') and answer.exists()) then {
    item.answer as answer then {
      answer.value : Coding as coding -&gt;  composition.category as compcat,  compcat.coding = coding &quot;category&quot;;
    };
  } &quot;category&quot;;
  src.item as item where ((linkId.value = 'order.precedentDocumentIdentifier') and answer.exists()) -&gt;  composition.extension as ext,  ext.url = 'http://fhir.ch/ig/ch-orf/StructureDefinition/ch-orf-precedentdocument',  ext.value = create('Identifier') as value,  value.system = 'urn:ietf:rfc:3986',  value.value = ('urn:uuid:' + item.answer.valueString) &quot;precedentDocumentIdentifier&quot;;
  src.item as item where ((linkId.value = 'order.placerOrderIdentifier') and answer.exists()) -&gt;  serviceRequest.identifier as value share placer,  value.type as type,  type.coding as coding,  coding.system = 'http://terminology.hl7.org/CodeSystem/v2-0203',  coding.code = 'PLAC',  value.value = (item.answer.valueString) &quot;placerOrderIdentifier&quot;;
  src.item as item where ((linkId.value = 'order.placerOrderIdentifierDomain') and answer.exists()) -&gt;  serviceRequest.identifier as value share placer,  value.system = (item.answer.valueString) &quot;placerOrderIdentifierDomain&quot;;
  src.item as item where ((linkId.value = 'order.fillerOrderIdentifier') and answer.exists()) -&gt;  serviceRequest.identifier as value share filler,  value.type as type,  type.coding as coding,  coding.system = 'http://terminology.hl7.org/CodeSystem/v2-0203',  coding.code = 'FILL',  value.value = (item.answer.valueString) &quot;fillerOrderIdentifier&quot;;
  src.item as item where ((linkId.value = 'order.fillerOrderIdentifierDomain') and answer.exists()) -&gt;  serviceRequest.identifier as value share filler,  value.system = (item.answer.valueString) &quot;fillerOrderIdentifierDomain&quot;;
  src.item as item where ((linkId.value = 'order.dateTime') and answer.exists()) -&gt; serviceRequest.authoredOn = (item.answer.value);
  src.item as item where ((linkId.value = 'order.priority') and answer.exists()) -&gt; serviceRequest.priority = (item.answer.value.code);
  src.item as item where (linkId.value = 'order.notificationContactDocument') then {
    item -&gt;  bundle.entry as e4,  e4.resource = create('PractitionerRole') as practitionerRoleDataEnterer,  practitionerRoleDataEnterer.id = uuid() as uuid4,  e4.fullUrl = append('urn:uuid:', uuid4),  composition.extension as extension,  bundle.entry as e5,  e5.resource = create('Practitioner') as practitionerDataEnterer,  practitionerDataEnterer.id = uuid() as uuid5,  e5.fullUrl = append('urn:uuid:', uuid5),  practitionerRoleDataEnterer.practitioner = create('Reference') as reference,  reference.reference = append('urn:uuid:', uuid5) then {
      item then UrgentNotificationContactForRequestItems(item, practitionerRoleDataEnterer, practitionerDataEnterer) &quot;data&quot;;
      item then ExtOrfUrgentNotificationContactForRequest(item, practitionerRoleDataEnterer, extension) &quot;extension&quot;;
    } &quot;items&quot;;
  } &quot;notificationContactDocument&quot;;
  src.item as item where (linkId.value = 'order.notificationContactDocumentResponse') then {
    item -&gt;  bundle.entry as e4,  e4.resource = create('PractitionerRole') as practitionerRoleDataEnterer,  practitionerRoleDataEnterer.id = uuid() as uuid4,  e4.fullUrl = append('urn:uuid:', uuid4),  composition.extension as extension,  bundle.entry as e5,  e5.resource = create('Practitioner') as practitionerDataEnterer,  practitionerDataEnterer.id = uuid() as uuid5,  e5.fullUrl = append('urn:uuid:', uuid5),  practitionerRoleDataEnterer.practitioner = create('Reference') as reference,  reference.reference = append('urn:uuid:', uuid5) then {
      item then UrgentNotificationContactForResponseItems(item, practitionerRoleDataEnterer, practitionerDataEnterer) &quot;data&quot;;
      item then ExtOrfUrgentNotificationContactForResponse(item, practitionerRoleDataEnterer, extension) &quot;extension&quot;;
    } &quot;items&quot;;
  } &quot;notificationContactDocumentResponse&quot;;
}

group UrgentNotificationContactForRequestPractitionerItems(source src : BackboneElement, target practitioner : Practitioner) {
  src.item as item where ((linkId.value = 'order.notificationContactDocument.practitioner.familyName') and answer.exists()) -&gt;  practitioner.name as name share practitionerName,  name.family = (item.answer.value);
  src.item as item where ((linkId.value = 'order.notificationContactDocument.practitioner.givenName') and answer.exists()) -&gt;  practitioner.name as name share practitionerName,  name.given = (item.answer.value);
  src.item as item where ((linkId.value = 'order.notificationContactDocument.practitioner.title') and answer.exists()) -&gt;  practitioner.name as name share practitionerName,  name.prefix = (item.answer.value) as prefix,  prefix.extension as ext,  ext.url = 'http://hl7.org/fhir/StructureDefinition/iso21090-EN-qualifier',  ext.value = create('code') as value,  value.value = 'AC' &quot;title&quot;;
  src.item as item where ((linkId.value = 'order.notificationContactDocument.practitioner.phone') and answer.exists()) -&gt;  practitioner.telecom as value,  value.system = 'phone',  value.value = (item.answer.value) &quot;phone&quot;;
  src.item as item where ((linkId.value = 'order.notificationContactDocument.practitioner.email') and answer.exists()) -&gt;  practitioner.telecom as value,  value.system = 'email',  value.value = (item.answer.value) &quot;email&quot;;
}

group UrgentNotificationContactForRequestItems(source src : BackboneElement, target practitionerRole : practitionerRole, target practitioner : Practitioner) {
  src.item as item where (linkId.value = 'order.notificationContactDocument.practitioner') then UrgentNotificationContactForRequestPractitionerItems(item, practitioner);
}

group ExtOrfUrgentNotificationContactForRequest(source src : BackboneElement, target practitionerRole : PractitionerRole, target ext : Extension) {
  src -&gt; ext.url = 'http://fhir.ch/ig/ch-orf/StructureDefinition/ch-orf-urgentnoficationcontactforthisdocument' &quot;url&quot;;
  src -&gt;  ext.value = create('Reference') as reference,  reference.reference = ('urn:uuid:' + %practitionerRole.id) &quot;practitionerRole&quot;;
}

group UrgentNotificationContactForResponsePractitionerItems(source src : BackboneElement, target practitioner : Practitioner) {
  src.item as item where ((linkId.value = 'order.notificationContactDocumentResponse.practitioner.familyName') and answer.exists()) -&gt;  practitioner.name as name share practitionerName,  name.family = (item.answer.value);
  src.item as item where ((linkId.value = 'order.notificationContactDocumentResponse.practitioner.givenName') and answer.exists()) -&gt;  practitioner.name as name share practitionerName,  name.given = (item.answer.value);
  src.item as item where ((linkId.value = 'order.notificationContactDocumentResponse.practitioner.title') and answer.exists()) -&gt;  practitioner.name as name share practitionerName,  name.prefix = (item.answer.value) as prefix,  prefix.extension as ext,  ext.url = 'http://hl7.org/fhir/StructureDefinition/iso21090-EN-qualifier',  ext.value = create('code') as value,  value.value = 'AC' &quot;title&quot;;
  src.item as item where ((linkId.value = 'order.notificationContactDocumentResponse.practitioner.phone') and answer.exists()) -&gt;  practitioner.telecom as value,  value.system = 'phone',  value.value = (item.answer.value) &quot;phone&quot;;
  src.item as item where ((linkId.value = 'order.notificationContactDocumentResponse.practitioner.email') and answer.exists()) -&gt;  practitioner.telecom as value,  value.system = 'email',  value.value = (item.answer.value) &quot;email&quot;;
}

group UrgentNotificationContactForResponseItems(source src : BackboneElement, target practitionerRole : practitionerRole, target practitioner : Practitioner) {
  src.item as item where (linkId.value = 'order.notificationContactDocumentResponse.practitioner') then UrgentNotificationContactForResponsePractitionerItems(item, practitioner);
}

group ExtOrfUrgentNotificationContactForResponse(source src : BackboneElement, target practitionerRole : PractitionerRole, target ext : Extension) {
  src -&gt; ext.url = 'http://fhir.ch/ig/ch-orf/StructureDefinition/ch-orf-urgentnoficationcontactfortheresponsetothisdocument' &quot;url&quot;;
  src -&gt;  ext.value = create('Reference') as reference,  reference.reference = ('urn:uuid:' + %practitionerRole.id) &quot;practitionerRole&quot;;
}

group ReceiverPractitionerItems(source src : BackboneElement, target practitioner : Practitioner) {
  src.item as item where ((linkId.value = 'receiver.practitioner.familyName') and answer.exists()) -&gt;  practitioner.name as name share practitionerName,  name.family = (item.answer.value);
  src.item as item where ((linkId.value = 'receiver.practitioner.givenName') and answer.exists()) -&gt;  practitioner.name as name share practitionerName,  name.given = (item.answer.value);
  src.item as item where ((linkId.value = 'receiver.practitioner.title') and answer.exists()) -&gt;  practitioner.name as name share practitionerName,  name.prefix = (item.answer.value) as prefix,  prefix.extension as ext,  ext.url = 'http://hl7.org/fhir/StructureDefinition/iso21090-EN-qualifier',  ext.value = create('code') as value,  value.value = 'AC' &quot;title&quot;;
  src.item as item where ((linkId.value = 'receiver.practitioner.gln') and answer.exists()) -&gt;  practitioner.identifier as value,  value.system = 'urn:oid:2.51.1.3',  value.value = (item.answer.value) &quot;gln&quot;;
  src.item as item where ((linkId.value = 'receiver.practitioner.phone') and answer.exists()) -&gt;  practitioner.telecom as value,  value.system = 'phone',  value.value = (item.answer.value) &quot;phone&quot;;
  src.item as item where ((linkId.value = 'receiver.practitioner.email') and answer.exists()) -&gt;  practitioner.telecom as value,  value.system = 'email',  value.value = (item.answer.value) &quot;email&quot;;
}

group ReceiverOrganizationItems(source src : BackboneElement, target organization : Organization) {
  src.item as item where ((linkId.value = 'receiver.organization.name') and answer.exists()) -&gt; organization.name = (item.answer.value);
  src.item as item where ((linkId.value = 'receiver.organization.streetAddressLine') and answer.exists()) -&gt; organization.address as address share orgAddress then {
    item.answer as answer -&gt; address.line = (answer.value) &quot;streetAddressLine&quot;;
  } &quot;answer&quot;;
  src.item as item where ((linkId.value = 'receiver.organization.postalCode') and answer.exists()) -&gt;  organization.address as address share orgAddress,  address.postalCode = (item.answer.value) &quot;postalCode&quot;;
  src.item as item where ((linkId.value = 'receiver.organization.city') and answer.exists()) -&gt;  organization.address as address share orgAddress,  address.city = (item.answer.value) &quot;city&quot;;
  src.item as item where ((linkId.value = 'receiver.organization.country') and answer.exists()) -&gt;  organization.address as address share orgAddress,  address.country = (item.answer.value) &quot;country&quot;;
}

group ReceiverItems(source src : BackboneElement, target practitionerRole : practitionerRole, target practitioner : Practitioner, target organization : Organization) {
  src.item as item where (linkId.value = 'receiver.practitioner') then ReceiverPractitionerItems(item, practitioner);
  src.item as item where (linkId.value = 'receiver.organization') then ReceiverOrganizationItems(item, organization);
}

group ReceiverInit(source src : BackboneElement, target bundle : Bundle, target composition : Composition, target serviceRequest : ServiceRequest) {
  src -&gt;  bundle.entry as e,  e.resource = create('PractitionerRole') as practitionerRole,  practitionerRole.id = uuid() as uuid,  e.fullUrl = append('urn:uuid:', uuid),  bundle.entry as e2,  e2.resource = create('Practitioner') as practitioner,  practitioner.id = uuid() as uuid2,  e2.fullUrl = append('urn:uuid:', uuid2),  bundle.entry as e3,  e3.resource = create('Organization') as organization,  organization.id = uuid() as uuid3,  e3.fullUrl = append('urn:uuid:', uuid3),  composition.extension as ext,  ext.url = 'http://fhir.ch/ig/ch-orf/StructureDefinition/ch-orf-receiver',  ext.value = create('Reference') as reference,  reference.reference = append('urn:uuid:', uuid),  practitionerRole.practitioner = create('Reference') as reference,  reference.reference = append('urn:uuid:', uuid2),  practitionerRole.organization = create('Reference') as reference,  reference.reference = append('urn:uuid:', uuid3) then ReceiverItems(src, practitionerRole, practitioner, organization) &quot;receiver&quot;;
}

group PatientItems(source src : BackboneElement, target tgt : Patient) {
  src.item as item then PatientItems(item, tgt);
  src.item as item where ((linkId.value = 'patient.familyName') and answer.exists()) -&gt;  tgt.name as name share patientName,  name.family = (item.answer.value);
  src.item as item where ((linkId.value = 'patient.maidenName') and answer.exists()) -&gt;  tgt.name as name,  name.use = 'maiden',  name.family = (item.answer.value);
  src.item as item where ((linkId.value = 'patient.givenName') and answer.exists()) -&gt;  tgt.name as name share patientName,  name.given = (item.answer.value);
  src.item as item where ((linkId.value = 'patient.localPid') and answer.exists()) -&gt;  tgt.identifier as value share localpid,  value.type as type,  type.coding as coding,  coding.system = 'http://terminology.hl7.org/CodeSystem/v2-0203',  coding.code = 'MR',  value.value = (item.answer.valueString) &quot;localPid&quot;;
  src.item as item where ((linkId.value = 'patient.localPidDomain') and answer.exists()) -&gt;  tgt.identifier as value share localpid,  value.system = (item.answer.valueString) &quot;localPidDomain&quot;;
  src.item as item where ((linkId.value = 'patient.birthDate') and answer.exists()) -&gt; tgt.birthDate = (item.answer.value);
  src.item as item where ((linkId.value = 'patient.gender') and answer.exists()) -&gt; tgt.gender = (item.answer.value.code);
  src.item as item where ((linkId.value = 'patient.phone') and answer.exists()) -&gt;  tgt.telecom as value,  value.system = 'phone',  value.value = (item.answer.value) &quot;phone&quot;;
  src.item as item where ((linkId.value = 'patient.email') and answer.exists()) -&gt;  tgt.telecom as value,  value.system = 'email',  value.value = (item.answer.value) &quot;email&quot;;
  src.item as item where ((linkId.value = 'patient.streetAddressLine') and answer.exists()) -&gt; tgt.address as address share orgAddress then {
    item.answer as answer -&gt; address.line = (answer.value) &quot;streetAddressLine&quot;;
  } &quot;answer&quot;;
  src.item as item where ((linkId.value = 'patient.postalCode') and answer.exists()) -&gt;  tgt.address as address share orgAddress,  address.postalCode = (item.answer.value) &quot;postalCode&quot;;
  src.item as item where ((linkId.value = 'patient.city') and answer.exists()) -&gt;  tgt.address as address share orgAddress,  address.city = (item.answer.value) &quot;city&quot;;
  src.item as item where ((linkId.value = 'patient.country') and answer.exists()) -&gt;  tgt.address as address share orgAddress,  address.country = (item.answer.value) &quot;country&quot;;
  src.item as item where (linkId.value = 'patient.contactperson') -&gt; tgt.contact as contact then {
    item.item as item where ((linkId.value = 'patient.contactperson.familyName') and answer.exists()) -&gt;  contact.name as name share contactName,  name.family = (item.answer.value);
    item.item as item where ((linkId.value = 'patient.contactperson.givenName') and answer.exists()) -&gt;  contact.name as name share contactName,  name.given = (item.answer.value);
    item.item as item where ((linkId.value = 'patient.contactperson.phone') and answer.exists()) -&gt;  contact.telecom as value,  value.system = 'phone',  value.value = (item.answer.value) &quot;phone&quot;;
    item.item as item where ((linkId.value = 'patient.contactperson.email') and answer.exists()) -&gt;  contact.telecom as value,  value.system = 'email',  value.value = (item.answer.value) &quot;email&quot;;
    item.item as item where ((linkId.value = 'patient.contactperson.relationship') and answer.exists()) -&gt;  contact.relationship as relationship,  relationship.text = (item.answer.value) &quot;relationship&quot;;
  } &quot;contact&quot;;
}

group RequestedEncounterItems(source src : BackboneElement, target bundle : Bundle, target patient : Patient, target serviceRequest : ServiceRequest) {
  src -&gt;  bundle.entry as e4,  e4.resource = create('Encounter') as encounter,  encounter.id = uuid() as uuid4,  e4.fullUrl = ('urn:uuid:' + %uuid4),  encounter.status = 'planned',  serviceRequest.extension as extension,  encounter.subject = create('Reference') as subject,  subject.reference = ('urn:uuid:' + %patient.id),  extension.url = 'http://fhir.ch/ig/ch-orf/StructureDefinition/ch-orf-requestedencounterdetails',  extension.value = create('Reference') as reference,  reference.reference = ('urn:uuid:' + %uuid4) then {
    src.item as item where ((linkId.value = 'requestedEncounter.class') and answer.exists()) -&gt; encounter.class = (item.answer.value) &quot;class&quot;;
    src.item as item where ((linkId.value = 'requestedEncounter.desiredAccommodation') and answer.exists()) -&gt;  encounter.extension as extension,  extension.url = 'http://fhir.ch/ig/ch-orf/StructureDefinition/ch-orf-desiredaccommodation',  extension.value = (item.answer.value) &quot;desiredAccommodation&quot;;
  } &quot;RequestedEncounterItems&quot;;
}

group Coverage(source src : BackboneElement, target bundle : Bundle, target patient : Patient, target serviceRequest : ServiceRequest) {
  // coverage.beneficiary
  src.item as item where where(linkId.value = 'coverage.beneficiary') then {
    item.item as item where ((linkId.value = 'coverage.beneficiary.ahvn13') and answer.exists()) -&gt;  patient.identifier as identifier,  identifier.system = 'urn:oid:2.16.756.5.32',  identifier.value = (item.answer.value) &quot;ahvn13&quot;;
  } &quot;beneficiary&quot;;
  // coverage.kvg
  src.item as item where where(linkId.value = 'coverage.kvg') -&gt;  bundle.entry as e4,  e4.resource = create('Coverage') as coverage,  coverage.id = uuid() as uuid4,  e4.fullUrl = ('urn:uuid:' + %uuid4),  serviceRequest.insurance as insurance,  insurance.reference = ('urn:uuid:' + %uuid4),  coverage.status = 'active',  coverage.beneficiary = create('Reference') as subject,  subject.reference = ('urn:uuid:' + %patient.id),  coverage.type as type,  type.coding as coding,  coding.system = 'http://fhir.ch/ig/ch-orf/CodeSystem/ch-orf-cs-coveragetype',  coding.code = 'KVG' then {
    item.item as item where ((linkId.value = 'coverage.kvg.name') and answer.exists()) -&gt;  coverage.payor as payor,  payor.reference as refcontained,  refcontained.value = '#org',  coverage.contained = create('Organization') as organization,  organization.id = 'org',  organization.name = (item.answer.value) &quot;name&quot;;
    item.item as item where ((linkId.value = 'coverage.kvg.insuranceCardNumber') and answer.exists()) -&gt;  coverage.identifier as identifier,  identifier.type as typeid,  typeid.coding as coding,  coding.system = 'http://fhir.ch/ig/ch-orf/CodeSystem/ch-orf-cs-coverageidentifiertype',  coding.code = 'VeKa',  identifier.value = (item.answer.value) &quot;insuranceCardNumber&quot;;
  } &quot;coveragekvg&quot;;
  // coverage.uvg	Unfallversicherung (nach UVG)	0..1	group		Definition: Coverage.type
  src.item as item where where(linkId.value = 'coverage.uvg') -&gt;  bundle.entry as e4,  e4.resource = create('Coverage') as coverage,  coverage.id = uuid() as uuid4,  e4.fullUrl = ('urn:uuid:' + %uuid4),  serviceRequest.insurance as insurance,  insurance.reference = ('urn:uuid:' + %uuid4),  coverage.status = 'active',  coverage.beneficiary = create('Reference') as subject,  subject.reference = ('urn:uuid:' + %patient.id),  coverage.type as type,  type.coding as coding,  coding.system = 'http://fhir.ch/ig/ch-orf/CodeSystem/ch-orf-cs-coveragetype',  coding.code = 'UVG' then {
    item.item as item where ((linkId.value = 'coverage.uvg.name') and answer.exists()) -&gt;  coverage.payor as payor,  payor.reference as refcontained,  refcontained.value = '#org',  coverage.contained = create('Organization') as organization,  organization.id = 'org',  organization.name = (item.answer.value) &quot;name&quot;;
    item.item as item where ((linkId.value = 'coverage.uvg.claimNumber') and answer.exists()) -&gt;  coverage.identifier as identifier,  identifier.type as typeid,  typeid.coding as coding,  coding.system = 'http://fhir.ch/ig/ch-orf/CodeSystem/ch-orf-cs-coverageidentifiertype',  coding.code = 'Claim',  identifier.value = (item.answer.value) &quot;claimNumber&quot;;
  } &quot;coverageuvg&quot;;
  // coverage.vvg	Zusatzversicherung (nach VVG)	0..1	group		Definition: Coverage.type
  src.item as item where where(linkId.value = 'coverage.vvg') -&gt;  bundle.entry as e4,  e4.resource = create('Coverage') as coverage,  coverage.id = uuid() as uuid4,  e4.fullUrl = ('urn:uuid:' + %uuid4),  serviceRequest.insurance as insurance,  insurance.reference = ('urn:uuid:' + %uuid4),  coverage.status = 'active',  coverage.beneficiary = create('Reference') as subject,  subject.reference = ('urn:uuid:' + %patient.id),  coverage.type as type,  type.coding as coding,  coding.system = 'http://fhir.ch/ig/ch-orf/CodeSystem/ch-orf-cs-coveragetype',  coding.code = 'Zusatz' then {
    item.item as item where ((linkId.value = 'coverage.vvg.name') and answer.exists()) -&gt;  coverage.payor as payor,  payor.reference as refcontained,  refcontained.value = '#org',  coverage.contained = create('Organization') as organization,  organization.id = 'org',  organization.name = (item.answer.value) &quot;name&quot;;
    item.item as item where ((linkId.value = 'coverage.vvg.insuranceCardNumber') and answer.exists()) -&gt;  coverage.identifier as identifier,  identifier.type as typeid,  typeid.coding as coding,  coding.system = 'http://fhir.ch/ig/ch-orf/CodeSystem/ch-orf-cs-coverageidentifiertype',  coding.code = 'VeKa',  identifier.value = (item.answer.value) &quot;insuranceCardNumber&quot;;
  } &quot;coveragevvg&quot;;
  // coverage.iv	Invalidenversicherung (IV)	0..1	group		Definition: Coverage.type
  src.item as item where where(linkId.value = 'coverage.iv') -&gt;  bundle.entry as e4,  e4.resource = create('Coverage') as coverage,  coverage.id = uuid() as uuid4,  e4.fullUrl = ('urn:uuid:' + %uuid4),  serviceRequest.insurance as insurance,  insurance.reference = ('urn:uuid:' + %uuid4),  coverage.status = 'active',  coverage.beneficiary = create('Reference') as subject,  subject.reference = ('urn:uuid:' + %patient.id),  coverage.type as type,  type.coding as coding,  coding.system = 'http://fhir.ch/ig/ch-orf/CodeSystem/ch-orf-cs-coveragetype',  coding.code = 'IVG' then {
    item.item as item where ((linkId.value = 'coverage.iv.verfuegungsnummer') and answer.exists()) -&gt;  coverage.identifier as identifier,  identifier.type as typeid,  typeid.coding as coding,  coding.system = 'http://fhir.ch/ig/ch-orf/CodeSystem/ch-orf-cs-coverageidentifiertype',  coding.code = 'IV',  identifier.value = (item.answer.value) &quot;verfuegungsnummer&quot;;
  } &quot;coverageiv&quot;;
  // coverage.mv	Militärversicherung (MV)	0..1	group		Definition: Coverage.type
  src.item as item where where(linkId.value = 'coverage.mv') -&gt;  bundle.entry as e4,  e4.resource = create('Coverage') as coverage,  coverage.id = uuid() as uuid4,  e4.fullUrl = ('urn:uuid:' + %uuid4),  serviceRequest.insurance as insurance,  insurance.reference = ('urn:uuid:' + %uuid4),  coverage.status = 'active',  coverage.beneficiary = create('Reference') as subject,  subject.reference = ('urn:uuid:' + %patient.id),  coverage.type as type,  type.coding as coding,  coding.system = 'http://fhir.ch/ig/ch-orf/CodeSystem/ch-orf-cs-coveragetype',  coding.code = 'MVG' then {
    item.item as item where ((linkId.value = 'coverage.mv.versichertennummer') and answer.exists()) -&gt;  coverage.identifier as identifier,  identifier.type as typeid,  typeid.coding as coding,  coding.system = 'http://fhir.ch/ig/ch-orf/CodeSystem/ch-orf-cs-coverageidentifiertype',  coding.code = 'MV',  identifier.value = (item.answer.value) &quot;versichertennummer&quot;;
  } &quot;coveragemv&quot;;
  // coverage.self	Selbstzahler	0..1	group		Definition: Coverage.type
  src.item as item where where(linkId.value = 'coverage.self') -&gt;  bundle.entry as e4,  e4.resource = create('Coverage') as coverage,  coverage.id = uuid() as uuid4,  e4.fullUrl = ('urn:uuid:' + %uuid4),  serviceRequest.insurance as insurance,  insurance.reference = ('urn:uuid:' + %uuid4),  coverage.status = 'active',  coverage.beneficiary = create('Reference') as subject,  subject.reference = ('urn:uuid:' + %patient.id),  coverage.type as type,  type.coding as coding,  coding.system = 'http://fhir.ch/ig/ch-orf/CodeSystem/ch-orf-cs-coveragetype',  coding.code = 'Self',  coverage.payor as payor,  payor.reference as refcontained,  refcontained.value = '#pat',  coverage.contained = create('Patient') as patient,  patient.id = 'pat' then {
    item.item as item where ((linkId.value = 'coverage.self.familyName') and answer.exists()) -&gt;  patient.name as name share selfname,  name.family = (item.answer.value) &quot;familyName&quot;;
    item.item as item where ((linkId.value = 'coverage.self.givenName') and answer.exists()) -&gt;  patient.name as name share selfname,  name.given = (item.answer.value) &quot;givenName&quot;;
  } &quot;coverageself&quot;;
  // coverage.other	Anderer Kostenträger	0..1	group		Definition: Coverage.type
  src.item as item where where(linkId.value = 'coverage.other') -&gt;  bundle.entry as e4,  e4.resource = create('Coverage') as coverage,  coverage.id = uuid() as uuid4,  e4.fullUrl = ('urn:uuid:' + %uuid4),  serviceRequest.insurance as insurance,  insurance.reference = ('urn:uuid:' + %uuid4),  coverage.status = 'active',  coverage.beneficiary = create('Reference') as subject,  subject.reference = ('urn:uuid:' + %patient.id),  coverage.type as type,  type.coding as coding,  coding.system = 'http://fhir.ch/ig/ch-orf/CodeSystem/ch-orf-cs-coveragetype',  coding.code = 'Zusatz' then {
    item.item as item where ((linkId.value = 'coverage.other.name') and answer.exists()) -&gt;  coverage.payor as payor,  payor.reference as refcontained,  refcontained.value = '#org',  coverage.contained = create('Organization') as organization,  organization.id = 'org',  organization.name = (item.answer.value) &quot;name&quot;;
    item.item as item where ((linkId.value = 'coverage.other.id') and answer.exists()) -&gt;  coverage.identifier as identifier,  identifier.value = (item.answer.value) &quot;id&quot;;
  } &quot;coveragevvg&quot;;
}

group SenderAuthorPractitionerItems(source src : BackboneElement, target practitioner : Practitioner) {
  src.item as item where ((linkId.value = 'sender.author.practitioner.familyName') and answer.exists()) -&gt;  practitioner.name as name share practitionerName,  name.family = (item.answer.value);
  src.item as item where ((linkId.value = 'sender.author.practitioner.givenName') and answer.exists()) -&gt;  practitioner.name as name share practitionerName,  name.given = (item.answer.value);
  src.item as item where ((linkId.value = 'sender.author.practitioner.title') and answer.exists()) -&gt;  practitioner.name as name share practitionerName,  name.prefix = (item.answer.value) as prefix,  prefix.extension as ext,  ext.url = 'http://hl7.org/fhir/StructureDefinition/iso21090-EN-qualifier',  ext.value = create('code') as value,  value.value = 'AC' &quot;title&quot;;
  src.item as item where ((linkId.value = 'sender.author.practitioner.gln') and answer.exists()) -&gt;  practitioner.identifier as value,  value.system = 'urn:oid:2.51.1.3',  value.value = (item.answer.value) &quot;gln&quot;;
  src.item as item where ((linkId.value = 'sender.author.practitioner.phone') and answer.exists()) -&gt;  practitioner.telecom as value,  value.system = 'phone',  value.value = (item.answer.value) &quot;phone&quot;;
  src.item as item where ((linkId.value = 'sender.author.practitioner.email') and answer.exists()) -&gt;  practitioner.telecom as value,  value.system = 'email',  value.value = (item.answer.value) &quot;email&quot;;
}

group SenderAuthorOrganizationItems(source src : BackboneElement, target organization : Organization) {
  src.item as item where ((linkId.value = 'sender.author.organization.name') and answer.exists()) -&gt; organization.name = (item.answer.value);
  src.item as item where ((linkId.value = 'sender.author.organization.streetAddressLine') and answer.exists()) -&gt; organization.address as address share orgAddress then {
    item.answer as answer -&gt; address.line = (answer.value) &quot;streetAddressLine&quot;;
  } &quot;answer&quot;;
  src.item as item where ((linkId.value = 'sender.author.organization.postalCode') and answer.exists()) -&gt;  organization.address as address share orgAddress,  address.postalCode = (item.answer.value) &quot;postalCode&quot;;
  src.item as item where ((linkId.value = 'sender.author.organization.city') and answer.exists()) -&gt;  organization.address as address share orgAddress,  address.city = (item.answer.value) &quot;city&quot;;
  src.item as item where ((linkId.value = 'sender.author.organization.country') and answer.exists()) -&gt;  organization.address as address share orgAddress,  address.country = (item.answer.value) &quot;country&quot;;
}

group SenderAuthorItems(source src : BackboneElement, target practitionerRole : practitionerRole, target practitioner : Practitioner, target organization : Organization) {
  src.item as item where (linkId.value = 'sender.author.practitioner') then SenderAuthorPractitionerItems(item, practitioner);
  src.item as item where (linkId.value = 'sender.author.organization') then SenderAuthorOrganizationItems(item, organization);
}

group SenderDataEntererPractitionerItems(source src : BackboneElement, target practitioner : Practitioner) {
  src.item as item where ((linkId.value = 'sender.dataenterer.practitioner.familyName') and answer.exists()) -&gt;  practitioner.name as name share practitionerName,  name.family = (item.answer.value);
  src.item as item where ((linkId.value = 'sender.dataenterer.practitioner.givenName') and answer.exists()) -&gt;  practitioner.name as name share practitionerName,  name.given = (item.answer.value);
  src.item as item where ((linkId.value = 'sender.dataenterer.practitioner.phone') and answer.exists()) -&gt;  practitioner.telecom as value,  value.system = 'phone',  value.value = (item.answer.value) &quot;phone&quot;;
  src.item as item where ((linkId.value = 'sender.dataenterer.practitioner.email') and answer.exists()) -&gt;  practitioner.telecom as value,  value.system = 'email',  value.value = (item.answer.value) &quot;email&quot;;
}

group SenderDataEntererItems(source src : BackboneElement, target practitionerRole : practitionerRole, target practitioner : Practitioner, target organization : Organization) {
  src.item as item where (linkId.value = 'sender.dataenterer.practitioner') then SenderDataEntererPractitionerItems(item, practitioner);
}

group ChExtEprDataEnterer(source src : BackboneElement, target practitionerRole : PractitionerRole, target ext : Extension) {
  src -&gt; ext.url = 'http://fhir.ch/ig/ch-core/StructureDefinition/ch-ext-epr-dataenterer' &quot;url&quot;;
  src -&gt;  ext.extension as ext,  ext.url = 'enterer',  ext.value = create('Reference') as reference,  reference.reference = ('urn:uuid:' + %practitionerRole.id) &quot;practitionerRole&quot;;
}

group SenderAuthorInit(source src : BackboneElement, target bundle : Bundle, target composition : Composition, target serviceRequest : ServiceRequest) {
  src -&gt;  bundle.entry as e,  e.resource = create('PractitionerRole') as practitionerRole,  practitionerRole.id = uuid() as uuid,  e.fullUrl = append('urn:uuid:', uuid),  bundle.entry as e2,  e2.resource = create('Practitioner') as practitioner,  practitioner.id = uuid() as uuid2,  e2.fullUrl = append('urn:uuid:', uuid2),  bundle.entry as e3,  e3.resource = create('Organization') as organization,  organization.id = uuid() as uuid3,  e3.fullUrl = append('urn:uuid:', uuid3),  composition.author = create('Reference') as reference,  reference.reference = append('urn:uuid:', uuid),  serviceRequest.requester = create('Reference') as reference,  reference.reference = append('urn:uuid:', uuid),  practitionerRole.practitioner = create('Reference') as reference,  reference.reference = append('urn:uuid:', uuid2),  practitionerRole.organization = create('Reference') as reference,  reference.reference = append('urn:uuid:', uuid3) then {
    src.item as item where (linkId.value = 'sender.author') then SenderAuthorItems(item, practitionerRole, practitioner, organization) &quot;author&quot;;
    src.item as item where (linkId.value = 'sender.dataenterer') then {
      item -&gt;  bundle.entry as e4,  e4.resource = create('PractitionerRole') as practitionerRoleDataEnterer,  practitionerRoleDataEnterer.id = uuid() as uuid4,  e4.fullUrl = append('urn:uuid:', uuid4),  composition.extension as extension,  bundle.entry as e5,  e5.resource = create('Practitioner') as practitionerDataEnterer,  practitionerDataEnterer.id = uuid() as uuid5,  e5.fullUrl = append('urn:uuid:', uuid5),  practitionerRoleDataEnterer.practitioner = create('Reference') as reference,  reference.reference = append('urn:uuid:', uuid5),  practitionerRoleDataEnterer.organization = create('Reference') as reference,  reference.reference = append('urn:uuid:', uuid3) then {
        item then SenderDataEntererItems(item, practitionerRoleDataEnterer, practitionerDataEnterer, organization) &quot;data&quot;;
        item then ChExtEprDataEnterer(item, practitionerRoleDataEnterer, extension) &quot;extension&quot;;
      } &quot;items&quot;;
    } &quot;dataenterer&quot;;
  } &quot;sender&quot;;
}

group CopyReceiverPatientItems(source src : BackboneElement, target patient : Patient) {
  src.item as item where ((linkId.value = 'receiverCopy.familyName') and answer.exists()) -&gt;  patient.name as name share name,  name.family = (item.answer.value);
  src.item as item where ((linkId.value = 'receiverCopy.givenName') and answer.exists()) -&gt;  patient.name as name share name,  name.given = (item.answer.value);
  src.item as item where ((linkId.value = 'receiverCopy.title') and answer.exists()) -&gt;  patient.name as name share name,  name.prefix = (item.answer.value) as prefix,  prefix.extension as ext,  ext.url = 'http://hl7.org/fhir/StructureDefinition/iso21090-EN-qualifier',  ext.value = create('code') as value,  value.value = 'AC' &quot;title&quot;;
  src.item as item where ((linkId.value = 'receiverCopy.phone') and answer.exists()) -&gt;  patient.telecom as value,  value.system = 'phone',  value.value = (item.answer.value) &quot;phone&quot;;
  src.item as item where ((linkId.value = 'receiverCopy.email') and answer.exists()) -&gt;  patient.telecom as value,  value.system = 'email',  value.value = (item.answer.value) &quot;email&quot;;
  src.item as item where ((linkId.value = 'receiverCopy.streetAddressLine') and answer.exists()) -&gt; patient.address as address share orgAddress then {
    item.answer as answer -&gt; address.line = (answer.value) &quot;streetAddressLine&quot;;
  } &quot;answer&quot;;
  src.item as item where ((linkId.value = 'receiverCopy.postalCode') and answer.exists()) -&gt;  patient.address as address share orgAddress,  address.postalCode = (item.answer.value) &quot;postalCode&quot;;
  src.item as item where ((linkId.value = 'receiverCopy.city') and answer.exists()) -&gt;  patient.address as address share orgAddress,  address.city = (item.answer.value) &quot;city&quot;;
  src.item as item where ((linkId.value = 'receiverCopy.country') and answer.exists()) -&gt;  patient.address as address share orgAddress,  address.country = (item.answer.value) &quot;country&quot;;
}

group ExtOrfCopyReceiverPatient(source src : BackboneElement, target patient : Patient, target ext : Extension) {
  src -&gt; ext.url = 'http://fhir.ch/ig/ch-orf/StructureDefinition/ch-orf-copyreceiver' &quot;url&quot;;
  src -&gt;  ext.value = create('Reference') as reference,  reference.reference = ('urn:uuid:' + %patient.id) &quot;patient&quot;;
}

group CopyReceiverOrganizationItems(source src : BackboneElement, target organization : Organization) {
  src.item as item where ((linkId.value = 'receiverCopy.organization.name') and answer.exists()) -&gt; organization.name = (item.answer.value);
  src.item as item where ((linkId.value = 'receiverCopy.familyName') and answer.exists()) -&gt;  organization.contact as contact share contact,  contact.name as name share name,  name.family = (item.answer.value);
  src.item as item where ((linkId.value = 'receiverCopy.givenName') and answer.exists()) -&gt;  organization.contact as contact share contact,  contact.name as name share name,  name.given = (item.answer.value);
  src.item as item where ((linkId.value = 'receiverCopy.title') and answer.exists()) -&gt;  organization.contact as contact share contact,  contact.name as name share name,  name.prefix = (item.answer.value) as prefix,  prefix.extension as ext,  ext.url = 'http://hl7.org/fhir/StructureDefinition/iso21090-EN-qualifier',  ext.value = create('code') as value,  value.value = 'AC' &quot;title&quot;;
  src.item as item where ((linkId.value = 'receiverCopy.phone') and answer.exists()) -&gt;  organization.telecom as value,  value.system = 'phone',  value.value = (item.answer.value) &quot;phone&quot;;
  src.item as item where ((linkId.value = 'receiverCopy.email') and answer.exists()) -&gt;  organization.telecom as value,  value.system = 'email',  value.value = (item.answer.value) &quot;email&quot;;
  src.item as item where ((linkId.value = 'receiverCopy.streetAddressLine') and answer.exists()) -&gt; organization.address as address share orgAddress then {
    item.answer as answer -&gt; address.line = (answer.value) &quot;streetAddressLine&quot;;
  } &quot;answer&quot;;
  src.item as item where ((linkId.value = 'receiverCopy.postalCode') and answer.exists()) -&gt;  organization.address as address share orgAddress,  address.postalCode = (item.answer.value) &quot;postalCode&quot;;
  src.item as item where ((linkId.value = 'receiverCopy.city') and answer.exists()) -&gt;  organization.address as address share orgAddress,  address.city = (item.answer.value) &quot;city&quot;;
  src.item as item where ((linkId.value = 'receiverCopy.country') and answer.exists()) -&gt;  organization.address as address share orgAddress,  address.country = (item.answer.value) &quot;country&quot;;
}

group ExtOrfCopyReceiverOrganization(source src : BackboneElement, target organization : Organization, target ext : Extension) {
  src -&gt; ext.url = 'http://fhir.ch/ig/ch-orf/StructureDefinition/ch-orf-copyreceiver' &quot;url&quot;;
  src -&gt;  ext.value = create('Reference') as reference,  reference.reference = ('urn:uuid:' + %organization.id) &quot;organization&quot;;
}

group ReceiverCopy(source grp : BackboneElement, target bundle : Bundle, target composition : Composition, target serviceRequest : ServiceRequest) {
  grp.item as item where ((linkId = 'receiverCopy') and item.where(linkId = 'receiverCopy.organization.name').answer.exists()) -&gt;  bundle.entry as e4,  e4.resource = create('Organization') as organization,  composition.extension as extension,  organization.id = uuid() as uuid4,  e4.fullUrl = append('urn:uuid:', uuid4) then {
    item then CopyReceiverOrganizationItems(item, organization) &quot;data&quot;;
    item then ExtOrfCopyReceiverOrganization(item, organization, extension) &quot;extension&quot;;
  } &quot;receiverCopyOrganization&quot;;
  grp.item as item where ((linkId = 'receiverCopy') and item.where(linkId = 'receiverCopy.organization.name').answer.exists().not()) -&gt;  bundle.entry as e4,  e4.resource = create('Patient') as patient,  composition.extension as extension,  patient.id = uuid() as uuid4,  e4.fullUrl = append('urn:uuid:', uuid4) then {
    item then CopyReceiverPatientItems(item, patient) &quot;data&quot;;
    item then ExtOrfCopyReceiverPatient(item, patient, extension) &quot;extension&quot;;
  } &quot;receiverCopyPatient&quot;;
}

group Appointment(source grp : BackboneElement, target bundle : Bundle, target composition : Composition, target serviceRequest : ServiceRequest) {
  src -&gt;  bundle.entry as e4,  e4.resource = create('Appointment') as appointment,  appointment.id = uuid() as uuid4,  e4.fullUrl = ('urn:uuid:' + %uuid4),  serviceRequest.extension as extension,  appointment.subject = create('Reference') as subject,  subject.reference = ('urn:uuid:' + %patient.id),  extension.url = 'http://fhir.ch/ig/ch-orf/StructureDefinition/ch-orf-locationandtime',  extension.value = create('Reference') as reference,  reference.reference = ('urn:uuid:' + %uuid4) then {
    grp.item as item where ((linkId.value = 'appointment.status') and answer.exists()) -&gt; appointment.status = (item.answer.value) &quot;status&quot;;
    grp.item as item where (linkId.value = 'appointment.requestedPeriod') then {
      item.item as item2 where ((linkId.value = 'appointment.requestedPeriod.start') and answer.exists()) -&gt;  appointment.requestedPeriod as requestedPeriod share requestedPeriod,  requestedPeriod.start = (item2.answer.value) &quot;start&quot;;
      item.item as item2 where ((linkId.value = 'appointment.requestedPeriod.end') and answer.exists()) -&gt;  appointment.requestedPeriod as requestedPeriod share requestedPeriod,  requestedPeriod.end = (item2.answer.value) &quot;end&quot;;
    } &quot;requestedPeriod&quot;;
    grp.item as item where ((linkId.value = 'appointment.patientInstruction') and answer.exists()) -&gt; appointment.patientInstruction = (item.answer.value) &quot;patientInstruction&quot;;
    grp.item as item where (linkId.value = 'appointment.location') then {
      item -&gt;  bundle.entry as e5,  e5.resource = create('Location') as location,  location.id = uuid() as uuid5,  e5.fullUrl = ('urn:uuid:' + %uuid5),  appointment.participant as participant,  participant.status = 'tentative',  participant.actor = create('Reference') as actor,  actor.reference = ('urn:uuid:' + %location.id) then {
        item.item as item3 where ((linkId.value = 'appointment.location.name') and answer.exists()) -&gt; location.name = (item3.answer.value);
        item.item as item3 where ((linkId.value = 'appointment.location.phone') and answer.exists()) -&gt;  location.telecom as value,  value.system = 'phone',  value.value = (item3.answer.value) &quot;phone&quot;;
        item.item as item3 where ((linkId.value = 'appointment.location.email') and answer.exists()) -&gt;  location.telecom as value,  value.system = 'email',  value.value = (item3.answer.value) &quot;email&quot;;
        item.item as item3 where ((linkId.value = 'appointment.location.streetAddressLine') and answer.exists()) -&gt;  location.address as address share orgAddress,  address.line = (item3.answer.value) &quot;streetAddressLine&quot;;
        item.item as item3 where ((linkId.value = 'appointment.location.postalCode') and answer.exists()) -&gt;  location.address as address share orgAddress,  address.postalCode = (item3.answer.value) &quot;postalCode&quot;;
        item.item as item3 where ((linkId.value = 'appointment.location.city') and answer.exists()) -&gt;  location.address as address share orgAddress,  address.city = (item3.answer.value) &quot;city&quot;;
        item.item as item3 where ((linkId.value = 'appointment.location.country') and answer.exists()) -&gt;  location.address as address share orgAddress,  address.country = (item3.answer.value) &quot;country&quot;;
      } &quot;location&quot;;
    } &quot;location&quot;;
  } &quot;Appointment&quot;;
}

group Note(source grp : BackboneElement, target serviceRequest : ServiceRequest) {
  grp.item as item where ((linkId = 'note.text') and answer.exists()) -&gt;  serviceRequest.note as note,  note.text = (item.answer.value) &quot;text&quot;;
}

group QrToBundle(source qr : QuestionnaireResponse, target q : Questionnaire, target patient : Patient, target questionnaireresp : QuestionnaireResponse, target servicerequest : ServiceRequest, target composition : Composition, target bundle : Bundle) {
  qr -&gt; bundle.id = uuid() &quot;id&quot;;
  qr -&gt; bundle.type = 'document' &quot;type&quot;;
  qr then OrfComposition(qr, q, composition, patient, questionnaireresp, servicerequest, bundle) &quot;composition&quot;;
  qr then QrToGroups(qr, patient, bundle, composition, servicerequest) &quot;qrgroups&quot;;
}

group OrfComposition(source qr : QuestionnaireResponse, target q : Questionnaire, target tgt : Composition, target patient : Patient, target questionnaireresp : QuestionnaireResponse, target servicerequest : ServiceRequest, target bundle : Bundle) {
  qr -&gt; tgt.status = 'final' &quot;status&quot;;
  qr -&gt;  tgt.subject = create('Reference') as reference,  reference.reference = ('urn:uuid:' + %patient.id) &quot;subject&quot;;
  qr -&gt;  tgt.section as tgtSection,  tgtSection.title = 'Order-Referral',  tgtSection.code as code,  code.coding as coding,  coding.system = 'http://loinc.org',  coding.code = '93037-0',  coding.display = 'Portable medical order form',  tgtSection.entry = create('Reference') as reference,  reference.reference = ('urn:uuid:' + %questionnaireresp.id),  tgtSection.entry = create('Reference') as reference,  reference.reference = ('urn:uuid:' + %servicerequest.id),  tgtSection.entry = create('Reference') as reference,  reference.reference = ('urn:uuid:' + %q.id) &quot;sections&quot;;
  qr -&gt;  servicerequest.status = 'active',  servicerequest.intent = 'order',  servicerequest.subject = create('Reference') as reference,  reference.reference = ('urn:uuid:' + %patient.id) &quot;servicerequest&quot;;
}

</pre>
      </div>

  <!-- insert notes if present -->
  



</div>
        </div>  <!-- /inner-wrapper -->
      </div>  <!-- /row -->
    </div>  <!-- /container -->
  </div>  <!-- /segment-content -->

  <script type="text/javascript" src="assets/js/jquery.js"> </script>     <!-- note keep space here, otherwise it will be transformed to empty tag -> fails -->
  <script type="text/javascript" src="assets/js/jquery-ui.min.js"> </script>

  <script type="text/javascript">
    $(document).ready(function(){
      if(window.location.hash != "") {
          $('a[href="' + window.location.hash + '"]').click()
      }
    });
  </script>
  <a name="bottom"> </a>
  <div id="segment-footer" igtool="footer" class="segment">  <!-- segment-footer -->
    <div class="container">  <!-- container -->

      <div class="inner-wrapper">
        <p>
          IG &#169; 2020+ <a style="color:var(--footer-hyperlink-text-color)" href="https://www.hl7.ch/">HL7 Switzerland</a>.  Package ch.fhir.ig.ch-orf#0.10.0 based on <a style="color: var(--footer-hyperlink-text-color)" href="http://hl7.org/fhir/R4/">FHIR 4.0.1</a>. Generated <span title="Tue, Jun 15, 2021 14:23+0200">2021-06-15</span>
          <br/>
          <span style="color: var(--footer-highlight-text-color)"></span>
                      Links: <a style="color: var(--footer-hyperlink-text-color)" href="toc.html">Table of Contents</a> |
                 <a style="color: var(--footer-hyperlink-text-color)" href="qa.html">QA Report</a>
                 
                

| <a style="color: #81BEF7" target="_blank" href="https://docs.google.com/forms/d/e/1FAIpQLSeT-tq5cutjuiVEedqihlMZ56_4UJsdVH6aTGYHTmO34T1Z4g/viewform?usp=sf_link&amp;entry%2E1353807103=ch.fhir.ig.ch-orf%230.10.0%20/StructureMap-OrfQrToBundle.html&amp;entry%2E247644557=Map%20ORF">Propose a change</a>

          </span>
        </p>
      </div>  <!-- /inner-wrapper -->
    </div>  <!-- /container -->
  </div>  <!-- /segment-footer -->
  
  <div id="segment-post-footer" class="segment hidden">  <!-- segment-post-footer -->
    <div class="container">  <!-- container -->
    </div>  <!-- /container -->
  </div>  <!-- /segment-post-footer -->
  
  <!-- JS and analytics only. -->
  <!-- Bootstrap core JavaScript
  ================================================== -->
  <!-- Placed at the end of the document so the pages load faster -->
  <script type="text/javascript" src="assets/js/bootstrap.min.js"> </script>
  <script type="text/javascript" src="assets/js/respond.min.js"> </script>
  <script type="text/javascript" src="assets/js/anchor.min.js"> </script>
  <script>anchors.options.visible = 'hover'
anchors.add()</script>
  
<!-- feedback form - Google forms -->
<!-- v0.1, 2021-01-09 -->


  


  



<!-- / feedback form  -->

  <!-- Analytics Below
  ================================================== -->
  </body>
</html>

