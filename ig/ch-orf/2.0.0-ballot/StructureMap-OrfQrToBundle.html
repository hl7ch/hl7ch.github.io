<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE HTML>
<html xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type"/>
    <title>CH.FHIR.IG.CH-ORF\Map ORF - FHIR v4.0.1</title>

    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta name="author" content="http://hl7.org/fhir"/>

    <link href="fhir.css" rel="stylesheet"/>

    <!-- Bootstrap core CSS -->
    <link href="assets/css/bootstrap-fhir.css" rel="stylesheet"/>

    <!-- Project extras -->
    <link href="assets/css/project.css" rel="stylesheet"/>
    <link href="assets/css/pygments-manni.css" rel="stylesheet"/>
    <link href="assets/css/jquery-ui.css" rel="stylesheet"/>
  	<link href="assets/css/prism.css" rel="stylesheet" />
    <!-- Placeholder for child template CSS declarations -->
    <link href="assets/css/hl7.css" rel="stylesheet"/>
    <link href="assets/css/fhir.css" rel="stylesheet"/>

    <script type="text/javascript" src="fhir-table-scripts.js"> </script>

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="assets/js/html5shiv.js"></script>
    <script src="assets/js/respond.min.js"></script>
    <![endif]-->

    <!-- Favicons -->
    <link rel="fhir-logo" sizes="144x144" href="assets/ico/icon-fhir-144.png"/>
    <link rel="fhir-logo" sizes="114x114" href="assets/ico/icon-fhir-114.png"/>
    <link rel="fhir-logo" sizes="72x72" href="assets/ico/icon-fhir-72.png"/>
    <link rel="fhir-logo" href="assets/ico/icon-fhir-57.png"/>
    <link rel="shortcut icon" href="assets/ico/favicon.png"/>
  </head>
  <body onload="document.body.style.opacity='1'">

	  <script src="assets/js/prism.js"></script>

    <style type="text/css">h2{--heading-prefix:"14.53"}
    h3,h4,h5,h6{--heading-prefix:"14.53"}</style>
    <div id="segment-header" class="segment">  <!-- segment-header -->
      <div class="container">  <!-- container -->
        <!-- Placeholder for child template header declarations -->

            <div id="family-nav">
	<a id="logo" no-external="true" href="http://hl7.org/fhir"> <img
		alt="logo fhir" src="fhir-logo-www.png" />
	</a>
</div>

            <div id="hl7-nav">
    <a id="hl7-logo" no-external="true" href="http://www.hl7.ch">
        <img alt="visit the hl7 website" height="50" src="hl7-logo.png" />
    </a>            
</div>

        <div id="ig-status">
          <p><span style="font-size:12pt;font-weight:bold">CH ORF (R4)</span>
            <br/>
            <span style="display:inline-block;">2.0.0-ballot - ballot



  <img alt="Switzerland flag" src="assets/images/che.svg" height="16" title="Switzerland"/>


            </span>
          </p>
        </div>
      </div> <!-- /container -->
    </div>  <!-- /segment-header -->

    <div id="segment-navbar" class="segment">  <!-- segment-navbar -->
      <div id="stripe"> </div>
      <div class="container">  <!-- container -->
        <!-- HEADER CONTENT -->

        <nav class="navbar navbar-inverse">
          <!--status-bar-->
          <div class="container">
            <button data-target=".navbar-inverse-collapse" class="navbar-toggle" data-toggle="collapse" type="button">
              <span class="icon-bar"> </span>
              <span class="icon-bar"> </span>
              <span class="icon-bar"> </span>
            </button>
            <a class="navbar-brand hidden" href="http://hl7.org/fhir/R4/index.html">FHIR</a>
            <div class="nav-collapse collapse navbar-inverse-collapse">
              <ul xmlns="http://www.w3.org/1999/xhtml" class="nav navbar-nav">
  <!--<li>
    <a href="toc.html">Table of Contents</a>
  </li>-->
  <li>
    <a href="index.html">Home</a>
  </li>
  <li class="dropdown">
    <a data-toggle="dropdown" href="#" class="dropdown-toggle">Use Cases<b class="caret">
      </b>
    </a>
    <ul class="dropdown-menu">
      <li>
        <a href="usecase-english.html">English</a>
      </li>
      <li>
        <a href="usecase-german.html">German</a>
      </li>
      <li>
        <a href="usecase-french.html">French</a>
      </li>
    </ul>
  </li>
  <li class="dropdown">
    <a data-toggle="dropdown" href="#" class="dropdown-toggle">Questionnaire<b class="caret">
      </b>
    </a>
    <ul class="dropdown-menu">
      <li>
        <a href="Questionnaire-order-referral-form.html">Specification</a>
      </li>
      <li>
        <a href="questionnaire-form.html">Form</a>
      </li>
      <li>
        <a href="modular-form.html">Modular Form</a>
      </li>
      <li>
        <a href="form-population.html">Form Population</a>
      </li>
      <li>
        <a href="form-data-extraction.html">Form Data Extraction</a>
      </li>
    </ul>
  </li>
  <li>
    <a href="document.html">Document</a>
  </li>
  <li>
    <a href="profiles.html">Profiles</a>
  </li>
  <li>
    <a href="extensions.html">Extensions</a>
  </li>
  <li>
    <a href="terminology.html">Terminology</a>
  </li>
  <li>
    <a href="artifacts.html">Artifacts</a>
  </li>
</ul>
            </div>  <!-- /.nav-collapse -->
          </div>  <!-- /.container -->
        </nav>  <!-- /.navbar -->
      <!-- /HEADER CONTENT -->
      </div>  <!-- /container -->
    </div>  <!-- /segment-navbar -->
    <!--status-bar-->

    <div id="segment-breadcrumb" class="segment">  <!-- segment-breadcrumb -->
      <div class="container">  <!-- container -->
        <ul class="breadcrumb">
          <li><a href='toc.html'><b>Table of Contents</b></a></li><li><a href='artifacts.html'><b>Artifacts Summary</b></a></li><li><b>Map ORF</b></li>

        </ul>
      </div>  <!-- /container -->
    </div>  <!-- /segment-breadcrumb -->

    <a name="top"> </a>
    <div id="segment-content" class="segment">  <!-- segment-content -->
      <div class="container">  <!-- container -->
        <div class="row">
          <div class="inner-wrapper">

<div class="col-12">
  <!--ReleaseHeader--><p id="publish-box">This page is part of the CH ORF (R4) (v2.0.0-ballot: <a data-no-external="true" href="https://confluence.hl7.org/display/HL7/HL7+Balloting" title="Standard for Trial-Use">STU</a> 2) based on <a data-no-external="true" href="http://hl7.org/fhir/R4">FHIR (HL7® FHIR® Standard) R4</a>. The current version which supersedes this version is <a data-no-external="true" href="http://fhir.ch/ig/ch-orf">3.0.1</a>.  For a full list of available versions, see the <a data-no-external="true" href="http://fhir.ch/ig/ch-orf/history.html">Directory of published versions</a></p><!--EndReleaseHeader-->
  








<ul class="nav nav-tabs">

  <li class="active">
    <a href="#">Narrative Content</a>
  </li>



  
    <li>
      <a href="StructureMap-OrfQrToBundle.xml.html">XML</a>
    </li>
  


  
    <li>
      <a href="StructureMap-OrfQrToBundle.json.html">JSON</a>
    </li>
  


  
    <li>
      <a href="StructureMap-OrfQrToBundle.ttl.html">TTL</a>
    </li>
  



</ul>

  <a name="root"> </a>

  <h2 id="root">StructureMap: Map ORF

  </h2>

  <table class="colsd">

    <tr>
      <td colspan="4"><i>Official URL</i>: <span class="copy-text">http://fhir.ch/ig/ch-orf/StructureMap/OrfQrToBundle<button title="Click to copy URL" class="btn-copy" data-clipboard-text="http://fhir.ch/ig/ch-orf/StructureMap/OrfQrToBundle"/></span>
      </td>
      <td><i>Version</i>:
      <span class="copy-text">2.0.0-ballot<button title="Click to copy versioned URL" class="btn-copy" data-clipboard-text="http://fhir.ch/ig/ch-orf/StructureMap/OrfQrToBundle|2.0.0-ballot"/></span>
      </td>
    </tr>

    <tr>







      <td colspan="4">
        
          Draft
          
            as of 2023-06-29
          
        
      </td>



      <td><i>Computable Name</i>: <span style="font-family: monospace;">OrfQrToBundle</span></td>
    </tr>




    <tr>
      <td colspan="5"><p><em>Copyright/Legal</em>: CC0-1.0</p>
</td>
    </tr>

  </table>



  <!-- insert intro if present -->
  



<!--  <p>
  Formats: <a href="StructureMap-OrfQrToBundle.xml.html">XML</a>, <a href="StructureMap-OrfQrToBundle.json.html">JSON</a>, <a href="StructureMap-OrfQrToBundle.ttl.html">Turtle</a>
  </p>-->

  


  <div xmlns="http://www.w3.org/1999/xhtml">
      <pre>map &quot;http://fhir.ch/ig/ch-orf/StructureMap/OrfQrToBundle&quot; = &quot;OrfQrToBundle&quot;

//
// ORF QuestionnaireResponse to Bundle
// 2021-01-11 Oliver Egger, copyright ahdis ag, Apache License 
// QRF Questionnaire: http://fhir.ch/ig/ch-orf/Questionnaire-order-referral-form.html
// QRF QuestionnaireResponse: http://fhir.ch/ig/ch-orf/QuestionnaireResponse-order-referral-form.xml.html
// Bundle: http://fhir.ch/ig/ch-orf/StructureDefinition-ch-orf-document.html

uses &quot;http://hl7.org/fhir/StructureDefinition/QuestionnaireResponse&quot; alias QuestionnaireResponse as source
uses &quot;http://hl7.org/fhir/StructureDefinition/BackboneElement&quot; alias BackboneElement as source
uses &quot;http://hl7.org/fhir/StructureDefinition/Bundle&quot; alias Bundle as target
uses &quot;http://hl7.org/fhir/StructureDefinition/Composition&quot; alias Composition as target
uses &quot;http://hl7.org/fhir/StructureDefinition/Patient&quot; alias Patient as target
uses &quot;http://hl7.org/fhir/StructureDefinition/RelatedPerson&quot; alias RelatedPerson as target
uses &quot;http://hl7.org/fhir/StructureDefinition/Organization&quot; alias Organization as target
uses &quot;http://hl7.org/fhir/StructureDefinition/Practitioner&quot; alias Practitioner as target
uses &quot;http://hl7.org/fhir/StructureDefinition/PractitionerRole&quot; alias PractitionerRole as target
uses &quot;http://hl7.org/fhir/StructureDefinition/ServiceRequest&quot; alias ServiceRequest as target
uses &quot;http://hl7.org/fhir/StructureDefinition/Extension&quot; alias Extension as target
uses &quot;http://hl7.org/fhir/StructureDefinition/EpisodeOfCare&quot; alias EpisodeOfCare as target
uses &quot;http://hl7.org/fhir/StructureDefinition/QuestionnaireResponse&quot; alias QuestionnaireResponseTarget as target

group OrfQrToBundle(source qr : QuestionnaireResponse, target bundle : Bundle ) {
      qr -&gt; bundle.identifier as documentIdentifier, documentIdentifier.system = 'urn:ietf:rfc:3986',  uuid() as uuidDoc, documentIdentifier.value = append('urn:uuid:', uuidDoc) &quot;documentIdentifier&quot;;
      qr as qrcp -&gt; bundle.entry as e, 
             e.resource = create('Composition') as composition, 
             composition.id = uuid() as uuid,
             e.fullUrl = append('urn:uuid:',uuid),
             bundle.entry as e2, 
             bundle.timestamp = (now()) as timestamp,
             composition.date = timestamp,
             composition.title = 'Order and Referral by Form',
             composition.type as type, type.coding as coding, coding.code = '419891008', coding.system = 'http://snomed.info/sct',
             composition.category as category, category.coding as coding, coding.code = '721963009', coding.system = 'http://snomed.info/sct',
             e2.resource = create('Patient') as patient,
             patient.id = uuid() as uuid2,
             e2.fullUrl = append('urn:uuid:',uuid2),
             bundle.entry as e4, 
             e4.resource = qrcp as questionnaireresp,
             questionnaireresp.id = uuid() as uuid4,
             e4.fullUrl = append('urn:uuid:',uuid4),
             bundle.entry as e5, 
             e5.resource = create('ServiceRequest') as servicerequest, 
             servicerequest.id = uuid() as uuid5,
             e5.fullUrl = append('urn:uuid:',uuid5) then {
               qr.questionnaire as can -&gt; bundle.entry as e6, e6.resource = (can.resolve()) as q, q.id = uuid() as uuid6, e6.fullUrl = append('urn:uuid:',uuid6) then QrToBundle(qr, q, patient, questionnaireresp, servicerequest, composition, bundle) &quot;orfbundle&quot;;
             } &quot;orfbundle&quot;;
}

group QrToGroups(source qr : QuestionnaireResponse, target patient : Patient, target bundle: Bundle, target composition : Composition, target serviceRequest: ServiceRequest) {
    qr.item as grp where linkId='order' then OrderItems(grp, bundle, composition, serviceRequest) &quot;grporder&quot;;
    qr.item as grp where linkId='receiver' then ReceiverInit(grp, bundle, composition, serviceRequest) &quot;receiver&quot;;
    qr.item as grp where linkId='initiator' then InitiatorInit(grp, bundle, patient, composition, serviceRequest) &quot;grpinitiator&quot;;
    qr.item as grp where linkId='patient' then PatientItems(grp, bundle, patient, composition, serviceRequest) &quot;grppatient&quot;;
    qr.item as grp where linkId='requestedEncounter' then RequestedEncounterItems(grp, bundle, patient, serviceRequest) &quot;grprequestedencounter&quot;;
    qr.item as grp where linkId='coverage' then Coverage(grp, bundle, patient, serviceRequest) &quot;grprequestedencounter&quot;;
    qr.item as grp where linkId='sender' then SenderAuthorInit(grp, bundle, composition, serviceRequest) &quot;grpsender&quot;;
    qr.item as grp where linkId='receiverCopy' then ReceiverCopy(grp, bundle, patient, composition, serviceRequest) &quot;receiverCopy&quot;;
    qr.item as grp where linkId='appointment' then Appointment(grp, bundle, composition, serviceRequest) &quot;appointment&quot;;
    qr.item as grp where linkId='previousResults' then PreviousResults(grp, bundle, serviceRequest) &quot;previousResults&quot;;
    qr.item as grp where linkId='antecedentEpisodeOfCare' then AntecedentEpisodeOfCareInit(grp, bundle, patient, composition) &quot;AntecedentEpisodeOfCareInit&quot;;
    qr.item as grp where linkId='consent' then Consent(grp, bundle, composition) &quot;consent&quot;;
    qr.item as grp where linkId='note' then Note(grp, serviceRequest) &quot;note&quot;;
}

group OrderItems(source src : BackboneElement, target bundle: Bundle, target composition, target serviceRequest : ServiceRequest) {

  src.item as item where (linkId.value = 'order.precedentDocumentIdentifier' and answer.exists())   -&gt; composition.extension as ext, ext.url = 'http://fhir.ch/ig/ch-orf/StructureDefinition/ch-orf-precedentdocument',
                                                                        ext.value = create('Identifier') as value, value.system='urn:ietf:rfc:3986', value.value=('urn:uuid:'+item.answer.valueString) &quot;order.precedentDocumentIdentifier&quot;; 

  src.item as item where (linkId.value = 'order.placerOrderIdentifier' and answer.exists()) -&gt; serviceRequest.identifier as value share placer, 
                                                                                   value.type as type, type.coding as coding,
                                                                                   coding.system = 'http://terminology.hl7.org/CodeSystem/v2-0203',
                                                                                   coding.code = 'PLAC',
                                                                                   value.value=(item.answer.valueString) &quot;order.placerOrderIdentifier&quot;; 
  src.item as item where (linkId.value = 'order.placerOrderIdentifierDomain' and answer.exists()) -&gt; serviceRequest.identifier as value share placer, 
                                                                                   value.system=(item.answer.valueString) &quot;order.placerOrderIdentifierDomain&quot;; 
  src.item as item where (linkId.value = 'order.fillerOrderIdentifier' and answer.exists()) -&gt; serviceRequest.identifier as value share filler, 
                                                                                   value.type as type, type.coding as coding,
                                                                                   coding.system = 'http://terminology.hl7.org/CodeSystem/v2-0203',
                                                                                   coding.code = 'FILL',
                                                                                   value.value=(item.answer.valueString) &quot;order.fillerOrderIdentifier&quot;; 
  src.item as item where (linkId.value = 'order.fillerOrderIdentifierDomain' and answer.exists()) -&gt; serviceRequest.identifier as value share filler, 
                                                                                   value.system=(item.answer.valueString) &quot;order.fillerOrderIdentifierDomain&quot;; 

  src.item as item where (linkId.value = 'order.dateTime' and answer.exists()) -&gt; serviceRequest.authoredOn = (item.answer.value);

  src.item as item where (linkId.value = 'order.priority' and answer.exists()) -&gt; serviceRequest.priority = (item.answer.value.code);

  src.item as item where (linkId.value = 'order.notificationContactDocument') then {
      item -&gt; bundle.entry as e4, 
               e4.resource = create('PractitionerRole') as practitionerRoleDataEnterer, 
               practitionerRoleDataEnterer.id = uuid() as uuid4,
               e4.fullUrl = append('urn:uuid:',uuid4),
               composition.extension as extension,
               bundle.entry as e5, 
               e5.resource = create('Practitioner') as practitionerDataEnterer, 
               practitionerDataEnterer.id = uuid() as uuid5,
               e5.fullUrl = append('urn:uuid:',uuid5),
               practitionerRoleDataEnterer.practitioner = create('Reference') as reference, reference.reference = append('urn:uuid:',uuid5)
//   ,
// FIXME not known here               practitionerRoleDataEnterer.organization = create('Reference') as reference, reference.type='Organization', reference.reference = append('urn:uuid:',uuid3) 
               then {
                     item then UrgentNotificationContactForRequestItems(item, practitionerRoleDataEnterer, practitionerDataEnterer) &quot;data&quot;;
                     item then ExtOrfUrgentNotificationContactForRequest(item, practitionerRoleDataEnterer, extension) &quot;extension&quot;;
                  } &quot;order.notificationContactDocument.items&quot;;
      } &quot;order.notificationContactDocument&quot;;
   
   src.item as item where (linkId.value = 'order.notificationContactDocumentResponse') then {
      item -&gt; bundle.entry as e4, 
               e4.resource = create('PractitionerRole') as practitionerRoleDataEnterer, 
               practitionerRoleDataEnterer.id = uuid() as uuid4,
               e4.fullUrl = append('urn:uuid:',uuid4),
               composition.extension as extension,
               bundle.entry as e5, 
               e5.resource = create('Practitioner') as practitionerDataEnterer, 
               practitionerDataEnterer.id = uuid() as uuid5,
               e5.fullUrl = append('urn:uuid:',uuid5),
               practitionerRoleDataEnterer.practitioner = create('Reference') as reference, reference.reference = append('urn:uuid:',uuid5)
// ,
// FIXME not known here practitionerRoleDataEnterer.organization = create('Reference') as reference, reference.type='Organization', reference.reference = append('urn:uuid:',uuid3) 
               then {
                     item then UrgentNotificationContactForResponseItems(item, practitionerRoleDataEnterer, practitionerDataEnterer) &quot;data&quot;;
                     item then ExtOrfUrgentNotificationContactForResponse(item, practitionerRoleDataEnterer, extension) &quot;extension&quot;;
                  } &quot;order.notificationContactDocumentResponse.items&quot;;
      } &quot;order.notificationContactDocumentResponse&quot;;
}

group UrgentNotificationContactForRequestPractitionerItems(source src : BackboneElement, target practitioner: Practitioner) {
   src.item as item where (linkId.value = 'order.notificationContactDocument.practitioner.familyName' and answer.exists()) -&gt; practitioner.name as name share practitionerName, name.family = (item.answer.value);
   src.item as item where (linkId.value = 'order.notificationContactDocument.practitioner.givenName' and answer.exists()) -&gt; practitioner.name as name share practitionerName, name.given = (item.answer.value);
   src.item as item where (linkId.value = 'order.notificationContactDocument.practitioner.title' and answer.exists()) -&gt; practitioner.name as name share practitionerName, 
                                                                        name.prefix = (item.answer.value) as prefix,
                                                                        prefix.extension as ext, ext.url = 'http://hl7.org/fhir/StructureDefinition/iso21090-EN-qualifier',
                                                                        ext.value = create('code') as value, value.value='AC' &quot;sender.author.practitioner.title&quot;; 
     src.item as item where (linkId.value = 'order.notificationContactDocument.practitioner.phone' and answer.exists()) -&gt; practitioner.telecom as value, 
                                                                                   value.system = 'phone',
                                                                                   value.value=(item.answer.value) &quot;sender.author.practitioner.phone&quot;; 
   src.item as item where (linkId.value = 'order.notificationContactDocument.practitioner.email' and answer.exists()) -&gt; practitioner.telecom as value, 
                                                                                   value.system = 'email',
                                                                                   value.value=(item.answer.value) &quot;sender.author.practitioner.email&quot;; 
}

group UrgentNotificationContactForRequestItems(source src : BackboneElement, target practitionerRole: practitionerRole, target practitioner : Practitioner) {
   src.item as item where (linkId.value = 'order.notificationContactDocument.practitioner') then UrgentNotificationContactForRequestPractitionerItems(item, practitioner);
}

group ExtOrfUrgentNotificationContactForRequest(source src: BackboneElement, target practitionerRole: PractitionerRole, target ext: Extension) {
  src -&gt; ext.url = 'http://fhir.ch/ig/ch-orf/StructureDefinition/ch-orf-urgentnoficationcontactforthisdocument' &quot;url&quot;;
  src -&gt; ext.value = create('Reference') as reference, 
                reference.reference = ('urn:uuid:'+%practitionerRole.id) &quot;practitionerRole&quot;;
}

group UrgentNotificationContactForResponsePractitionerItems(source src : BackboneElement, target practitioner: Practitioner) {
   src.item as item where (linkId.value = 'order.notificationContactDocumentResponse.practitioner.familyName' and answer.exists()) -&gt; practitioner.name as name share practitionerName, name.family = (item.answer.value);
   src.item as item where (linkId.value = 'order.notificationContactDocumentResponse.practitioner.givenName' and answer.exists()) -&gt; practitioner.name as name share practitionerName, name.given = (item.answer.value);
   src.item as item where (linkId.value = 'order.notificationContactDocumentResponse.practitioner.title' and answer.exists()) -&gt; practitioner.name as name share practitionerName, 
                                                                        name.prefix = (item.answer.value) as prefix,
                                                                        prefix.extension as ext, ext.url = 'http://hl7.org/fhir/StructureDefinition/iso21090-EN-qualifier',
                                                                        ext.value = create('code') as value, value.value='AC' &quot;sender.author.practitioner.title&quot;; 
     src.item as item where (linkId.value = 'order.notificationContactDocumentResponse.practitioner.phone' and answer.exists()) -&gt; practitioner.telecom as value, 
                                                                                   value.system = 'phone',
                                                                                   value.value=(item.answer.value) &quot;sender.author.practitioner.phone&quot;; 
   src.item as item where (linkId.value = 'order.notificationContactDocumentResponse.practitioner.email' and answer.exists()) -&gt; practitioner.telecom as value, 
                                                                                   value.system = 'email',
                                                                                   value.value=(item.answer.value) &quot;sender.author.practitioner.email&quot;; 
}

group UrgentNotificationContactForResponseItems(source src : BackboneElement, target practitionerRole: practitionerRole, target practitioner : Practitioner) {
   src.item as item where (linkId.value = 'order.notificationContactDocumentResponse.practitioner') then UrgentNotificationContactForResponsePractitionerItems(item, practitioner);
}

group ExtOrfUrgentNotificationContactForResponse(source src: BackboneElement, target practitionerRole: PractitionerRole, target ext: Extension) {
  src -&gt; ext.url = 'http://fhir.ch/ig/ch-orf/StructureDefinition/ch-orf-urgentnoficationcontactfortheresponsetothisdocument' &quot;url&quot;;
  src -&gt; ext.value = create('Reference') as reference, 
                 reference.reference = ('urn:uuid:'+%practitionerRole.id) &quot;practitionerRole&quot;;
}


group ReceiverPractitionerItems(source src : BackboneElement, target practitioner : Practitioner) {
   src.item as item where (linkId.value = 'receiver.practitioner.familyName' and answer.exists()) -&gt; practitioner.name as name share practitionerName, name.family = (item.answer.value);
   src.item as item where (linkId.value = 'receiver.practitioner.givenName' and answer.exists()) -&gt; practitioner.name as name share practitionerName, name.given = (item.answer.value);
   src.item as item where (linkId.value = 'receiver.practitioner.title' and answer.exists()) -&gt; practitioner.name as name share practitionerName, 
                                                                        name.prefix = (item.answer.value) as prefix,
                                                                        prefix.extension as ext, ext.url = 'http://hl7.org/fhir/StructureDefinition/iso21090-EN-qualifier',
                                                                        ext.value = create('code') as value, value.value='AC' &quot;receiver.practitioner.title&quot;; 
   src.item as item where (linkId.value = 'receiver.practitioner.gln' and answer.exists()) -&gt; practitioner.identifier as value, 
                                                                                   value.system = 'urn:oid:2.51.1.3',
                                                                                   value.value=(item.answer.value) &quot;receiver.practitioner.gln&quot;; 
   src.item as item where (linkId.value = 'receiver.practitioner.zsr' and answer.exists()) -&gt; practitioner.identifier as value, 
                                                                                   value.system = 'urn:oid:2.16.756.5.30.1.123.100.2.1.1',
                                                                                   value.value=(item.answer.value) &quot;receiver.practitioner.zsr&quot;; 
   src.item as item where (linkId.value = 'receiver.practitioner.phone' and answer.exists()) -&gt; practitioner.telecom as value, 
                                                                                   value.system = 'phone',
                                                                                   value.value=(item.answer.value) &quot;receiver.practitioner.phone&quot;; 
   src.item as item where (linkId.value = 'receiver.practitioner.email' and answer.exists()) -&gt; practitioner.telecom as value, 
                                                                                   value.system = 'email',
                                                                                   value.value=(item.answer.value) &quot;receiver.practitioner.email&quot;; 
}

group ReceiverOrganizationItems(source src : BackboneElement, target organization : Organization) {
   src.item as item where (linkId.value = 'receiver.organization.name' and answer.exists()) -&gt; organization.name = (item.answer.value);
   src.item as item where (linkId.value = 'receiver.organization.gln' and answer.exists()) -&gt; organization.identifier as value, 
                                                                                   value.system = 'urn:oid:2.51.1.3',
                                                                                   value.value=(item.answer.value) &quot;receiver.organization.gln&quot;;
   src.item as item where (linkId.value = 'receiver.organization.zsr' and answer.exists()) -&gt; organization.identifier as value, 
                                                                                   value.system = 'urn:oid:2.16.756.5.30.1.123.100.2.1.1',
                                                                                   value.value=(item.answer.value) &quot;receiver.organization.zsr&quot;; 
   src.item as item where (linkId.value = 'receiver.organization.streetAddressLine' and answer.exists()) -&gt; organization.address as address share orgAddress then {
     item.answer as answer -&gt; address.line = (answer.value) &quot;receiver.organization.streetAddressLine&quot;;
   } &quot;item.answer&quot;;
   src.item as item where (linkId.value = 'receiver.organization.postalCode' and answer.exists()) -&gt; organization.address as address share orgAddress, address.postalCode = (item.answer.value) &quot;receiver.organization.postalCode&quot;;
   src.item as item where (linkId.value = 'receiver.organization.city' and answer.exists()) -&gt; organization.address as address share orgAddress, address.city = (item.answer.value) &quot;receiver.organization.city&quot;;
   src.item as item where (linkId.value = 'receiver.organization.country' and answer.exists()) -&gt; organization.address as address share orgAddress, address.country = (item.answer.value) &quot;receiver.organization.country&quot;;
}

group ReceiverItems(source src : BackboneElement, target bundle: Bundle, target practitionerRole: practitionerRole) {
   src.item as item where (linkId.value = 'receiver.practitioner') -&gt; 
      bundle.entry as e2, 
      e2.resource = create('Practitioner') as practitioner, 
      practitioner.id = uuid() as uuid2,
      practitionerRole.practitioner = create('Reference') as reference, reference.reference = append('urn:uuid:',uuid2),
      e2.fullUrl = append('urn:uuid:',uuid2) then ReceiverPractitionerItems(item, practitioner);
   src.item as item where (linkId.value = 'receiver.organization') -&gt;
     bundle.entry as e3, 
     e3.resource = create('Organization') as organization, 
     organization.id = uuid() as uuid3,
     practitionerRole.organization = create('Reference') as reference, reference.reference = append('urn:uuid:',uuid3), 
     e3.fullUrl = append('urn:uuid:',uuid3) then ReceiverOrganizationItems(item, organization);
}

group Consent(source src : BackboneElement, target bundle: Bundle, target composition : Composition) {
   src.item as item where (linkId.value = 'consent.statement' and answer.exists()) -&gt; bundle.entry as e, 
          e.resource = create('Consent') as consent,
          consent.status = 'active', 
          consent.scope as scope, scope.coding as coding, coding.code = 'treatment', coding.system= 'http://terminology.hl7.org/CodeSystem/consentscope',
          consent.category as category, category.coding as coding, coding.code = '59284-0', coding.system= 'http://loinc.org',
          consent.policyRule as policyRule, policyRule.coding as coding, coding.code = '385432009', coding.system= 'http://snomed.info/sct',
          consent.id = uuid() as uuid,
          e.fullUrl = append('urn:uuid:',uuid),
          composition.extension as ext, 
          ext.url = 'http://fhir.ch/ig/ch-orf/StructureDefinition/ch-orf-patientconsent',
          ext.value = create('Reference') as reference, 
          consent.extension as extcode,
          extcode.url = 'http://fhir.ch/ig/ch-orf/StructureDefinition/ch-orf-consentcode',
          extcode.value = create('CodeableConcept') as cc, cc.coding = (item.answer.value),
          reference.reference = append('urn:uuid:',uuid) then {
            item.answer as answer then {
               answer.item as item where (linkId.value = 'consent.statement.note' and answer.exists())
               -&gt; consent.extension as extnote,
                  extnote.url = 'http://fhir.ch/ig/ch-orf/StructureDefinition/ch-orf-consentnote',
                  extnote.value = (item.answer.value) &quot;consent.statement.note&quot;;
            } &quot;item.answer&quot;;
          } &quot;consent.statement&quot;;
}

group ReceiverInit(source src : BackboneElement, target bundle: Bundle, target composition : Composition, target serviceRequest: ServiceRequest) {
   src -&gt; bundle.entry as e, 
          e.resource = create('PractitionerRole') as practitionerRole, 
          practitionerRole.id = uuid() as uuid,
          e.fullUrl = append('urn:uuid:',uuid),
          composition.extension as ext, 
          ext.url = 'http://fhir.ch/ig/ch-orf/StructureDefinition/ch-orf-receiver',
          ext.value = create('Reference') as reference, 
          reference.reference = append('urn:uuid:',uuid) then
          ReceiverItems(src, bundle, practitionerRole) &quot;receiver&quot;;
}

group InitiatorItems(source src : BackboneElement, target bundle: Bundle, target patient: Patient, target ext: Extension) {
   src.item as item where (linkId.value = 'initiator.personalrelation' and answer.exists()) -&gt; 
      ext.extension as extension, 
      extension.url = 'ch-orf-personalrelation', 
      extension.value = (item.answer.value) &quot;initiator.personalrelation&quot;;
   src.item as item where (linkId.value = 'initiator.legalrelation' and answer.exists()) -&gt; 
      ext.extension as extension, 
      extension.url = 'ch-orf-legalrelation', 
      extension.value = (item.answer.value) &quot;initiator.legalrelation&quot;;
   src.item as item where (linkId='initiator.practitionerRole') -&gt; bundle.entry as e4, 
      e4.resource = create('PractitionerRole') as practitionerrole, 
      ext.extension as extension,
      practitionerrole.id = uuid() as uuid4,
      extension.url = 'ch-orf-personorganization',
      extension.value =  create('Reference') as reference, 
      reference.reference = append('urn:uuid:',uuid4),
      e4.fullUrl = append('urn:uuid:',uuid4) then {
         item then InitiatorPractitionerRoleItems(item, bundle, practitionerrole) &quot;data&quot;;
      } &quot;InitiatorPractitionerRoleItems&quot;;
   src.item as item where (linkId='initiator.relatedPerson') -&gt; bundle.entry as e4, 
            e4.resource = create('RelatedPerson') as relatedPerson,
            ext.extension as extension, 
            extension.url = 'ch-orf-personorganization',
            extension.value =  create('Reference') as reference, 
            relatedPerson.id = uuid() as uuid4,
            reference.reference = append('urn:uuid:',uuid4),
            relatedPerson.patient as reference,
            reference.reference = ('urn:uuid:'+%patient.id),
            e4.fullUrl = append('urn:uuid:',uuid4) then {
               item then InitiatorRelatedPersonItems(item, relatedPerson) &quot;data&quot;;
            } &quot;initiator.relatedPerson&quot;;
}

group InitiatorRelatedPersonItems(source src : BackboneElement, target relatedPerson: RelatedPerson) {
   src.item as item where (linkId.value = 'initiator.relatedPerson.familyName' and answer.exists()) -&gt; relatedPerson.name as name share name, name.family = (item.answer.value);
   src.item as item where (linkId.value = 'initiator.relatedPerson.givenName' and answer.exists()) -&gt; relatedPerson.name as name share name, name.given = (item.answer.value);
   src.item as item where (linkId.value = 'initiator.relatedPerson.phone' and answer.exists()) then {
      item.answer as answer -&gt; relatedPerson.telecom as value, value.system = 'phone',
                                value.value= (answer.value) &quot;initiator.relatedPerson.phone&quot;; 
   } &quot;phone&quot;;
   src.item as item where (linkId.value = 'initiator.relatedPerson.email' and answer.exists()) -&gt; relatedPerson.telecom as value, 
                                                                                   value.system = 'email',
                                                                                   value.value=(item.answer.value) &quot;initiator.relatedPerson.email&quot;; 
   src.item as item where (linkId.value = 'initiator.relatedPerson.streetAddressLine' and answer.exists()) -&gt; relatedPerson.address as address share orgAddress then {
     item.answer as answer -&gt; address.line = (answer.value) &quot;initiator.relatedPerson.streetAddressLine&quot;;
   } &quot;item.answer&quot;;
   src.item as item where (linkId.value = 'initiator.relatedPerson.postalCode' and answer.exists()) -&gt; relatedPerson.address as address share orgAddress, address.postalCode = (item.answer.value) &quot;initiator.relatedPerson.postalCode&quot;;
   src.item as item where (linkId.value = 'initiator.relatedPerson.city' and answer.exists()) -&gt; relatedPerson.address as address share orgAddress, address.city = (item.answer.value) &quot;initiator.relatedPerson.city&quot;;
   src.item as item where (linkId.value = 'initiator.relatedPerson.country' and answer.exists()) -&gt; relatedPerson.address as address share orgAddress, address.country = (item.answer.value) &quot;initiator.relatedPerson.country&quot;;
}


group InitiatorPractitionerRoleItems(source src : BackboneElement, target bundle: Bundle, target practitionerRole: practitionerRole) {
   src.item as item where (linkId.value = 'initiator.practitionerRole.practitioner') -&gt; 
      bundle.entry as e2, 
      e2.resource = create('Practitioner') as practitioner, 
      practitioner.id = uuid() as uuid2,
      practitionerRole.practitioner = create('Reference') as reference, reference.reference = append('urn:uuid:',uuid2),
      e2.fullUrl = append('urn:uuid:',uuid2) then InitiatorPractitionerItems(item, practitioner);
   src.item as item where (linkId.value = 'initiator.practitionerRole.organization') -&gt;
     bundle.entry as e3, 
     e3.resource = create('Organization') as organization, 
     organization.id = uuid() as uuid3,
     practitionerRole.organization = create('Reference') as reference, reference.reference = append('urn:uuid:',uuid3), 
     e3.fullUrl = append('urn:uuid:',uuid3) then InitiatorOrganizationItems(item, organization);
}

group InitiatorPractitionerItems(source src : BackboneElement, target practitioner : Practitioner) {
   src.item as item where (linkId.value = 'initiator.practitionerRole.practitioner.familyName' and answer.exists()) -&gt; practitioner.name as name share practitionerName, name.family = (item.answer.value);
   src.item as item where (linkId.value = 'initiator.practitionerRole.practitioner.givenName' and answer.exists()) -&gt; practitioner.name as name share practitionerName, name.given = (item.answer.value);
   src.item as item where (linkId.value = 'initiator.practitionerRole.practitioner.title' and answer.exists()) -&gt; practitioner.name as name share practitionerName, 
                                                                        name.prefix = (item.answer.value) as prefix,
                                                                        prefix.extension as ext, ext.url = 'http://hl7.org/fhir/StructureDefinition/iso21090-EN-qualifier',
                                                                        ext.value = create('code') as value, value.value='AC' &quot;initiator.practitionerRole.practitioner.title&quot;; 
   src.item as item where (linkId.value = 'initiator.practitionerRole.practitioner.phone' and answer.exists()) -&gt; practitioner.telecom as value, 
                                                                                   value.system = 'phone',
                                                                                   value.value=(item.answer.value) &quot;initiator.practitionerRole.practitioner.phone&quot;; 
   src.item as item where (linkId.value = 'initiator.practitionerRole.practitioner.email' and answer.exists()) -&gt; practitioner.telecom as value, 
                                                                                   value.system = 'email',
                                                                                   value.value=(item.answer.value) &quot;initiator.practitionerRole.practitioner.email&quot;; 
   src.item as item where (linkId.value = 'initiator.practitionerRole.practitioner.gln' and answer.exists()) -&gt; practitioner.identifier as value, 
                                                                                   value.system = 'urn:oid:2.51.1.3',
                                                                                   value.value=(item.answer.value) &quot;receiver.practitioner.gln&quot;; 
   src.item as item where (linkId.value = 'initiator.practitionerRole.practitioner.zsr' and answer.exists()) -&gt; practitioner.identifier as value, 
                                                                                   value.system = 'urn:oid:2.16.756.5.30.1.123.100.2.1.1',
                                                                                   value.value=(item.answer.value) &quot;receiver.practitioner.zsr&quot;; 
}

group InitiatorOrganizationItems(source src : BackboneElement, target organization : Organization) {
   src.item as item where (linkId.value = 'initiator.practitionerRole.organization.name' and answer.exists()) -&gt; organization.name = (item.answer.value);
   src.item as item where (linkId.value = 'initiator.practitionerRole.organization.streetAddressLine' and answer.exists()) -&gt; organization.address as address share orgAddress then {
     item.answer as answer -&gt; address.line = (answer.value) &quot;initiator.practitionerRole.organization.streetAddressLine&quot;;
   } &quot;item.answer&quot;;
   src.item as item where (linkId.value = 'initiator.practitionerRole.organization.postalCode' and answer.exists()) -&gt; organization.address as address share orgAddress, address.postalCode = (item.answer.value) &quot;initiator.practitionerRole.organization.postalCode&quot;;
   src.item as item where (linkId.value = 'initiator.practitionerRole.organization.city' and answer.exists()) -&gt; organization.address as address share orgAddress, address.city = (item.answer.value) &quot;initiator.practitionerRole.organization.city&quot;;
   src.item as item where (linkId.value = 'initiator.practitionerRole.organization.country' and answer.exists()) -&gt; organization.address as address share orgAddress, address.country = (item.answer.value) &quot;initiator.practitionerRole.organization.country&quot;;
}

group FamilyDoctorInit(source src : BackboneElement, target bundle: Bundle, target patient: Patient, target composition : Composition, target serviceRequest: ServiceRequest) {
  src -&gt; bundle.entry as e4, 
  e4.resource = create('PractitionerRole') as practitionerRole,
  practitionerRole.id = uuid() as uuid4,
  patient.generalPractitioner = create('Reference') as gp, 
  gp.reference = append('urn:uuid:',uuid4),
  e4.fullUrl = append('urn:uuid:',uuid4) then {
     src.item as item where (linkId.value = 'familydoctor.practitioner') -&gt; 
     bundle.entry as e2, 
     e2.resource = create('Practitioner') as practitioner, 
    practitioner.id = uuid() as uuid2,
     practitionerRole.practitioner = create('Reference') as reference, reference.reference = append('urn:uuid:',uuid2),
     e2.fullUrl = append('urn:uuid:',uuid2) then FamilyDoctorPractitionerItems(item, practitioner);

     src.item as item where (linkId.value = 'familydoctor.organization') -&gt;
     bundle.entry as e3, 
     e3.resource = create('Organization') as organization, 
     organization.id = uuid() as uuid3,
     practitionerRole.organization = create('Reference') as reference, reference.reference = append('urn:uuid:',uuid3), 
     e3.fullUrl = append('urn:uuid:',uuid3) then FamilyDoctorOrganizationItems(item, organization);
 } &quot;FamilyDoctorInit&quot;;
}

group FamilyDoctorPractitionerItems(source src : BackboneElement, target practitioner : Practitioner) {
   src.item as item where (linkId.value = 'familydoctor.practitioner.familyName' and answer.exists()) -&gt; practitioner.name as name share practitionerName, name.family = (item.answer.value);
   src.item as item where (linkId.value = 'familydoctor.practitioner.givenName' and answer.exists()) -&gt; practitioner.name as name share practitionerName, name.given = (item.answer.value);
   src.item as item where (linkId.value = 'familydoctor.practitioner.gln' and answer.exists()) -&gt; practitioner.identifier as value, 
                                                                                   value.system = 'urn:oid:2.51.1.3',
                                                                                   value.value=(item.answer.value) &quot;familydoctor.practitioner.gln&quot;; 
   src.item as item where (linkId.value = 'familydoctor.practitioner.zsr' and answer.exists()) -&gt; practitioner.identifier as value, 
                                                                                   value.system = 'urn:oid:2.16.756.5.30.1.123.100.2.1.1',
                                                                                   value.value=(item.answer.value) &quot;familydoctor.practitioner.zsr&quot;; 
   src.item as item where (linkId.value = 'familydoctor.practitioner.title' and answer.exists()) -&gt; practitioner.name as name share practitionerName, 
                                                                        name.prefix = (item.answer.value) as prefix,
                                                                        prefix.extension as ext, ext.url = 'http://hl7.org/fhir/StructureDefinition/iso21090-EN-qualifier',
                                                                        ext.value = create('code') as value, value.value='AC' &quot;familydoctor.practitioner.title&quot;; 
   src.item as item where (linkId.value = 'familydoctor.practitioner.phone' and answer.exists()) -&gt; practitioner.telecom as value, 
                                                                                   value.system = 'phone',
                                                                                   value.value=(item.answer.value) &quot;familydoctor.practitioner.phone&quot;; 
   src.item as item where (linkId.value = 'familydoctor.practitioner.email' and answer.exists()) -&gt; practitioner.telecom as value, 
                                                                                   value.system = 'email',
                                                                                   value.value=(item.answer.value) &quot;familydoctor.practitioner.email&quot;; 
}

group FamilyDoctorOrganizationItems(source src : BackboneElement, target organization : Organization) {
   src.item as item where (linkId.value = 'familydoctor.organization.name' and answer.exists()) -&gt; organization.name = (item.answer.value);
   src.item as item where (linkId.value = 'familydoctor.organization.streetAddressLine' and answer.exists()) -&gt; organization.address as address share orgAddress then {
     item.answer as answer -&gt; address.line = (answer.value) &quot;familydoctor.organization.streetAddressLine&quot;;
   } &quot;item.answer&quot;;
   src.item as item where (linkId.value = 'familydoctor.organization.postalCode' and answer.exists()) -&gt; organization.address as address share orgAddress, address.postalCode = (item.answer.value) &quot;familydoctor.organization.postalCode&quot;;
   src.item as item where (linkId.value = 'familydoctor.organization.city' and answer.exists()) -&gt; organization.address as address share orgAddress, address.city = (item.answer.value) &quot;familydoctor.organization.city&quot;;
   src.item as item where (linkId.value = 'familydoctor.organization.country' and answer.exists()) -&gt; organization.address as address share orgAddress, address.country = (item.answer.value) &quot;familydoctor.organization.country&quot;;
   src.item as item where (linkId.value = 'familydoctor.organization.gln' and answer.exists()) -&gt; organization.identifier as value, 
                                                                                   value.system = 'urn:oid:2.51.1.3',
                                                                                   value.value=(item.answer.value) &quot;familydoctor.organization.gln&quot;;
   src.item as item where (linkId.value = 'familydoctor.organization.zsr' and answer.exists()) -&gt; organization.identifier as value, 
                                                                                   value.system = 'urn:oid:2.16.756.5.30.1.123.100.2.1.1',
                                                                                   value.value=(item.answer.value) &quot;familydoctorr.organization.zsr&quot;; 
}

group AntecedentEpisodeOfCareInit(source src : BackboneElement, target bundle: Bundle, target patient: Patient, target composition : Composition) {
   src -&gt; composition.extension as ext, 
          ext.url = 'http://fhir.ch/ig/ch-orf/StructureDefinition/ch-orf-antecedentepisodeofcare',
          bundle.entry as e4, 
          e4.resource = create('EpisodeOfCare') as episodeofcare, 
          episodeofcare.id = uuid() as uuid4,
          e4.fullUrl = ('urn:uuid:'+%uuid4),
          episodeofcare.status = 'finished',
          ext.value = create('Reference') as ref, ref.reference = ('urn:uuid:'+%episodeofcare.id)
          then AntecedentEpisodeOfCareItems(src, bundle, patient, episodeofcare) &quot;AntecedentEpisodeOfCareItems&quot;;
}

group AntecedentEpisodeOfCareItems(source src : BackboneElement, target bundle: Bundle, target tgt: Patient, target episodeofcare : EpisodeOfCare) {
   src.item as item where (linkId.value = 'antecedentEpisodeOfCare.start' and answer.exists()) -&gt; episodeofcare.statusHistory as statusHistory, statusHistory.status='finished', statusHistory.period as period, period.start = (item.answer.value), period.end = (item.answer.value) then {
        src.item as iteme where (linkId.value = 'antecedentEpisodeOfCare.end' and answer.exists()) -&gt; period.end = (iteme.answer.value) &quot;antecedentEpisodeOfCareEndNotSameAsStart&quot;;
   } &quot;antecedentEpisodeOfCare.requestedPeriod.start&quot;;
   src.item as item where (linkId.value = 'antecedentEpisodeOfCare.managingOrganization') -&gt; 
      bundle.entry as e3, 
          e3.resource = create('Organization') as organization, 
          organization.id = uuid() as uuid3,
          e3.fullUrl = append('urn:uuid:',uuid3),
          episodeofcare.patient = create('Reference') as reference, reference.reference = ('urn:uuid:'+%tgt.id),
          episodeofcare.managingOrganization = create('Reference') as reference, 
          reference.reference = append('urn:uuid:',uuid3) then AntecedentEpisodeOfCareOrganizationItems(item, organization) &quot;antecedentEpisodeOfCare.managingOrganization&quot;;
}

group AntecedentEpisodeOfCareOrganizationItems(source src : BackboneElement, target organization : Organization) {
   src.item as item where (linkId.value = 'antecedentEpisodeOfCare.managingOrganization.name' and answer.exists()) -&gt; organization.name = (item.answer.value);
   src.item as item where (linkId.value = 'antecedentEpisodeOfCare.managingOrganization.streetAddressLine' and answer.exists()) -&gt; organization.address as address share orgAddress then {
      item.answer as answer -&gt; address.line = (answer.value) &quot;antecedentEpisodeOfCareorganization.streetAddressLine&quot;;
   } &quot;item.answer&quot;;
   src.item as item where (linkId.value = 'antecedentEpisodeOfCare.managingOrganization.postalCode' and answer.exists()) -&gt; organization.address as address share orgAddress, address.postalCode = (item.answer.value) &quot;sender.author.organization.postalCode&quot;;
   src.item as item where (linkId.value = 'antecedentEpisodeOfCare.managingOrganization.city' and answer.exists()) -&gt; organization.address as address share orgAddress, address.city = (item.answer.value) &quot;sender.author.organization.city&quot;;
   src.item as item where (linkId.value = 'antecedentEpisodeOfCare.managingOrganization.country' and answer.exists()) -&gt; organization.address as address share orgAddress, address.country = (item.answer.value) &quot;sender.author.organization.country&quot;;
}

group InitiatorInit(source src : BackboneElement, target bundle: Bundle, target patient: Patient, target composition : Composition, target serviceRequest: ServiceRequest) {
   src -&gt; composition.extension as ext, 
          ext.url = 'http://fhir.ch/ig/ch-orf/StructureDefinition/ch-orf-initiator'
          then InitiatorItems(src, bundle, patient, ext) &quot;receiver&quot;;
}

group PatientItems(source src : BackboneElement, target bundle: Bundle, target tgt: Patient, target composition : Composition, target serviceRequest: ServiceRequest) {
  src.item as grp where linkId='familydoctor' then FamilyDoctorInit(grp, bundle, tgt, composition, serviceRequest) &quot;grpfamily&quot;;

  src.item as item then PatientItems(item, bundle, tgt, composition, serviceRequest);
  src.item as item where (linkId.value = 'patient.familyName' and answer.exists()) -&gt; tgt.name as name share patientName,name.family = (item.answer.value);
  src.item as item where (linkId.value = 'patient.maidenName' and answer.exists()) -&gt; tgt.name as name, name.use = 'maiden', name.family = (item.answer.value);
  src.item as item where (linkId.value = 'patient.givenName' and answer.exists()) -&gt; tgt.name as name share patientName, name.given = (item.answer.value);
  src.item as item where (linkId.value = 'patient.localPid' and answer.exists()) -&gt; tgt.identifier as value share localpid, 
                                                                                   value.type as type, type.coding as coding,
                                                                                   coding.system = 'http://terminology.hl7.org/CodeSystem/v2-0203',
                                                                                   coding.code = 'MR',
                                                                                   value.value=(item.answer.valueString) &quot;patient.localPid&quot;;
  src.item as item where (linkId.value = 'patient.localPidDomain' and answer.exists()) -&gt; tgt.identifier as value share localpid, 
                                                                                   value.system=(item.answer.valueString) &quot;patient.localPidDomain&quot;; 
  src.item as item where (linkId.value = 'patient.birthDate' and answer.exists()) -&gt; tgt.birthDate = (item.answer.value);
  src.item as item where (linkId.value = 'patient.gender' and answer.exists()) -&gt; tgt.gender = (item.answer.value.code);
  src.item as item where (linkId.value = 'patient.maritalStatus' and answer.exists()) then {
   item.answer as answer then {
      answer.value: Coding as coding -&gt; tgt.maritalStatus as maritalStatus, maritalStatus.coding = coding &quot;maritalStatus&quot;; 
      } &quot;answer&quot;;
  } &quot;patient.maritalStatus&quot;; 
  src.item as item where (linkId.value = 'patient.phone' and answer.exists()) then {
   item.answer as answer -&gt; tgt.telecom as value, value.system = 'phone', value.value=(answer.value) &quot;patient.phone&quot;;  
  } &quot;patient.phone&quot;;
  src.item as item where (linkId.value = 'patient.email' and answer.exists()) -&gt; tgt.telecom as value, 
                                                                                   value.system = 'email',
                                                                                   value.value=(item.answer.value) &quot;patient.email&quot;; 
  src.item as item where (linkId.value = 'patient.streetAddressLine' and answer.exists()) -&gt; tgt.address as address share orgAddress then {
     item.answer as answer -&gt; address.line = (answer.value) &quot;patient.streetAddressLine&quot;;
  } &quot;item.answer&quot;;
  src.item as item where (linkId.value = 'patient.postalCode' and answer.exists()) -&gt; tgt.address as address share orgAddress, address.postalCode = (item.answer.value) &quot;patient.postalCode&quot;;
  src.item as item where (linkId.value = 'patient.city' and answer.exists()) -&gt; tgt.address as address share orgAddress, address.city = (item.answer.value) &quot;patient.city&quot;;
  src.item as item where (linkId.value = 'patient.country' and answer.exists()) -&gt; tgt.address as address share orgAddress, address.country = (item.answer.value) &quot;patient.country&quot;;

  src.item as item where (linkId.value = 'patient.languageOfCorrespondence' and answer.exists()) then {
   item.answer as answer then {
      answer.value: Coding as coding -&gt; tgt.communication as communication, communication.preferred = true, communication.language as language, language.coding = coding &quot;languageOfCorrespondence&quot;; 
      } &quot;answer&quot;;
  } &quot;patient.languageOfCorrespondence&quot;; 

  src.item as item where (linkId.value = 'patient.contactperson') -&gt; tgt.contact as contact then {
   item.item as item where (linkId.value = 'patient.contactperson.familyName' and answer.exists()) -&gt; contact.name as name share contactName,name.family = (item.answer.value);
   item.item as item where (linkId.value = 'patient.contactperson.givenName' and answer.exists()) -&gt; contact.name as name share contactName, name.given = (item.answer.value);

   src.item as item where (linkId.value = 'patient.contactperson.phone' and answer.exists()) then {
      item.answer as answer -&gt; tgt.telecom as value, value.system = 'phone', value.value=(answer.value) &quot;patient.phone&quot;;  
     } &quot;patient.contactperson.phone&quot;;
   
   item.item as item where (linkId.value = 'patient.contactperson.email' and answer.exists()) -&gt; contact.telecom as value, 
                                                                                   value.system = 'email',
                                                                                   value.value=(item.answer.value) &quot;patient.email&quot;; 
   item.item as item where (linkId.value = 'patient.contactperson.relationship' and answer.exists()) -&gt; contact.relationship as relationship, 
                                                                                   relationship.text=(item.answer.value) &quot;patient.contactperson.relationship&quot;; 
  } &quot;contact&quot;;
}

group RequestedEncounterItems(source src : BackboneElement, target bundle: Bundle, target patient: Patient, target serviceRequest : ServiceRequest) {
  src -&gt; bundle.entry as e4, 
                e4.resource = create('Encounter') as encounter, 
                encounter.id = uuid() as uuid4,
                e4.fullUrl = ('urn:uuid:'+%uuid4),
                encounter.status = 'planned',
                serviceRequest.extension as extension,
                encounter.subject = create('Reference') as subject, subject.reference = ('urn:uuid:'+%patient.id),
                extension.url = 'http://fhir.ch/ig/ch-orf/StructureDefinition/ch-orf-requestedencounterdetails',
                extension.value = create('Reference') as reference, reference.reference = ('urn:uuid:'+%uuid4)                
                then {
                  src.item as item where (linkId.value = 'requestedEncounter.class' and answer.exists()) -&gt; 
                      encounter.class = (item.answer.value) &quot;requestedEncounter.class&quot;;
                  src.item as item where (linkId.value = 'requestedEncounter.desiredAccommodation' and answer.exists()) -&gt; 
                      encounter.extension as extension,
                      extension.url = 'http://fhir.ch/ig/ch-orf/StructureDefinition/ch-orf-desiredaccommodation', 
                      extension.value = (item.answer.value) &quot;requestedEncounter.desiredAccommodation&quot;;
   } &quot;RequestedEncounterItems&quot;;
 }

 group Coverage(source src : BackboneElement, target bundle: Bundle, target patient: Patient, target serviceRequest : ServiceRequest) {
// coverage.beneficiary
// coverage.beneficiary.ahvn13
     src.item as item where where (linkId.value = 'coverage.beneficiary') then {
      item.item as item where (linkId.value = 'coverage.beneficiary.ahvn13' and answer.exists()) -&gt; 
         patient.identifier as identifier, identifier.system = 'urn:oid:2.16.756.5.32', identifier.value = (item.answer.value) &quot;coverage.beneficiary.ahvn13&quot;;
     } &quot;coverage.beneficiary&quot;;

//   coverage.kvg	
//   coverage.kvg.name	 
//   coverage.kvg.insuranceCardNumber	
      src.item as item where where (linkId.value = 'coverage.kvg') -&gt; bundle.entry as e4, 
      e4.resource = create('Coverage') as coverage, 
      coverage.id = uuid() as uuid4,
      e4.fullUrl = ('urn:uuid:'+%uuid4),
      serviceRequest.insurance as insurance, insurance.reference = ('urn:uuid:'+%uuid4),
      coverage.status = 'active',
      coverage.beneficiary = create('Reference') as subject, subject.reference = ('urn:uuid:'+%patient.id),
      coverage.type as type, type.coding as coding, coding.system = 'http://fhir.ch/ig/ch-orf/CodeSystem/ch-orf-cs-coveragetype', coding.code = 'KVG' then {
         item.item as item where (linkId.value = 'coverage.kvg.name' and answer.exists()) -&gt;
           coverage.payor as payor, payor.reference as refcontained, refcontained.value = '#org', 
           coverage.contained = create('Organization') as organization, organization.id = 'org', organization.name = (item.answer.value) &quot;coverage.kvg.name&quot;;
         item.item as item where (linkId.value = 'coverage.kvg.insuranceCardNumber' and answer.exists()) -&gt;
           coverage.identifier as identifier, identifier.type as typeid, typeid.coding as coding, coding.system = 'http://fhir.ch/ig/ch-orf/CodeSystem/ch-orf-cs-coverageidentifiertype', coding.code = 'VeKa', 
           identifier.value = (item.answer.value) &quot;coverage.kvg.insuranceCardNumber&quot;;
      } &quot;coveragekvg&quot;;
//   coverage.uvg	Unfallversicherung (nach UVG)	0..1	group		Definition: Coverage.type
//   coverage.uvg.name	Name der Versicherung	0..1	string		Definition: Coverage.payor
//   coverage.uvg.claimNumber	Schadennummer	0..1	string		Definition: Coverage.identifier
   src.item as item where where (linkId.value = 'coverage.uvg') -&gt; bundle.entry as e4, 
      e4.resource = create('Coverage') as coverage, 
      coverage.id = uuid() as uuid4,
      e4.fullUrl = ('urn:uuid:'+%uuid4),
      serviceRequest.insurance as insurance, insurance.reference = ('urn:uuid:'+%uuid4),
      coverage.status = 'active',
      coverage.beneficiary = create('Reference') as subject, subject.reference = ('urn:uuid:'+%patient.id),
      coverage.type as type, type.coding as coding, coding.system = 'http://fhir.ch/ig/ch-orf/CodeSystem/ch-orf-cs-coveragetype', coding.code = 'UVG' then {
         item.item as item where (linkId.value = 'coverage.uvg.name' and answer.exists()) -&gt;
           coverage.payor as payor, payor.reference as refcontained, refcontained.value = '#org', 
           coverage.contained = create('Organization') as organization, organization.id = 'org', organization.name = (item.answer.value) &quot;coverage.uvg.name&quot;;
         item.item as item where (linkId.value = 'coverage.uvg.claimNumber' and answer.exists()) -&gt;
           coverage.identifier as identifier, identifier.type as typeid, typeid.coding as coding, coding.system = 'http://fhir.ch/ig/ch-orf/CodeSystem/ch-orf-cs-coverageidentifiertype', coding.code = 'Claim', 
           identifier.value = (item.answer.value) &quot;coverage.uvg.claimNumber&quot;;
      } &quot;coverageuvg&quot;;
//  coverage.vvg	Zusatzversicherung (nach VVG)	0..1	group		Definition: Coverage.type
//  coverage.vvg.name	Name der Versicherung	0..1	string		Definition: Coverage.payor
//  coverage.vvg.insuranceCardNumber	Kennnummer der Versichertenkarte	0..1	string		Definition: Coverage.identifier
 src.item as item where where (linkId.value = 'coverage.vvg') -&gt; bundle.entry as e4, 
      e4.resource = create('Coverage') as coverage, 
      coverage.id = uuid() as uuid4,
      e4.fullUrl = ('urn:uuid:'+%uuid4),
      serviceRequest.insurance as insurance, insurance.reference = ('urn:uuid:'+%uuid4),
      coverage.status = 'active',
      coverage.beneficiary = create('Reference') as subject, subject.reference = ('urn:uuid:'+%patient.id),
      coverage.type as type, type.coding as coding, coding.system = 'http://fhir.ch/ig/ch-orf/CodeSystem/ch-orf-cs-coveragetype', coding.code = 'VVG' then {
         item.item as item where (linkId.value = 'coverage.vvg.name' and answer.exists()) -&gt;
           coverage.payor as payor, payor.reference as refcontained, refcontained.value = '#org', 
           coverage.contained = create('Organization') as organization, organization.id = 'org', organization.name = (item.answer.value) &quot;coverage.vvg.name&quot;;
         item.item as item where (linkId.value = 'coverage.vvg.insuranceCardNumber' and answer.exists()) -&gt;
           coverage.identifier as identifier, identifier.type as typeid, typeid.coding as coding, coding.system = 'http://fhir.ch/ig/ch-orf/CodeSystem/ch-orf-cs-coverageidentifiertype', coding.code = 'VeKa', 
           identifier.value = (item.answer.value) &quot;coverage.vvg.insuranceCardNumber&quot;;
      } &quot;coveragevvg&quot;;

// coverage.iv	Invalidenversicherung (IV)	0..1	group		Definition: Coverage.type
// coverage.iv.verfuegungsnummer
src.item as item where where (linkId.value = 'coverage.iv') -&gt; bundle.entry as e4, 
   e4.resource = create('Coverage') as coverage, 
   coverage.id = uuid() as uuid4,
   e4.fullUrl = ('urn:uuid:'+%uuid4),
   serviceRequest.insurance as insurance, insurance.reference = ('urn:uuid:'+%uuid4),
   coverage.status = 'active',
   coverage.beneficiary = create('Reference') as subject, subject.reference = ('urn:uuid:'+%patient.id),
   coverage.type as type, type.coding as coding, coding.system = 'http://fhir.ch/ig/ch-orf/CodeSystem/ch-orf-cs-coveragetype', coding.code = 'IVG' then {
      item.item as item where (linkId.value = 'coverage.iv.verfuegungsnummer' and answer.exists()) -&gt;
      coverage.identifier as identifier, identifier.type as typeid, typeid.coding as coding, coding.system = 'http://fhir.ch/ig/ch-orf/CodeSystem/ch-orf-cs-coverageidentifiertype', coding.code = 'IV', 
      identifier.value = (item.answer.value),
      coverage.payor as payor, payor.reference as refcontained, refcontained.value = '#org', 
      coverage.contained = create('Organization') as organization, organization.id = 'org', organization.name = 'IV' &quot;coverage.iv.verfuegungsnummer&quot;;
   } &quot;coverageiv&quot;;

 // coverage.mv	Militärversicherung (MV)	0..1	group		Definition: Coverage.type
// coverage.mv.versichertennummer
src.item as item where where (linkId.value = 'coverage.mv') -&gt; bundle.entry as e4, 
   e4.resource = create('Coverage') as coverage, 
   coverage.id = uuid() as uuid4,
   e4.fullUrl = ('urn:uuid:'+%uuid4),
   serviceRequest.insurance as insurance, insurance.reference = ('urn:uuid:'+%uuid4),
   coverage.status = 'active',
   coverage.beneficiary = create('Reference') as subject, subject.reference = ('urn:uuid:'+%patient.id),
   coverage.type as type, type.coding as coding, coding.system = 'http://fhir.ch/ig/ch-orf/CodeSystem/ch-orf-cs-coveragetype', coding.code = 'MVG' then {
      item.item as item where (linkId.value = 'coverage.mv.versichertennummer' and answer.exists()) -&gt;
      coverage.identifier as identifier, identifier.type as typeid, typeid.coding as coding, coding.system = 'http://fhir.ch/ig/ch-orf/CodeSystem/ch-orf-cs-coverageidentifiertype', coding.code = 'MV', 
      identifier.value = (item.answer.value),
      coverage.payor as payor, payor.reference as refcontained, refcontained.value = '#org', 
      coverage.contained = create('Organization') as organization, organization.id = 'org', organization.name = 'MV' &quot;coverage.mv.versichertennummer&quot;;
   } &quot;coveragemv&quot;;
      
   // coverage.self	Selbstzahler	0..1	group		Definition: Coverage.type
   // coverage.self.familyName	Name	0..1	string		Definition: Coverage.payor
   // coverage.self.givenName	Vorname	0..1	string		Definition: Coverage.payor
   src.item as item where where (linkId.value = 'coverage.self') then {
      
      item.item as item where (linkId.value = 'coverage.self.patient' and answer.exists() and answer.value) -&gt;
         bundle.entry as e4, 
         e4.resource = create('Coverage') as coverage, 
         coverage.id = uuid() as uuid4,
         e4.fullUrl = ('urn:uuid:'+%uuid4),
         serviceRequest.insurance as insurance, insurance.reference = ('urn:uuid:'+%uuid4),
         coverage.status = 'active',
         coverage.beneficiary = create('Reference') as subject, subject.reference = ('urn:uuid:'+%patient.id),
         coverage.type as type, type.coding as coding, coding.system = 'http://fhir.ch/ig/ch-orf/CodeSystem/ch-orf-cs-coveragetype', coding.code = 'Self',
         coverage.payor  as subject, subject.reference = ('urn:uuid:'+%patient.id) &quot;payor&quot;;

      item.item as item2 where (linkId.value = 'coverage.self.patientRelatedPerson' and answer.exists() and answer.value) then {        
            item.item as item where (linkId.value = 'coverage.self.relatedPerson') -&gt;
            bundle.entry as e5, 
            e5.resource = create('Coverage') as coverage, 
            coverage.id = uuid() as uuid4,
            e5.fullUrl = ('urn:uuid:'+%uuid4),
            serviceRequest.insurance as insurance, insurance.reference = ('urn:uuid:'+%uuid4),
            coverage.status = 'active',
            coverage.beneficiary = create('Reference') as subject, subject.reference = ('urn:uuid:'+%patient.id),
            coverage.type as type, type.coding as coding, coding.system = 'http://fhir.ch/ig/ch-orf/CodeSystem/ch-orf-cs-coveragetype', coding.code = 'Self',
            bundle.entry as e6, 
            e6.resource = create('RelatedPerson') as relatedPerson, 
            relatedPerson.id = uuid() as uuid6,
            e6.fullUrl = append('urn:uuid:',uuid6),
            coverage.payor as subject, subject.reference = ('urn:uuid:'+%relatedPerson.id),
            relatedPerson.patient as reference, reference.reference = ('urn:uuid:'+%patient.id)
            then 
              CoverageRelatedPersonItems(item,relatedPerson) &quot;coverage.self.relatedPerson&quot;;
      } &quot;coverage.self.patientrelated.&quot;;
   } &quot;self&quot;;
 
// coverage.other	Anderer Kostenträger	0..1	group		Definition: Coverage.type
// coverage.other.name	Name des Kostenträgers	0..1	string		Definition: Coverage.payor
// coverage.other.id	Beliebige ID	0..1	string		Definition: Coverage.identifier
// coverage.other.id.note TODO
   src.item as item where where (linkId.value = 'coverage.other') -&gt; bundle.entry as e4, 
   e4.resource = create('Coverage') as coverage, 
   coverage.id = uuid() as uuid4,
   e4.fullUrl = ('urn:uuid:'+%uuid4),
   serviceRequest.insurance as insurance, insurance.reference = ('urn:uuid:'+%uuid4),
   coverage.status = 'active',
   coverage.beneficiary = create('Reference') as subject, subject.reference = ('urn:uuid:'+%patient.id),
   coverage.type as type, type.coding as coding, coding.system = 'http://fhir.ch/ig/ch-orf/CodeSystem/ch-orf-cs-coveragetype', coding.code = 'Other' then {
      item.item as item where (linkId.value = 'coverage.other.name' and answer.exists()) -&gt;
      coverage.payor as payor, payor.reference as refcontained, refcontained.value = '#org', 
      coverage.contained = create('Organization') as organization, organization.id = 'org', organization.name = (item.answer.value) &quot;coverage.other.name&quot;;
      item.item as item where (linkId.value = 'coverage.other.id' and answer.exists()) -&gt;
      coverage.identifier as identifier, identifier.value = (item.answer.value) &quot;coverage.other.id&quot;;
   } &quot;coveragevvg&quot;;
}

group CoverageRelatedPersonItems(source src : BackboneElement, target relatedPerson: RelatedPerson) {
   src.item as item where (linkId.value = 'coverage.self.relatedPerson.familyName' and answer.exists()) -&gt; relatedPerson.name as name share name, name.family = (item.answer.value);
   src.item as item where (linkId.value = 'coverage.self.relatedPerson.givenName' and answer.exists()) -&gt; relatedPerson.name as name share name, name.given = (item.answer.value);
   src.item as item where (linkId.value = 'coverage.self.relatedPerson.phone' and answer.exists()) then {
      item.answer as answer -&gt; relatedPerson.telecom as value, value.system = 'phone',
                                value.value= (answer.value) &quot;coverage.self.relatedPerson.phone&quot;; 
   } &quot;phone&quot;;
   src.item as item where (linkId.value = 'coverage.self.relatedPerson.email' and answer.exists()) -&gt; relatedPerson.telecom as value, 
                                                                                   value.system = 'email',
                                                                                   value.value=(item.answer.value) &quot;coverage.self.relatedPerson.email&quot;; 
   src.item as item where (linkId.value = 'coverage.self.relatedPerson.streetAddressLine' and answer.exists()) -&gt; relatedPerson.address as address share orgAddress then {
     item.answer as answer -&gt; address.line = (answer.value) &quot;coverage.self.relatedPerson.streetAddressLine&quot;;
   } &quot;item.answer&quot;;
   src.item as item where (linkId.value = 'coverage.self.relatedPerson.postalCode' and answer.exists()) -&gt; relatedPerson.address as address share orgAddress, address.postalCode = (item.answer.value) &quot;coverage.self.relatedPerson.postalCode&quot;;
   src.item as item where (linkId.value = 'coverage.self.relatedPerson.city' and answer.exists()) -&gt; relatedPerson.address as address share orgAddress, address.city = (item.answer.value) &quot;coverage.self.relatedPerson.city&quot;;
   src.item as item where (linkId.value = 'coverage.self.relatedPerson.country' and answer.exists()) -&gt; relatedPerson.address as address share orgAddress, address.country = (item.answer.value) &quot;coverage.self.relatedPerson.country&quot;;
}


group SenderAuthorPractitionerItems(source src : BackboneElement, target practitioner: Practitioner) {
   src.item as item where (linkId.value = 'sender.author.practitioner.familyName' and answer.exists()) -&gt; practitioner.name as name share practitionerName, name.family = (item.answer.value);
   src.item as item where (linkId.value = 'sender.author.practitioner.givenName' and answer.exists()) -&gt; practitioner.name as name share practitionerName, name.given = (item.answer.value);
   src.item as item where (linkId.value = 'sender.author.practitioner.title' and answer.exists()) -&gt; practitioner.name as name share practitionerName, 
                                                                        name.prefix = (item.answer.value) as prefix,
                                                                        prefix.extension as ext, ext.url = 'http://hl7.org/fhir/StructureDefinition/iso21090-EN-qualifier',
                                                                        ext.value = create('code') as value, value.value='AC' &quot;sender.author.practitioner.title&quot;; 
   src.item as item where (linkId.value = 'sender.author.practitioner.gln' and answer.exists()) -&gt; practitioner.identifier as value, 
                                                                                   value.system = 'urn:oid:2.51.1.3',
                                                                                   value.value=(item.answer.value) &quot;sender.author.practitioner.gln&quot;; 
   src.item as item where (linkId.value = 'sender.author.practitioner.zsr' and answer.exists()) -&gt; practitioner.identifier as value, 
                                                                                   value.system = 'urn:oid:2.16.756.5.30.1.123.100.2.1.1',
                                                                                   value.value=(item.answer.value) &quot;recsender.author.practitioner.zsr&quot;; 
   src.item as item where (linkId.value = 'sender.author.practitioner.phone' and answer.exists()) -&gt; practitioner.telecom as value, 
                                                                                   value.system = 'phone',
                                                                                   value.value=(item.answer.value) &quot;sender.author.practitioner.phone&quot;; 
   src.item as item where (linkId.value = 'sender.author.practitioner.email' and answer.exists()) -&gt; practitioner.telecom as value, 
                                                                                   value.system = 'email',
                                                                                   value.value=(item.answer.value) &quot;sender.author.practitioner.email&quot;; 
}

group SenderAuthorOrganizationItems(source src : BackboneElement, target organization: Organization) {
   src.item as item where (linkId.value = 'sender.author.organization.name' and answer.exists()) -&gt; organization.name = (item.answer.value);
   src.item as item where (linkId.value = 'sender.author.organization.gln' and answer.exists()) -&gt; organization.identifier as value, 
                                                                                   value.system = 'urn:oid:2.51.1.3',
                                                                                   value.value=(item.answer.value) &quot;sender.author.organization.gln&quot;;
   src.item as item where (linkId.value = 'sender.author.organization.zsr' and answer.exists()) -&gt; organization.identifier as value, 
                                                                                   value.system = 'urn:oid:2.16.756.5.30.1.123.100.2.1.1',
                                                                                   value.value=(item.answer.value) &quot;sender.author.organization.zsr&quot;; 
   src.item as item where (linkId.value = 'sender.author.organization.streetAddressLine' and answer.exists()) -&gt; organization.address as address share orgAddress then {
     item.answer as answer -&gt; address.line = (answer.value) &quot;sender.author.organization.streetAddressLine&quot;;
   } &quot;item.answer&quot;;
   src.item as item where (linkId.value = 'sender.author.organization.postalCode' and answer.exists()) -&gt; organization.address as address share orgAddress, address.postalCode = (item.answer.value) &quot;sender.author.organization.postalCode&quot;;
   src.item as item where (linkId.value = 'sender.author.organization.city' and answer.exists()) -&gt; organization.address as address share orgAddress, address.city = (item.answer.value) &quot;sender.author.organization.city&quot;;
   src.item as item where (linkId.value = 'sender.author.organization.country' and answer.exists()) -&gt; organization.address as address share orgAddress, address.country = (item.answer.value) &quot;sender.author.organization.country&quot;;
}

group SenderAuthorItems(source src : BackboneElement, target practitionerRole: practitionerRole, target practitioner : Practitioner, target organization: Organization) {
   src.item as item where (linkId.value = 'sender.author.practitioner') then SenderAuthorPractitionerItems(item, practitioner);
   src.item as item where (linkId.value = 'sender.author.organization') then SenderAuthorOrganizationItems(item, organization);
}

group SenderDataEntererPractitionerItems(source src : BackboneElement, target practitioner: Practitioner) {
   src.item as item where (linkId.value = 'sender.dataenterer.practitioner.familyName' and answer.exists()) -&gt; practitioner.name as name share practitionerName, name.family = (item.answer.value);
   src.item as item where (linkId.value = 'sender.dataenterer.practitioner.givenName' and answer.exists()) -&gt; practitioner.name as name share practitionerName, name.given = (item.answer.value);
   src.item as item where (linkId.value = 'sender.dataenterer.practitioner.phone' and answer.exists()) -&gt; practitioner.telecom as value, 
                                                                                   value.system = 'phone',
                                                                                   value.value=(item.answer.value) &quot;sender.author.practitioner.phone&quot;; 
   src.item as item where (linkId.value = 'sender.dataenterer.practitioner.email' and answer.exists()) -&gt; practitioner.telecom as value, 
                                                                                   value.system = 'email',
                                                                                   value.value=(item.answer.value) &quot;sender.author.practitioner.email&quot;; 
}

group SenderDataEntererItems(source src : BackboneElement, target practitionerRole: practitionerRole, target practitioner : Practitioner, target organization: Organization) {
   src.item as item where (linkId.value = 'sender.dataenterer.practitioner') then SenderDataEntererPractitionerItems(item, practitioner);
}

group ChExtEprDataEnterer(source src: BackboneElement, target practitionerRole: PractitionerRole, target ext: Extension) {
  src -&gt; ext.url = 'http://fhir.ch/ig/ch-core/StructureDefinition/ch-ext-epr-dataenterer' &quot;url&quot;;
  src -&gt; ext.extension as ext, ext.url='enterer', ext.value = create('Reference') as reference, 
                 reference.reference = ('urn:uuid:'+%practitionerRole.id) &quot;practitionerRole&quot;;
}

group SenderAuthorInit(source src : BackboneElement, target bundle: Bundle, target composition : Composition, target serviceRequest: ServiceRequest) {
   src -&gt; bundle.entry as e, 
          e.resource = create('PractitionerRole') as practitionerRole, 
          practitionerRole.id = uuid() as uuid,
          e.fullUrl = append('urn:uuid:',uuid),
          bundle.entry as e2, 
          e2.resource = create('Practitioner') as practitioner, 
          practitioner.id = uuid() as uuid2,
          e2.fullUrl = append('urn:uuid:',uuid2),
          bundle.entry as e3, 
          e3.resource = create('Organization') as organization, 
          organization.id = uuid() as uuid3,
          e3.fullUrl = append('urn:uuid:',uuid3),
          composition.author = create('Reference') as reference, reference.reference = append('urn:uuid:',uuid),
          serviceRequest.requester = create('Reference') as reference, reference.reference = append('urn:uuid:',uuid),
          practitionerRole.practitioner = create('Reference') as reference, reference.reference = append('urn:uuid:',uuid2),
          practitionerRole.organization = create('Reference') as reference, reference.reference = append('urn:uuid:',uuid3) then {
             src.item as item where (linkId.value = 'sender.author') then SenderAuthorItems(item, practitionerRole, practitioner, organization) &quot;sender.author&quot;;
             src.item as item where (linkId.value = 'sender.dataenterer') then {
               item -&gt; bundle.entry as e4, 
                      e4.resource = create('PractitionerRole') as practitionerRoleDataEnterer, 
                      practitionerRoleDataEnterer.id = uuid() as uuid4,
                      e4.fullUrl = append('urn:uuid:',uuid4),
                      composition.extension as extension,
                      bundle.entry as e5, 
                      e5.resource = create('Practitioner') as practitionerDataEnterer, 
                      practitionerDataEnterer.id = uuid() as uuid5,
                      e5.fullUrl = append('urn:uuid:',uuid5),
                      practitionerRoleDataEnterer.practitioner = create('Reference') as reference, reference.reference = append('urn:uuid:',uuid5),
                      practitionerRoleDataEnterer.organization = create('Reference') as reference, reference.reference = append('urn:uuid:',uuid3) 
                      then {
                            item then SenderDataEntererItems(item, practitionerRoleDataEnterer, practitionerDataEnterer, organization) &quot;data&quot;;
                            item then ChExtEprDataEnterer(item, practitionerRoleDataEnterer, extension) &quot;extension&quot;;
                         } &quot;sender.dataenterer.items&quot;;
             } &quot;sender.dataenterer&quot;;
          } &quot;sender&quot;;
}

group ReceiverCopyRelatedPersonItems(source src : BackboneElement, target relatedPerson: RelatedPerson) {
   src.item as item where (linkId.value = 'receiverCopy.relatedPerson.familyName' and answer.exists()) -&gt; relatedPerson.name as name share name, name.family = (item.answer.value);
   src.item as item where (linkId.value = 'receiverCopy.relatedPerson.givenName' and answer.exists()) -&gt; relatedPerson.name as name share name, name.given = (item.answer.value);
   src.item as item where (linkId.value = 'receiverCopy.relatedPerson.phone' and answer.exists()) then {
      item.answer as answer -&gt; relatedPerson.telecom as value, value.system = 'phone',
                                value.value= (answer.value) &quot;receiverCopy.relatedPerson.phone&quot;; 
   } &quot;phone&quot;;
   src.item as item where (linkId.value = 'receiverCopy.relatedPerson.email' and answer.exists()) -&gt; relatedPerson.telecom as value, 
                                                                                   value.system = 'email',
                                                                                   value.value=(item.answer.value) &quot;receiverCopy.relatedPerson.email&quot;; 
   src.item as item where (linkId.value = 'receiverCopy.relatedPerson.streetAddressLine' and answer.exists()) -&gt; relatedPerson.address as address share orgAddress then {
     item.answer as answer -&gt; address.line = (answer.value) &quot;receiverCopy.relatedPerson.streetAddressLine&quot;;
   } &quot;item.answer&quot;;
   src.item as item where (linkId.value = 'receiverCopy.relatedPerson.postalCode' and answer.exists()) -&gt; relatedPerson.address as address share orgAddress, address.postalCode = (item.answer.value) &quot;receiverCopy.relatedPerson.postalCode&quot;;
   src.item as item where (linkId.value = 'receiverCopy.relatedPerson.city' and answer.exists()) -&gt; relatedPerson.address as address share orgAddress, address.city = (item.answer.value) &quot;receiverCopy.relatedPerson.city&quot;;
   src.item as item where (linkId.value = 'receiverCopy.relatedPerson.country' and answer.exists()) -&gt; relatedPerson.address as address share orgAddress, address.country = (item.answer.value) &quot;receiverCopy.relatedPerson.country&quot;;
}

group ReceiverCopyPractitionerItems(source src : BackboneElement, target practitioner : Practitioner) {
   src.item as item where (linkId.value = 'receiverCopy.practitionerRole.practitioner.familyName' and answer.exists()) -&gt; practitioner.name as name share practitionerName, name.family = (item.answer.value);
   src.item as item where (linkId.value = 'receiverCopy.practitionerRole.practitioner.givenName' and answer.exists()) -&gt; practitioner.name as name share practitionerName, name.given = (item.answer.value);
   src.item as item where (linkId.value = 'receiverCopy.practitionerRole.practitioner.title' and answer.exists()) -&gt; practitioner.name as name share practitionerName, 
                                                                        name.prefix = (item.answer.value) as prefix,
                                                                        prefix.extension as ext, ext.url = 'http://hl7.org/fhir/StructureDefinition/iso21090-EN-qualifier',
                                                                        ext.value = create('code') as value, value.value='AC' &quot;receiverCopy.practitionerRole.practitioner.title&quot;; 
   src.item as item where (linkId.value = 'receiverCopy.practitionerRole.practitioner.phone' and answer.exists()) -&gt; practitioner.telecom as value, 
                                                                                   value.system = 'phone',
                                                                                   value.value=(item.answer.value) &quot;receiverCopy.practitionerRole.practitioner.phone&quot;; 
   src.item as item where (linkId.value = 'receiverCopy.practitionerRole.practitioner.email' and answer.exists()) -&gt; practitioner.telecom as value, 
                                                                                   value.system = 'email',
                                                                                   value.value=(item.answer.value) &quot;receiverCopy.practitionerRole.practitioner.email&quot;; 
}

group ReceiverCopyOrganizationItems(source src : BackboneElement, target organization : Organization) {
   src.item as item where (linkId.value = 'receiverCopy.practitionerRole.organization.name' and answer.exists()) -&gt; organization.name = (item.answer.value);
   src.item as item where (linkId.value = 'receiverCopy.practitionerRole.organization.streetAddressLine' and answer.exists()) -&gt; organization.address as address share orgAddress then {
     item.answer as answer -&gt; address.line = (answer.value) &quot;receiverCopy.practitionerRole.organization.streetAddressLine&quot;;
   } &quot;item.answer&quot;;
   src.item as item where (linkId.value = 'receiverCopy.practitionerRole.organization.postalCode' and answer.exists()) -&gt; organization.address as address share orgAddress, address.postalCode = (item.answer.value) &quot;receiverCopy.practitionerRole.organization.postalCode&quot;;
   src.item as item where (linkId.value = 'receiverCopy.practitionerRole.organization.city' and answer.exists()) -&gt; organization.address as address share orgAddress, address.city = (item.answer.value) &quot;receiverCopy.practitionerRole.organization.city&quot;;
   src.item as item where (linkId.value = 'receiverCopy.practitionerRole.organization.country' and answer.exists()) -&gt; organization.address as address share orgAddress, address.country = (item.answer.value) &quot;receiverCopy.practitionerRole.organization.country&quot;;
}

group ReceiverCopyPractitionerRoleItems(source src : BackboneElement, target bundle: Bundle, target practitionerRole: practitionerRole) {
   src.item as item where (linkId.value = 'receiverCopy.practitionerRole.practitioner') -&gt; 
      bundle.entry as e2, 
      e2.resource = create('Practitioner') as practitioner, 
      practitioner.id = uuid() as uuid2,
      practitionerRole.practitioner = create('Reference') as reference, reference.reference = append('urn:uuid:',uuid2),
      e2.fullUrl = append('urn:uuid:',uuid2) then ReceiverCopyPractitionerItems(item, practitioner);
   src.item as item where (linkId.value = 'receiverCopy.practitionerRole.organization') -&gt;
     bundle.entry as e3, 
     e3.resource = create('Organization') as organization, 
     organization.id = uuid() as uuid3,
     practitionerRole.organization = create('Reference') as reference, reference.reference = append('urn:uuid:',uuid3), 
     e3.fullUrl = append('urn:uuid:',uuid3) then ReceiverCopyOrganizationItems(item, organization);
}

group ExtOrfCopyReceiverPatient(source src: BackboneElement, target patient: Patient, target ext: Extension) {
  src -&gt; ext.url = 'http://fhir.ch/ig/ch-orf/StructureDefinition/ch-orf-copyreceiver' &quot;url&quot;;
  src -&gt; ext.value = create('Reference') as reference, 
                reference.reference = ('urn:uuid:'+%patient.id) &quot;patient&quot;;
}

group ExtOrfCopyReceiver(source src: BackboneElement, target res, target ext: Extension) {
  src -&gt; ext.url = 'http://fhir.ch/ig/ch-orf/StructureDefinition/ch-orf-copyreceiver' &quot;url&quot;;
  src -&gt; ext.value = create('Reference') as reference, 
                reference.reference = ('urn:uuid:'+%res.id) &quot;organization&quot;;
}

group ReceiverCopy(source grp : BackboneElement, target bundle: Bundle, target patient: Patient, target composition : Composition, target serviceRequest: ServiceRequest) {
  grp.item as item where (linkId='receiverCopy.practitionerRole') -&gt; bundle.entry as e4, 
            e4.resource = create('PractitionerRole') as practitionerrole, 
            composition.extension as extension,
            practitionerrole.id = uuid() as uuid4,
            e4.fullUrl = append('urn:uuid:',uuid4) then {
               item then ReceiverCopyPractitionerRoleItems(item, bundle, practitionerrole) &quot;data&quot;;
               item then ExtOrfCopyReceiver(item, practitionerrole, extension) &quot;extension&quot;;
            } &quot;receiverCopyPractitionerRole1&quot;;
   grp.item as item where (linkId='receiverCopy.patient') -&gt;  
            composition.extension as extension then {
               item then ExtOrfCopyReceiver(item, patient, extension) &quot;extension&quot;;
            } &quot;receiverCopyPractitionerRole2&quot;;
   grp.item as item where (linkId='receiverCopy.relatedPerson') -&gt; bundle.entry as e4, 
            e4.resource = create('RelatedPerson') as relatedPerson, 
            composition.extension as extension,
            relatedPerson.id = uuid() as uuid4,
            relatedPerson.patient as reference,
            reference.reference = ('urn:uuid:'+%patient.id),
            e4.fullUrl = append('urn:uuid:',uuid4) then {
               item then ReceiverCopyRelatedPersonItems(item, relatedPerson) &quot;data&quot;;
               item then ExtOrfCopyReceiver(item, relatedPerson, extension) &quot;extension&quot;;
            } &quot;receiverCopyPractitionerRole3&quot;;
}

group Appointment(source grp : BackboneElement, target bundle: Bundle, target composition : Composition, target serviceRequest: ServiceRequest) {
   grp.item -&gt; bundle.entry as e4, 
   e4.resource = create('Appointment') as appointment, 
   appointment.id = uuid() as uuid4,
   e4.fullUrl = ('urn:uuid:'+%uuid4),
   serviceRequest.extension as extension,
   extension.url = 'http://fhir.ch/ig/ch-orf/StructureDefinition/ch-orf-locationandtime',
   extension.value = create('Reference') as reference, reference.reference = ('urn:uuid:'+%uuid4)                
   then {
      grp.item as item where (linkId.value = 'appointment.status' and answer.value.code='proposed') -&gt; appointment.status = (item.answer.value.code) then {
         grp.item as itemp where (linkId.value = 'appointment.requestedPeriod') then {
           itemp.item as item2 where (linkId.value = 'appointment.requestedPeriod.start' and answer.exists()) -&gt; appointment.requestedPeriod as requestedPeriod, requestedPeriod.start = (item2.answer.value), requestedPeriod.end = (item2.answer.value) then {
           itemp.item as item3 where (linkId.value = 'appointment.requestedPeriod.end' and answer.exists()) -&gt; requestedPeriod.end = (item3.answer.value) &quot;appointment.requestedPeriod.end.if.not.same.as.start&quot;;
           } &quot;appointment.requestedPeriod.start&quot;;
         } &quot;appointment.requestedPeriod&quot;;
      } &quot;proposed&quot;;
      grp.item as item where (linkId.value = 'appointment.status' and (answer.value.code='pending' or answer.value.code='booked')) -&gt; appointment.status = (item.answer.value.code) then {
         grp.item as itemp where (linkId.value = 'appointment.requestedPeriod') then {
           itemp.item as item2 where (linkId.value = 'appointment.requestedPeriod.start' and answer.exists()) -&gt; appointment.start = (item2.answer.value), appointment.end = (item2.answer.value) then {
           itemp.item as item3 where (linkId.value = 'appointment.requestedPeriod.end' and answer.exists()) -&gt; appointment.end = (item3.answer.value) &quot;appointment.end.if.not.same.as.start&quot;;
           } &quot;appointment.start&quot;;
         } &quot;appointment.startend&quot;;
      } &quot;pendingorbooked&quot;;
      grp.item as item where (linkId.value = 'appointment.patientInstruction' and answer.exists()) -&gt; appointment.patientInstruction = (item.answer.value) &quot;appointment.patientInstruction&quot;;
      grp.item as item where (linkId.value = 'appointment.location') then {
         item -&gt; bundle.entry as e5, 
         e5.resource = create('Location') as location, 
         location.id = uuid() as uuid5,
         e5.fullUrl = ('urn:uuid:'+%uuid5),
         appointment.participant as participant, participant.status = 'tentative', participant.actor = create('Reference') as actor, actor.reference = ('urn:uuid:'+%location.id) then {
            item.item as item3 where (linkId.value = 'appointment.location.name' and answer.exists()) -&gt; location.name = (item3.answer.value);
            item.item as item3 where (linkId.value = 'appointment.location.phone' and answer.exists()) -&gt; location.telecom as value, value.system = 'phone', value.value=(item3.answer.value) &quot;appointment.location.phone&quot;; 
            item.item as item3 where (linkId.value = 'appointment.location.email' and answer.exists()) -&gt; location.telecom as value, value.system = 'email', value.value=(item3.answer.value) &quot;appointment.location.email&quot;; 
            item.item as item3 where (linkId.value = 'appointment.location.streetAddressLine' and answer.exists()) -&gt; location.address as address share orgAddress then {
               item.answer as answer -&gt; address.line = (answer.value) &quot;line&quot;;
            } &quot;appointment.location.streetAddressLine&quot;;
            item.item as item3 where (linkId.value = 'appointment.location.postalCode' and answer.exists()) -&gt; location.address as address share orgAddress, address.postalCode = (item3.answer.value) &quot;appointment.location.postalCode&quot;;
            item.item as item3 where (linkId.value = 'appointment.location.city' and answer.exists()) -&gt; location.address as address share orgAddress, address.city = (item3.answer.value) &quot;appointment.location.city&quot;;
            item.item as item3 where (linkId.value = 'appointment.location.country' and answer.exists()) -&gt; location.address as address share orgAddress, address.country = (item3.answer.value) &quot;appointment.location.country&quot;;
         } &quot;location&quot;;
      } &quot;appointment.location&quot;;
   } &quot;Appointment&quot;;
}

group PreviousResults(source grp : BackboneElement, target bundle: Bundle, target serviceRequest: ServiceRequest) {
   grp.item as item where (linkId='previousResults.attachment' and answer.exists()) then {
      item.answer as answer then {
         answer.value: Attachment as attachment -&gt; 
            bundle.entry as e, 
            e.resource = create('Media') as media, 
            media.id = uuid() as uuid,
            media.status = 'completed',
            e.fullUrl = append('urn:uuid:',uuid), 
            media.content = attachment,
            serviceRequest.supportingInfo as supportingInfo,
            supportingInfo.reference = ('urn:uuid:'+uuid)
            &quot;media&quot;; 
      } &quot;answer&quot;;
   } &quot;item&quot;;
}

group Note(source grp : BackboneElement, target serviceRequest: ServiceRequest) {
   grp.item as item where (linkId='note.text' and answer.exists()) -&gt; serviceRequest.note as note, note.text = (item.answer.value) &quot;note.text&quot;;
}

group QrToBundle(source qr : QuestionnaireResponse, target q: Questionnaire, target patient : Patient, target questionnaireresp: QuestionnaireResponseTarget, target servicerequest: ServiceRequest, target composition : Composition, target bundle : Bundle) {
  qr -&gt; bundle.id = uuid() &quot;id&quot;;
  qr -&gt; bundle.type = 'document' &quot;type&quot;;
  qr then OrfComposition(qr, q, composition, patient, questionnaireresp, servicerequest, bundle) &quot;composition&quot;;
  qr then QrToGroups(qr, patient, bundle, composition, servicerequest) &quot;qrgroups&quot;;
}

group OrfComposition(source qr : QuestionnaireResponse, target q: Questionnaire, target tgt : Composition, target patient: Patient, target questionnaireresp: QuestionnaireResponseTarget, target servicerequest: ServiceRequest, target bundle : Bundle) {
  qr -&gt; tgt.status = 'final' &quot;status&quot;;
  qr -&gt; tgt.subject = create('Reference') as reference, reference.reference = ('urn:uuid:'+%patient.id) &quot;subject&quot;;
  qr -&gt; tgt.section as tgtSection, 
     tgtSection.title = 'Order-Referral', 
     tgtSection.code as code, code.coding as coding, coding.system='http://loinc.org', coding.code='93037-0', coding.display='Portable medical order form',
     tgtSection.entry = create('Reference') as reference, reference.reference = ('urn:uuid:'+%questionnaireresp.id),
     tgtSection.entry = create('Reference') as reference, reference.reference = ('urn:uuid:'+%servicerequest.id),
     tgtSection.entry = create('Reference') as reference, reference.reference = ('urn:uuid:'+%q.id) &quot;sections&quot;;
  qr -&gt; servicerequest.status = 'active',
      servicerequest.intent = 'order',
      servicerequest.subject = create('Reference') as reference, reference.reference = ('urn:uuid:'+%patient.id) &quot;servicerequest&quot;;
}</pre>
    </div>

  <!-- insert notes if present -->
  



  

</div>
        </div>  <!-- /inner-wrapper -->
      </div>  <!-- /row -->
    </div>  <!-- /container -->
  </div>  <!-- /segment-content -->

  <script type="text/javascript" src="assets/js/jquery.js"> </script>     <!-- note keep space here, otherwise it will be transformed to empty tag -> fails -->
  <script type="text/javascript" src="assets/js/jquery-ui.min.js"> </script>

  <script type="text/javascript">
    $(document).ready(function(){
      if(window.location.hash != "") {
          $('a[href="' + window.location.hash + '"]').click()
      }
    });
  </script>
  <a name="bottom"> </a>
  <div id="segment-footer" igtool="footer" class="segment">  <!-- segment-footer -->
    <div class="container">  <!-- container -->

      <div class="inner-wrapper">
        <p>
          IG &#169; 2020+ <a style="color:var(--footer-hyperlink-text-color)" href="https://www.hl7.ch/">HL7 Switzerland</a>.  Package ch.fhir.ig.ch-orf#2.0.0-ballot based on <a style="color: var(--footer-hyperlink-text-color)" href="http://hl7.org/fhir/R4/">FHIR 4.0.1</a>. Generated <span title="Thu, Jun 29, 2023 21:20+0200">2023-06-29</span>
          <br/>
          <span style="color: var(--footer-highlight-text-color)">
                      Links: <a style="color: var(--footer-hyperlink-text-color)" href="toc.html">Table of Contents</a> |
                 <a style="color: var(--footer-hyperlink-text-color)" href="qa.html">QA Report</a>
                 
                

| <a style="color: #81BEF7" target="_blank" href="https://docs.google.com/forms/d/e/1FAIpQLSeT-tq5cutjuiVEedqihlMZ56_4UJsdVH6aTGYHTmO34T1Z4g/viewform?usp=sf_link&amp;entry%2E1353807103=ch.fhir.ig.ch-orf%232.0.0-ballot%20/StructureMap-OrfQrToBundle.html&amp;entry%2E247644557=Map%20ORF">Propose a change</a>

          </span>
        </p>
      </div>  <!-- /inner-wrapper -->
    </div>  <!-- /container -->
  </div>  <!-- /segment-footer -->
  
  <div id="segment-post-footer" class="segment hidden">  <!-- segment-post-footer -->
    <div class="container">  <!-- container -->
    </div>  <!-- /container -->
  </div>  <!-- /segment-post-footer -->
  
  <!-- JS and analytics only. -->
  <!-- Bootstrap core JavaScript
  ================================================== -->
  <!-- Placed at the end of the document so the pages load faster -->
  <script type="text/javascript" src="assets/js/bootstrap.min.js"> </script>
  <script type="text/javascript" src="assets/js/respond.min.js"> </script>
  <script type="text/javascript" src="assets/js/anchor.min.js"> </script>
  <script type="text/javascript" src="assets/js/clipboard.min.js"> </script>
  <script type="text/javascript" src="assets/js/clipboard-btn.js"> </script>
  <script>anchors.options.visible = 'hover'
anchors.add()</script>
  
<!-- feedback form - Google forms -->
<!-- v0.1, 2021-01-09 -->


  


  



<!-- / feedback form  -->

  <!-- Analytics Below
  ================================================== -->
  </body>
</html>

