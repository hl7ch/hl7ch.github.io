<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE HTML>
<html xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type"/>
    <title>CH.FHIR.IG.CH-EPR-MHEALTH\Get Access Token [ITI-71] - FHIR v4.0.1</title>

    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta name="author" content="http://hl7.org/fhir"/>

    <link href="fhir.css" rel="stylesheet"/>

    <!-- Bootstrap core CSS -->
    <link href="assets/css/bootstrap-fhir.css" rel="stylesheet"/>

    <!-- Project extras -->
    <link href="assets/css/project.css" rel="stylesheet"/>
    <link href="assets/css/pygments-manni.css" rel="stylesheet"/>
    <link href="assets/css/jquery-ui.css" rel="stylesheet"/>
  	<link href="assets/css/prism.css" rel="stylesheet" />
    <!-- Placeholder for child template CSS declarations -->
    <link href="assets/css/hl7.css" rel="stylesheet"/>
    <link href="assets/css/fhir.css" rel="stylesheet"/>

    <script type="text/javascript" src="fhir-table-scripts.js"> </script>

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="assets/js/html5shiv.js"></script>
    <script src="assets/js/respond.min.js"></script>
    <![endif]-->

    <!-- Favicons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="assets/ico/apple-touch-icon-144-precomposed.png"/>
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="assets/ico/apple-touch-icon-114-precomposed.png"/>
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="assets/ico/apple-touch-icon-72-precomposed.png"/>
    <link rel="apple-touch-icon-precomposed" href="assets/ico/apple-touch-icon-57-precomposed.png"/>
    <link rel="shortcut icon" href="assets/ico/favicon.png"/>
  </head>
  <body onload="document.body.style.opacity='1'">

	  <script src="assets/js/prism.js"></script>

    <style type="text/css">h2{--heading-prefix:"3.1"}
    h3,h4,h5,h6{--heading-prefix:"3.1"}</style>
    <div id="segment-header" class="segment">  <!-- segment-header -->
      <div class="container">  <!-- container -->
        <!-- Placeholder for child template header declarations -->

            <!--
<div id="family-nav">
	<a id="logo" no-external="true" href="http://hl7.org/fhir"> <img
		alt="logo fhir" src="assets/images/fhir-logo-www.png" />
	</a>
</div>
-->


            <div id="hl7-nav">
    <a id="ehealthsuisse-logo" no-external="true" href="https://www.e-health-suisse.ch">
        <img alt="visit the e-health-suisse website" height="60" src="assets/images/LogoDE_ehealthsuisse.svg" />
    </a>            
</div>

        <div id="ig-status">
          <p><span style="font-size:12pt;font-weight:bold">CH EPR mHealth (R4)</span><br/>1.0.0 - DSTU 1</p>
        </div>
      </div> <!-- /container -->
    </div>  <!-- /segment-header -->

    <div id="segment-navbar" class="segment">  <!-- segment-navbar -->
      <div id="stripe"> </div>
      <div class="container">  <!-- container -->
        <!-- HEADER CONTENT -->

        <nav class="navbar navbar-inverse">
          <!--status-bar-->
          <div class="container">
            <button data-target=".navbar-inverse-collapse" class="navbar-toggle" data-toggle="collapse" type="button">
              <span class="icon-bar"> </span>
              <span class="icon-bar"> </span>
              <span class="icon-bar"> </span>
            </button>
            <a class="navbar-brand hidden" href="http://hl7.org/fhir/R4/index.html">FHIR</a>
            <div class="nav-collapse collapse navbar-inverse-collapse">
              <ul xmlns="http://www.w3.org/1999/xhtml" class="nav navbar-nav">
  <li>
    <a href="index.html">Home</a>
  </li>
  <li class="Profiles">
    <a data-toggle="dropdown" href="#" class="dropdown-toggle">Profiles<b class="caret">
      </b>
    </a>
    <ul class="dropdown-menu">
      <li>
        <a href="iti-iua.html">Internet User Authorization (IUA)</a>
      </li>
      <li>
        <a href="iti-pixm.html">Patient Identifier Cross-referencing for mobile (PIXm)</a>
      </li>
      <li>
        <a href="iti-mhd.html">Mobile Access to Health Documents (MHD) with XDS on FHIR</a>
      </li>
      <li>
        <a href="iti-restful-atna.html">RESTful ATNA</a>
      </li>
    </ul>
  </li>
  <li class="dropdown">
    <a data-toggle="dropdown" href="#" class="dropdown-toggle">Transactions<b class="caret">
      </b>
    </a>
    <ul class="dropdown-menu">
      <li>
        <a href="iti-103.html">Get Authorization Server Metadata [ITI-103]</a>
      </li>
      <li>
        <a href="iti-71.html">Get Access Token [ITI-71]</a>
      </li>
      <li>
        <a href="iti-104.html">Patient Identity Feed FHIR [ITI-104]</a>
      </li>
      <li>
        <a href="iti-83.html">Mobile Patient Identifier Cross-reference Query [ITI-83]</a>
      </li>
      <li>
        <a href="iti-65.html">Provide Document Bundle [ITI-65]</a>
      </li>
      <li>
        <a href="iti-66.html">Find Document Lists [ITI-66]</a>
      </li>
      <li>
        <a href="iti-67.html">Find Document References [ITI-67]</a>
      </li>
      <li>
        <a href="iti-68.html">Retrieve Document [ITI-68]</a>
      </li>
      <li>
        <a href="iti-20.html">Record Audit Event [ITI-20]</a>
      </li>
    </ul>
  </li>
  <li class="dropdown">
    <a data-toggle="dropdown" href="#" class="dropdown-toggle">Appendix<b class="caret">
      </b>
    </a>
    <ul class="dropdown-menu">
      <li>
        <a href="extensions.html">Extensions</a>
      </li>
      <li>
        <a href="terminology.html">Terminology</a>
      </li>
      <li>
        <a href="capstatements.html">Capability Statements</a>
      </li>
      <li>
        <a href="operations.html">Operations</a>
      </li>
      <li>
        <a href="sequencediagrams.html">Sequence diagrams</a>
      </li>
      <li>
        <a href="openissues.html">Open Issues</a>
      </li>
    </ul>
  </li>
  <li>
    <a href="artifacts.html">Artifacts</a>
  </li>
</ul>
            </div>  <!-- /.nav-collapse -->
          </div>  <!-- /.container -->
        </nav>  <!-- /.navbar -->
      <!-- /HEADER CONTENT -->
      </div>  <!-- /container -->
    </div>  <!-- /segment-navbar -->
    <!--status-bar-->

    <div id="segment-breadcrumb" class="segment">  <!-- segment-breadcrumb -->
      <div class="container">  <!-- container -->
        <ul class="breadcrumb">
          <li><a href='toc.html'><b>Table of Contents</b></a></li><li><a href='transactions.html'><b>Transactions</b></a></li><li><b>Get Access Token [ITI-71]</b></li>

        </ul>
      </div>  <!-- /container -->
    </div>  <!-- /segment-breadcrumb -->

    <a name="top"> </a>
    <div id="segment-content" class="segment">  <!-- segment-content -->
      <div class="container">  <!-- container -->
        <div class="row">
          <div class="inner-wrapper">

<style type="text/css">
h2:before{color:silver;counter-increment:section;content:var(--heading-prefix) " ";}
h3:before{color:silver;counter-increment:sub-section;content:var(--heading-prefix) "." counter(sub-section) " ";}
h4:before{color:silver;counter-increment:composite;content:var(--heading-prefix) "." counter(sub-section) "." counter(composite) " ";}
h5:before{color:silver;counter-increment:detail;content:var(--heading-prefix) "." counter(sub-section) "." counter(composite) "." counter(detail) " ";}
h6:before{color:silver;counter-increment:more-detail;content:var(--heading-prefix) "." counter(sub-section) "." counter(composite) "." counter(detail) "." counter(more-detail)" ";}
</style>
<div class="col-12">
  <!--ReleaseHeader--><p id="publish-box">This page is part of the CH EPR mHealth (R4) (v1.0.0: <a href="https://confluence.hl7.org/display/HL7/HL7+Balloting" title="Draft Standard for Trial-Use">DSTU</a> 1) based on <a href="http://hl7.org/fhir/R4">FHIR R4</a>. .  For a full list of available versions, see the <a href="http://fhir.ch/ig/ch-epr-mhealth/history.html">Directory of published versions <img src="external.png" style="text-align: baseline"></a></p><!--EndReleaseHeader-->
  <h2>Get Access Token [ITI-71]</h2>
  









    <p><!-- white space is critical inside of capture --></p>
<div class="markdown-toc">
<ul id="markdown-toc">
  <li><a href="#scope" id="markdown-toc-scope">Scope</a></li>
  <li><a href="#actor-roles" id="markdown-toc-actor-roles">Actor Roles</a></li>
  <li><a href="#referenced-standards" id="markdown-toc-referenced-standards">Referenced Standards</a></li>
  <li><a href="#messages" id="markdown-toc-messages">Messages</a></li>
  <li><a href="#trigger-events" id="markdown-toc-trigger-events">Trigger Events</a></li>
  <li><a href="#message-semantics" id="markdown-toc-message-semantics">Message Semantics</a></li>
  <li><a href="#expected-actions-iua-authorization-client" id="markdown-toc-expected-actions-iua-authorization-client">Expected Actions IUA Authorization Client</a></li>
  <li><a href="#expected-actions-iua-authorization-server" id="markdown-toc-expected-actions-iua-authorization-server">Expected Actions IUA Authorization Server</a></li>
  <li><a href="#message-example" id="markdown-toc-message-example">Message Example</a></li>
  <li><a href="#security-consideration" id="markdown-toc-security-consideration">Security Consideration</a></li>
</ul>

</div>
<p>This section describes the national extension for the Swiss EPR to the Get Access Token [ITI-71] transaction defined in the IUA profile published in the IHE IT Infrastructure Technical Framework Trial Implementation “Internet User Authorization”. In this transaction, the OAuth Authorization Code grant type option is enforced for security reasons</p>
<h3 id="scope">Scope</h3>

<p>The transaction is used by an mHealth App to pass claims to the IUA Authorization Server and to retrieve access token to be used for authorization of the apps access to write data to and retrieve data from the Swiss EPR.</p>

<p>Depending on the claims made by the mHealth App, two different flavors of access tokens are provided by the IUA Authorization Server:</p>

<ul>
  <li>Basic Access Token – IUA conformal access token authorizing access to the EPR end-points which are NOT protected by the EPR role and attribute based authorization (i.e. for the PIXm endpoints).</li>
  <li>Extended Access Token – IUA conformal access token for the EPR endpoints which are protected by the EPR role and attribute based authorization (i.e. for the MHD endpoints).</li>
</ul>

<p>An mHealth App in the SMART Standalone Launch sequence SHALL perform the transaction first to get basic access to the Swiss EPR. This requires user authentication as well as the user consent, allowing the mHealth App to access the Swiss EPR and perform transactions on behalf of the user. The IUA Authorization Server SHALL present a User Interface for the user to authenticate and provide user consent, or by validating against data stored at app registration time.</p>

<p>Once the mHealth App is authorized, it may launch other embedded mHealth Apps (or views) using the SMART EHR Launch Sequence. In this case, the embedded app inherits the basic access authorization from the launching app<sup><a href="#1">1</a></sup> and may retrieve extended access token for EPR endpoints protected by the EPR role and attribute based authorization (e.g. to retrieve documents).</p>

<p><sup id="1">1</sup>By claiming a launch indicator, the launch is indicated as a SMART EHR Launch, initiated from an app, which has already been authorized before.</p>
<h3 id="actor-roles">Actor Roles</h3>

<p><strong>Actor:</strong> IUA Authorization Client<br />
<strong>Role:</strong> Communicates launch information and claims to the IUA Authorization Server and receives JWT access token or XUA Authorization Assertion. <br />
<strong>Actor:</strong> IUA Authorization Server<br />
<strong>Role:</strong> Verifies claims and authentication information, retrieves and validates the user consent for the mHealth App to act on behalf of the user <sup><a href="#2">2</a></sup> and responds a JWT or XUA compliant access token to the IUA Authorization Client.</p>

<p><sup id="2">2</sup>E.g. by presenting a screen for the user to give consent.</p>

<h3 id="referenced-standards">Referenced Standards</h3>

<p>This national extension does not reference additional standards to the standards referenced in the Get Access Token [ITI-71] transaction of the IUA Trial Implementation.</p>
<h3 id="messages">Messages</h3>

<p>OAuth 2.1 authorization code grant flow of the of the IUA Get Access Token transaction:</p>

<div><?xml version="1.0" encoding="UTF-8" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentScriptType="application/ecmascript" contentStyleType="text/css" height="552px" preserveAspectRatio="none" style="width:939px;height:552px;" version="1.1" viewBox="0 0 939 552" width="939px" zoomAndPan="magnify"><defs><filter height="300%" id="fly8oroncbft7" width="300%" x="-1" y="-1"><feGaussianBlur result="blurOut" stdDeviation="2.0" /><feColorMatrix in="blurOut" result="blurOut2" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 .4 0" /><feOffset dx="4.0" dy="4.0" in="blurOut2" result="blurOut3" /><feBlend in="SourceGraphic" in2="blurOut3" mode="normal" /></filter></defs><g><text fill="#000000" font-family="sans-serif" font-size="18" lengthAdjust="spacing" textLength="242" x="346.5" y="30.6855">Interaction Diagram for [ITI-71]</text><rect fill="#FFFFFF" filter="url(#fly8oroncbft7)" height="306.2188" style="stroke:#000000;stroke-width:2.0;" width="916" x="9" y="143.25" /><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="62" x2="62" y1="126.25" y2="466.4688" /><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="134" x2="134" y1="126.25" y2="466.4688" /><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="532" x2="532" y1="126.25" y2="466.4688" /><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:5.0,5.0;" x1="842" x2="842" y1="126.25" y2="466.4688" /><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="29" x="45" y="123.1738">User</text><ellipse cx="62.5" cy="51.6406" fill="#FEFECE" filter="url(#fly8oroncbft7)" rx="8" ry="8" style="stroke:#A80036;stroke-width:2.0;" /><path d="M62.5,59.6406 L62.5,86.6406 M49.5,67.6406 L75.5,67.6406 M62.5,86.6406 L49.5,101.6406 M62.5,86.6406 L75.5,101.6406 " fill="none" filter="url(#fly8oroncbft7)" style="stroke:#A80036;stroke-width:2.0;" /><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="29" x="45" y="480.002">User</text><ellipse cx="62.5" cy="493.0781" fill="#FEFECE" filter="url(#fly8oroncbft7)" rx="8" ry="8" style="stroke:#A80036;stroke-width:2.0;" /><path d="M62.5,501.0781 L62.5,528.0781 M49.5,509.0781 L75.5,509.0781 M62.5,528.0781 L49.5,543.0781 M62.5,528.0781 L75.5,543.0781 " fill="none" filter="url(#fly8oroncbft7)" style="stroke:#A80036;stroke-width:2.0;" /><rect fill="#FEFECE" filter="url(#fly8oroncbft7)" height="31.6094" style="stroke:#A80036;stroke-width:1.5;" width="84" x="90" y="89.6406" /><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="70" x="97" y="111.1738">User Agent</text><rect fill="#FEFECE" filter="url(#fly8oroncbft7)" height="31.6094" style="stroke:#A80036;stroke-width:1.5;" width="84" x="90" y="465.4688" /><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="70" x="97" y="487.002">User Agent</text><rect fill="#FEFECE" filter="url(#fly8oroncbft7)" height="31.6094" style="stroke:#A80036;stroke-width:1.5;" width="136" x="462" y="89.6406" /><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="122" x="469" y="111.1738">Authorization Client</text><rect fill="#FEFECE" filter="url(#fly8oroncbft7)" height="31.6094" style="stroke:#A80036;stroke-width:1.5;" width="136" x="462" y="465.4688" /><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="122" x="469" y="487.002">Authorization Client</text><rect fill="#FEFECE" filter="url(#fly8oroncbft7)" height="31.6094" style="stroke:#A80036;stroke-width:1.5;" width="142" x="769" y="89.6406" /><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="128" x="776" y="111.1738">Authorization Server</text><rect fill="#FEFECE" filter="url(#fly8oroncbft7)" height="31.6094" style="stroke:#A80036;stroke-width:1.5;" width="142" x="769" y="465.4688" /><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="128" x="776" y="487.002">Authorization Server</text><path d="M9,143.25 L216,143.25 L216,151.25 L206,161.25 L9,161.25 L9,143.25 " fill="#EEEEEE" style="stroke:#000000;stroke-width:1.0;" /><rect fill="none" height="306.2188" style="stroke:#000000;stroke-width:2.0;" width="916" x="9" y="143.25" /><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="158" x="24" y="157.7451">Get Access Token (ITI-71)</text><text fill="#000000" font-family="sans-serif" font-size="11" font-weight="bold" lengthAdjust="spacing" textLength="147" x="231" y="156.6689">[Authorization Code Grant]</text><polygon fill="#A80036" points="145,196.3047,135,200.3047,145,204.3047,141,200.3047" style="stroke:#A80036;stroke-width:1.0;" /><line style="stroke:#A80036;stroke-width:1.0;" x1="139" x2="531" y1="200.3047" y2="200.3047" /><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="22" x="151" y="187.2725">[00]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="183" x="177" y="179.0967">Redirect to Authorization Server</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="348" x="177" y="195.4482">(authorization request incl requested scopes, resource, etc.)</text><polygon fill="#A80036" points="830,226.6563,840,230.6563,830,234.6563,834,230.6563" style="stroke:#A80036;stroke-width:1.0;" /><line style="stroke:#A80036;stroke-width:1.0;" x1="134" x2="836" y1="230.6563" y2="230.6563" /><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="22" x="141" y="225.7998">[01]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="121" x="167" y="225.7998">authorization request</text><path d="M19,243.6563 L19,285.6563 L884,285.6563 L884,253.6563 L874,243.6563 L19,243.6563 " fill="#FBFB77" filter="url(#fly8oroncbft7)" style="stroke:#A80036;stroke-width:1.0;" /><path d="M874,243.6563 L874,253.6563 L884,253.6563 L874,243.6563 " fill="#FBFB77" style="stroke:#A80036;stroke-width:1.0;" /><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="287" x="300.5" y="262.1514">Authorization Server determines access based on</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="289" x="300.5" y="278.5029">user authentication, consent and/or other policies.</text><polygon fill="#A80036" points="145,330.0625,135,334.0625,145,338.0625,141,334.0625" style="stroke:#A80036;stroke-width:1.0;" /><line style="stroke:#A80036;stroke-width:1.0;" x1="139" x2="841" y1="334.0625" y2="334.0625" /><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="22" x="151" y="321.0303">[02]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="100" x="177" y="312.8545">Redirect to Client</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="280" x="177" y="329.2061">(authorization response with Authorization Code)</text><polygon fill="#A80036" points="520,360.4141,530,364.4141,520,368.4141,524,364.4141" style="stroke:#A80036;stroke-width:1.0;" /><line style="stroke:#A80036;stroke-width:1.0;" x1="134" x2="526" y1="364.4141" y2="364.4141" /><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="22" x="141" y="359.5576">[03]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="131" x="167" y="359.5576">authorization response</text><polygon fill="#A80036" points="830,407.1172,840,411.1172,830,415.1172,834,411.1172" style="stroke:#A80036;stroke-width:1.0;" /><line style="stroke:#A80036;stroke-width:1.0;" x1="532" x2="836" y1="411.1172" y2="411.1172" /><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="22" x="539" y="398.085">[04]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="160" x="565" y="389.9092">Get Access Token Request</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="232" x="565" y="406.2607">(client credentials + Authorization Code)</text><polygon fill="#A80036" points="543,437.4688,533,441.4688,543,445.4688,539,441.4688" style="stroke:#A80036;stroke-width:1.0;" /><line style="stroke:#A80036;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="537" x2="841" y1="441.4688" y2="441.4688" /><text fill="#000000" font-family="sans-serif" font-size="13" font-weight="bold" lengthAdjust="spacing" textLength="22" x="549" y="436.6123">[05]</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="260" x="575" y="436.6123">Get Access Token Response (access token)</text></g></svg></div>

<table class="table table-bordered">
  <thead>
    <tr>
      <th>Step</th>
      <th>Parameter</th>
      <th>Opt (Basic/ Extended).</th>
      <th>Reference</th>
      <th>Remark</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>The mHealth App sends a HTTP GET request to the IUA Authorization Server endpoint.</td>
      <td>response_type</td>
      <td>R</td>
      <td>IUA</td>
      <td>The value must be code.</td>
    </tr>
    <tr>
      <td> </td>
      <td>client_id</td>
      <td>R</td>
      <td>IUA</td>
      <td>The ID, the client is registered at the IUA Authorization Server.</td>
    </tr>
    <tr>
      <td> </td>
      <td>redirect_uri</td>
      <td>R</td>
      <td>IUA / SMART on FHIR</td>
      <td>Used as callback URL, the IUA Authorization Server will send the authorization code to. The URL SHALL match one of the client’s pre-registered redirect URIs.</td>
    </tr>
    <tr>
      <td> </td>
      <td>state</td>
      <td>R</td>
      <td>IUA</td>
      <td>An unguessable value used by the client to track the state between the authorization request and the callback.</td>
    </tr>
    <tr>
      <td> </td>
      <td>scope</td>
      <td>R</td>
      <td>IUA / SMART on FHIR</td>
      <td>Attributes the app claims (see detailed description below).</td>
    </tr>
    <tr>
      <td> </td>
      <td>aud</td>
      <td>R</td>
      <td>SMART on FHIR</td>
      <td>The audience URL the token will be used for.</td>
    </tr>
    <tr>
      <td> </td>
      <td>launch</td>
      <td>O/R</td>
      <td>SMART on FHIR</td>
      <td>If present, the launch parameter indicates that the app (or the view) was launched from an EHR or mHealth App context which has already been authorized to access the Swiss EPR (e.g. SMART on FHIR based primary system).</td>
    </tr>
    <tr>
      <td> </td>
      <td>code_challenge</td>
      <td>R</td>
      <td>IUA</td>
      <td>Transformed version of code_verifier with code_challenge_method</td>
    </tr>
    <tr>
      <td> </td>
      <td>code_challenge_method</td>
      <td>R</td>
      <td>IUA</td>
      <td>SHALL be “S256”.</td>
    </tr>
    <tr>
      <td>The Authorization Server performs a HTTP GET on the callback URL (redirect_uri) conveying the authorization code.</td>
      <td>code</td>
      <td>R</td>
      <td>IUA</td>
      <td>The authorization code generated by the Authorization Server.</td>
    </tr>
    <tr>
      <td> </td>
      <td>state</td>
      <td>R</td>
      <td>IUA</td>
      <td>The unguessable value used by the client to track the state between the authorization request and the callback.</td>
    </tr>
    <tr>
      <td>The app performs an HTTP POST with parameter</td>
      <td>client_id</td>
      <td>R</td>
      <td>IUA</td>
      <td>The ID the client is registered at the IUA Authorization Server.</td>
    </tr>
    <tr>
      <td>as a form-encoded HTTP entity body, passing its</td>
      <td>redirect_uri</td>
      <td>R</td>
      <td>IUA</td>
      <td>The URI to redirect the apps user agent to.</td>
    </tr>
    <tr>
      <td>client_id and client_secret as an HTTP Basic authorization header.</td>
      <td>grant_type</td>
      <td>R</td>
      <td>IUA</td>
      <td>Value shall be “authorization_code”.</td>
    </tr>
    <tr>
      <td> </td>
      <td>code</td>
      <td>R</td>
      <td>IUA</td>
      <td>The authorization code.</td>
    </tr>
    <tr>
      <td> </td>
      <td>code_verifier</td>
      <td>R</td>
      <td>IUA</td>
      <td>The original code verifier string.</td>
    </tr>
    <tr>
      <td>The Authorization Server responds with the access token in the HTML body element.</td>
      <td>access_token</td>
      <td>R</td>
      <td>IUA</td>
      <td>A string containing the access token which may either be a JWT or a XUA Authorization Assertion.</td>
    </tr>
    <tr>
      <td> </td>
      <td>token_type</td>
      <td>R</td>
      <td>IUA</td>
      <td>The value of the parameter shall be Bearer.</td>
    </tr>
    <tr>
      <td> </td>
      <td>scope</td>
      <td>R</td>
      <td>IUA</td>
      <td>The scope granted by the Authorization Server.</td>
    </tr>
    <tr>
      <td> </td>
      <td>expires_in</td>
      <td>R</td>
      <td>IUA</td>
      <td>Maximum duration of 5 minutes.</td>
    </tr>
    <tr>
      <td> </td>
      <td>refresh_token</td>
      <td>O</td>
      <td>IUA</td>
      <td><span style="background-color: #fff2ff;">how to handle refresh tokens <a href="https://github.com/ehealthsuisse/ch-epr-mhealth/issues/20">#20</a></span></td>
    </tr>
  </tbody>
</table>

<figcaption id="5">Description of the HTTP conversation of the transaction.</figcaption>

<h3 id="trigger-events">Trigger Events</h3>

<p>A user launches an mHealth App or a specific application view to access data and documents from the Swiss EPR.</p>

<h3 id="message-semantics">Message Semantics</h3>

<h4 id="request">Request</h4>

<p>The following table summarizes the requirements on the scope parameter used to convey the claims:</p>

<table class="table table-bordered">
  <thead>
    <tr>
      <th>Scope</th>
      <th>Optionality (Basic/ Extended)</th>
      <th>Type</th>
      <th>Reference</th>
      <th>Remark</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>launch</td>
      <td>O/R</td>
      <td> </td>
      <td>SMART on FHIR</td>
      <td>Permission to obtain launch context when the app is launched from an EHR. Required for apps or views launched from an EHR or a mHealth App which was authorized before.</td>
    </tr>
    <tr>
      <td>purpose_of_use</td>
      <td>O/R</td>
      <td>token<sup><a href="#3">3</a></sup></td>
      <td>See sections below.</td>
      <td>Value taken from code system 2.16.756.5.30.1.127.3.10.5 of the CH: EPR value set.</td>
    </tr>
    <tr>
      <td>subject_role</td>
      <td>O/R</td>
      <td>token</td>
      <td>See sections below.</td>
      <td>Only the values for the Role of Healthcare Professionals, Assistants, Patients and Representatives are allowed.</td>
    </tr>
    <tr>
      <td>person_id</td>
      <td>O/R</td>
      <td>string, CX</td>
      <td>See sections below.</td>
      <td>EPR-SPID identifier of the patient’s record and the patient assigning authority formatted in CX syntax.</td>
    </tr>
    <tr>
      <td>principal</td>
      <td>O/O</td>
      <td>token</td>
      <td>See sections below.</td>
      <td>Name of the healthcare professional an assistant is acting on behalf of.</td>
    </tr>
    <tr>
      <td>principal_id</td>
      <td>O/O</td>
      <td>token</td>
      <td>See sections below.</td>
      <td>GLN of the healthcare professional an assistant is acting on behalf of.</td>
    </tr>
    <tr>
      <td>group</td>
      <td>O/O</td>
      <td>string</td>
      <td>See sections below.</td>
      <td>Name of the organization or group an assistant is acting on behalf of.</td>
    </tr>
    <tr>
      <td>group_id</td>
      <td>O/O</td>
      <td>string</td>
      <td>See sections below.</td>
      <td>OID of the organization or group an assistant is acting on behalf of.</td>
    </tr>
    <tr>
      <td>access_token_format</td>
      <td>O/O</td>
      <td>string</td>
      <td> </td>
      <td>Either ihe-jwt or ihe-saml as value. Will return this token_flavor. If scope is not provided defaults to ihe-jwt.</td>
    </tr>
  </tbody>
</table>

<p><sup id="3">3</sup>Token format according FHIR <a href="https://www.hl7.org/fhir/search.html#token">token type</a>.</p>

<figcaption id="6">Overview of the request’s scope parameter. For the explanation see the following sections.</figcaption>

<p>The scope parameter of the request MAY claim the following attributes:</p>
<ul>
  <li>There may be a scope with name “launch”. If present, it indicates the permission to obtain launch context for apps (or views) launched in SMART EHR Launch mode. The scope SHALL be used by all apps (or views) launched from a mHealth App which was authorized before.</li>
  <li>There MAY be a scope with name “purpose_of_use=token”. If present, the token SHALL convey the coded value of the current transaction’s purpose of use. Allowed values are NORM (normal access) and EMER (emergency access) from code system 2.16.756.5.30.1.127.3.10.5 of the CH:EPR value set. e.g. purpose_of_use=urn:oid:2.16.756.5.30.1.127.3.10.5|NORM</li>
  <li>There MAY be a scope with name “subject_role=token”. If present, the token SHALL convey the coded value of the subject’s role. The value SHALL be either HCP (healthcare professional), ASS (assistant), REP (representative) or PAT (patient) from code system 2.16.756.5.30.1.127.3.10.6 of the CH:EPR value set. e.g.: subject_role=urn:oid:2.16.756.5.30.1.127.3.10.6|HCP</li>
  <li>There MAY be a scope with name “person_id=value”. If present, the value SHALL convey the EPR-SPID identifier of the patient’s record and the patient assigning authority formatted in CX syntax. e.g: person_id=761337610435209810^^^&amp;2.16.756.5.30.1.109.6.5.3.1.1&amp;ISO</li>
</ul>

<p>Depending on the value of the role scope additional scopes are required, as described in the following sections.</p>

<h5 id="healthcare-professional-extension">Healthcare Professional Extension</h5>
<p>In the healthcare professional extension, the scope subject_role SHALL be the code HCP from code system 2.16.756.5.30.1.127.3.10.6 of the CH:EPR value set.</p>

<h5 id="assistant-extension">Assistant Extension</h5>
<p>In the assistant extension, the scope subject_role SHALL be the code ASS from code system 2.16.756.5.30.1.127.3.10.6 of the CH:EPR value set. There SHALL be a scope with name principal_id=value. The value SHALL convey the GLN of the healthcare professional an assistant is acting on behalf of. There SHALL be a scope with name principal=value. The value SHALL convey the name of the healthcare professional an assistant is acting on behalf of.
There MAY be one or more scopes with name group_id=value and corresponding group=value. If present each value SHALL convey the ID and name of the subject’s organization or group as registered in the EPR HPD. The ID MUST be an OID in the format of an URN.</p>

<h5 id="patient-extension">Patient Extension</h5>
<p>In the patient extension, the scope subject_role SHALL be the code PAT from code system 2.16.756.5.30.1.127.3.10.6 of the CH:EPR value set. The value of the purpose of use scope SHALL be the code NORM from code system 2.16.756.5.30.1.127.3.10.5 of the CH:EPR value set.</p>

<h5 id="representative-extension">Representative Extension</h5>
<p>In the representative extension, the scope subject_role SHALL be the code REP from code system 2.16.756.5.30.1.127.3.10.6 of the CH:EPR value set. The token of the purpose_of_use scope SHALL be the code NORM from code system 2.16.756.5.30.1.127.3.10.5 of the CH:EPR value set.</p>

<h4 id="response">Response</h4>
<p>The response SHALL either convey a basic access token in JWT format, granting basic access to the EPR (i.e. to access patient data), or an extended access token to access resources protected by the role and attribute based EPR authorization (i.e. read and write documents).</p>

<h5 id="json-web-token-option">JSON Web Token Option</h5>

<p>The Authorization Server and Resource Server SHALL support the 3.71.4.2.2.1.1 JWT IUA extension with the following claims as defined in Table <a href="#jwttiua">below</a>.</p>

<p>The claim content for the JWT IUA extensions SHALL correspond to the content defined in the XUA specification (see 1.6.4.2 Get X-User Assertion, A5E1).</p>

<table class="table table-bordered">
  <thead>
    <tr>
      <th>JWT Claim (Extension)</th>
      <th>Optionality</th>
      <th>XUA Attribute EPR</th>
      <th>Remark</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>subject_name</td>
      <td>O/R</td>
      <td>urn:oasis:names:tc:xspa:1.0:subject:subject-id</td>
      <td>Plain text’s user name.</td>
    </tr>
    <tr>
      <td>subject_role</td>
      <td>O/R</td>
      <td>urn:oasis:names:tc:xacml:2.0:subject:role</td>
      <td>Code indicating the user role. In the Swiss EPR the value SHALL be taken from the EPR Role Code Value Set.</td>
    </tr>
    <tr>
      <td>purpose_of_use</td>
      <td>O/R</td>
      <td>urn:oasis:names:tc:xspa:1.0:subject:purposeofuse</td>
      <td>Code indicating the purpose of use. In the Swiss EPR the value SHALL be taken from the EPR Purpose Of Use Value Set.</td>
    </tr>
    <tr>
      <td>person_id</td>
      <td>O/R</td>
      <td>urn:oasis:names:tc:xacml:2.0:resource:resource-id</td>
      <td>SHALL be the EPR-SPID of the patients EPR.  </td>
    </tr>
  </tbody>
</table>

<figcaption id="jwttiua">Attributes of the IUA Get Access Token response in the JWT extension ihe_iua.</figcaption>

<h5 id="the-jwt-ch_epr-extension">The JWT ch_epr extension</h5>

<p>The Authorization Server and Resource Server SHALL support the following extensions to the JWT access token for an EPR user:</p>
<ul>
  <li>user_id: subject identifier according to Annex 5 E1 1.6.4.3.4.2 Message Semantics.</li>
</ul>

<table class="table table-bordered">
  <thead>
    <tr>
      <th>JWT Claim (Extension)</th>
      <th>Optionality</th>
      <th>XUA Attribute EPR</th>
      <th>Remark</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>user_id</td>
      <td>R</td>
      <td>&lt;NameID&gt; child element of the &lt;Subject&gt;</td>
      <td>Depending on the Annex 5 E1 Extension</td>
    </tr>
    <tr>
      <td>user_id_qualifier</td>
      <td>R</td>
      <td>Name qualifier attribute of &lt;NameID&gt;</td>
      <td>Depending on the Annex 5 E1 Extension</td>
    </tr>
  </tbody>
</table>

<figcaption>Attributes of the IUA Get Access Token response in the JWT extension ch_delegation.</figcaption>

<h5 id="the-jwt-ch_group-extension">The JWT ch_group extension</h5>

<p>The Authorization Server and Resource Server SHALL support the following extensions to the JWT access token for a list of groups a subject is member of:</p>
<ul>
  <li>name: Name of the organization/group. The name MUST be a string.</li>
  <li>id: The id of the organization/group.The id MUST be an OID in the format of an URN</li>
</ul>

<p>The ch_group extension claims shall be wrapped in an “extensions” object with key ‘ch_group’ and a JSON array containing the JSON objects with properties name and id. The id MUST be an OID in the format of an URN.</p>

<table class="table table-bordered">
  <thead>
    <tr>
      <th>ch_group array element</th>
      <th>Optionality</th>
      <th>XUA Attribute EPR</th>
      <th>Remark</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>name</td>
      <td>O/R</td>
      <td>urn:oasis:names:tc:xspa:1.0:subject:organization</td>
      <td>In XUA it is an array of text description of the groups/organizations, in the JWT extension it is an array of groups with properties name, id.</td>
    </tr>
    <tr>
      <td>id</td>
      <td>O/R</td>
      <td>urn:oasis:names:tc:xspa:1.0:subject:organization-id</td>
      <td>In XUA it is an array of ids of the groups/organizations, in the JWT extension it is an array of group name, group id.</td>
    </tr>
  </tbody>
</table>

<figcaption>Attributes of the IUA Get Access Token response in the JWT extension ch_group.</figcaption>

<h5 id="the-jwt-ch_delegation-extension">The JWT ch_delegation extension</h5>

<p>The Authorization Server and Resource Server shall support the following extensions to the JWT access token:</p>
<ul>
  <li>principal (optional) Name of the healthcare professional an assistant is acting on behalf of.</li>
  <li>principal_id (optional) GLN of the healthcare professional an assistant is acting on behalf of.</li>
</ul>

<p>The ch_delegation extension claims shall be wrapped in an “extensions” object with key ‘ch_delegation’ and a JSON value object containing the claims. 
The claim content for the JWT CH:EPR extensions shall correspond to the content defined in the XUA specification (see 1.6.4.2 Get X-User Assertion, A5E1).</p>

<table class="table table-bordered">
  <thead>
    <tr>
      <th>JWT Claim (Extension)</th>
      <th>Optionality</th>
      <th>XUA Attribute EPR</th>
      <th>Remark</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>principal</td>
      <td>O/R</td>
      <td>urn:e-health-suisse:principal-name</td>
      <td>Name of the healthcare professional an assistant is acting on behalf of.</td>
    </tr>
    <tr>
      <td>principal_id</td>
      <td>O/R</td>
      <td>urn:e-health-suisse:principal-id</td>
      <td>GLN of the healthcare professional an assistant is acting on behalf of.</td>
    </tr>
  </tbody>
</table>

<figcaption>Attributes of the IUA Get Access Token response in the JWT extension ch_delegation.</figcaption>

<h3 id="expected-actions-iua-authorization-client">Expected Actions IUA Authorization Client</h3>
<p>The IUA Authorization Client SHALL support the HTTP conversation of the OAuth 2.1 Authorization Code grant as follows:</p>

<p>When launched, the IUA Authorization Client SHALL perform HTTP GET request with the URL query parameter as defined in <a href="#5">Table</a> and with the scope claims described in <a href="#6">Table</a>.</p>

<p>If the IUA Authorization Client receives the request from the IUA Authorization Server on the callback URL conveying the authorization code, it SHALL perform the HTTP POST request with the client_id and client_secret in the HTTP authorization header to resolve the authorization code to the access token.</p>

<p>The IUA Authorization Client SHALL use the access token as defined in IUA Incorporate Access Token transaction, when performing requests to resources of the Swiss EPR<sup><a href="#4">4</a></sup>.</p>

<h3 id="expected-actions-iua-authorization-server">Expected Actions IUA Authorization Server</h3>
<p>The IUA Authorization Server SHALL support the HTTP conversation of the OAuth 2.1 Authorization Code grant as follows:</p>

<p>If the IUA Authorization Server receives a request, it SHALL authenticate the user by redirecting the request to a XUA Authentication Provider<sup><a href="#5">5</a></sup>. The XUA Authentication provider authenticates the user based on its internal session management (i.e. by checking the requests cookies or other methods) or by validating the user authentication means and returns the identity token to the IUA Authorization Server.</p>

<p>In case of authentication failure, the IUA Authorization Server must respond with HTTP error code 401 ‘Not authorized’.</p>

<p>The IUA Authorization Server SHALL verify the user consent for the mHealth App either by presenting the user a dialog to confirm the required consent, or by validating preregistered contracts.</p>

<p>If the app (or view) is launched as an SMART EHR Launch, the IUA Authorization Server SHALL validate the launch scope parameter, by verifying that the user consent is registered with this launch parameter value. In case of failure, it SHALL respond with HTTP error code 401 ‘Not authorized’.</p>

<p>Depending on the scope claimed, the IUA Authorization Server SHALL either build a basic access authorization token allowing basic access to the EPR (i.e. to access patient data), or an extended access to access resources protected by the role and attribute based EPR authorization (i.e. read and write documents).</p>

<p>The business rules for the IUA Authorization Server for the Healthcare Professional, Assistant, Patient and Representative Extension SHALL be the same as for Annex 5E1 1.6.4.2.4.4 Expected Actions X-Assertion Provider Extensions.</p>

<p>If successful the IUA Authorization Server SHALL generate an OAuth 2.1 authorization code and perform a callback to the URL defined in the request, using the OAuth authorization code as URL query parameter with key ‘code’.</p>

<p>The IUA Authorization Server SHALL store the access token and the assigned authorization code and respond the access token on request to the Authorization Client.</p>

<p><sup id="4">4</sup>This covers all possible EPR transaction, with the exception of the ITI-103<br />
<sup id="5">5</sup>The XUA Authentication Provider currently only supports SAML 2 based authentication as defined in Annex 8 of the EPDV-EDI, but will be extended to Open ID Connect in the future. Currently SMART on FHIR does not have a SAML 2 option.</p>

<h3 id="message-example">Message Example</h3>

<h4 id="request-1">Request</h4>

<p>The first step of the request conversion is a HTTP GET which may look like for a basic access token:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GET authorize?
    response_type=code&amp;
    client_id=app-client-id&amp;
    http%3A%2F%2Flocalhost%3A9000%2Fcallback&amp;
    launch=xyz123&amp;
    scope=launch+user%2F%2A.%2A+openid+fhirUser&amp;state=98wrghuwuogerg97&amp;aud=https%3A%2F%2Fehr%2Ffhir&amp;code_challenge=ZmVjMmIwMWYyYTNjZWJiNTgyNTgxYzlmOGYyMWM0MWI3YmZhMjQ4YjU5MDc3Mzk4MDBmYTk0OThlNzZiNjAwMw&amp;code_challenge_method=S256 HTTP/1.1

Host: localhost:9001
</code></pre></div></div>

<p>for an extended access token where at least purpose_of_use (NORM), subject_role (HCP) and person_id are added to the scope:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GET authorize?
    response_type=code&amp;
    client_id=app-client-id&amp;
    http%3A%2F%2Flocalhost%3A9000%2Fcallback&amp;
    launch=xyz123&amp;
    scope=launch+user%2F*.*+openid+fhirUser+purpose_of_use%3Durn%3Aoid%3A2.16.756.5.30.1.127.3.10.5%7CNORM+subject_role%3Durn%3Aoid%3A2.16.756.5.30.1.127.3.10.6%7CHCP+person_id%3D761337610411353650%5E%5E%5E%26amp%3B2.16.756.5.30.1.127.3.10.3%26amp%3BISO%0A&amp;code_challenge=ZmVjMmIwMWYyYTNjZWJiNTgyNTgxYzlmOGYyMWM0MWI3YmZhMjQ4YjU5MDc3Mzk4MDBmYTk0OThlNzZiNjAwMw&amp;code_challenge_method=S256 HTTP/1.1

Host: localhost:9001
</code></pre></div></div>

<p>The second step of the request conversion is a HTTP GET Callback conveying the authorization code and may look like:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GET /callback?code=8V1pr0rJ&amp;state=98wrghuwuogerg97 HTTP/1.1 

Host: localhost:9000
</code></pre></div></div>

<p>The third step of the request conversion is a HTTP POST sending the authorization code to retrieve the authorization token in the response which may look like:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>POST /token HTTP/1.1 
Host: localhost:9001

Accept: application/json
Content-type: application/x-www-form-encoded
Authorization: Basic bXktYXBwOm15LWFwcC1zZWNyZXQtMTIz
grant_type=authorization_code&amp;redirect_uri=http%3A%2F%2Flocalhost%3A9000%2Fcallback&amp;code=98wrghuwuogerg97&amp;code_verifier=qskt4342of74bkncmicdpv2qd143iqd822j41q2gupc5n3o6f1clxhpd2x11
</code></pre></div></div>

<h4 id="response-1">Response</h4>

<p>A JWT access token returned by the IUA Authorization Server and to be used to retrieve patient data may look like:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"iss"</span><span class="p">:</span><span class="w"> </span><span class="s2">"http://issuerAdress.ch"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"sub"</span><span class="p">:</span><span class="w"> </span><span class="s2">"UserId-bfe8a208-b9d0-4012-b2f5-168b949fc3cb"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"aud"</span><span class="p">:</span><span class="w"> </span><span class="s2">"http://pixmResourceServerURL.ch"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"exp"</span><span class="p">:</span><span class="w"> </span><span class="mi">1587294580000</span><span class="p">,</span><span class="w">
  </span><span class="nl">"nbf"</span><span class="p">:</span><span class="w"> </span><span class="mi">1587294460000</span><span class="p">,</span><span class="w">
  </span><span class="nl">"iat"</span><span class="p">:</span><span class="w"> </span><span class="mi">1587294460000</span><span class="p">,</span><span class="w">
  </span><span class="nl">"jti"</span><span class="p">:</span><span class="w"> </span><span class="s2">"c5436729-3f26-4dbf-abd3-2790dc7771a"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"extensions"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">  
    </span><span class="nl">"ihe_iua"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">  
      </span><span class="nl">"subject_name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Martina Musterarzt"</span><span class="w">
    </span><span class="p">},</span><span class="w"> 
    </span><span class="nl">"ch_epr"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"user_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2000000090092"</span><span class="p">,</span><span class="w"> 
      </span><span class="nl">"user_id_qualifier"</span><span class="p">:</span><span class="w"> </span><span class="s2">"urn:gs1:gln"</span><span class="w"> 
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>A extend JWT access token to be used to access patient documents SHALL have the additional attributes of the purpose of use, subject role, the EPR-SPID of the patient and may look like:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"iss"</span><span class="p">:</span><span class="w"> </span><span class="s2">"http://issuerAdress.ch"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"sub"</span><span class="p">:</span><span class="w"> </span><span class="s2">"UserId-bfe8a208-b9d0-4012-b2f5-168b949fc3cb"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"aud"</span><span class="p">:</span><span class="w"> </span><span class="s2">"http://mhdResourceServerURL.ch"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"exp"</span><span class="p">:</span><span class="w"> </span><span class="mi">1587294580000</span><span class="p">,</span><span class="w">
  </span><span class="nl">"nbf"</span><span class="p">:</span><span class="w"> </span><span class="mi">1587294460000</span><span class="p">,</span><span class="w">
  </span><span class="nl">"iat"</span><span class="p">:</span><span class="w"> </span><span class="mi">1587294460000</span><span class="p">,</span><span class="w">
  </span><span class="nl">"jti"</span><span class="p">:</span><span class="w"> </span><span class="s2">"c5436729-3f26-4dbf-abd3-2790dc7771a"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"extensions"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">  
    </span><span class="nl">"ihe_iua"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">  
      </span><span class="nl">"subject_name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Martina Musterarzt"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"person_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"761337610411353650^^^&amp;amp;2.16.756.5.30.1.127.3.10.3&amp;amp;ISO"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"subject_role"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"system"</span><span class="p">:</span><span class="w"> </span><span class="s2">"urn:oid:2.16.756.5.30.1.127.3.10.6"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"code"</span><span class="p">:</span><span class="w"> </span><span class="s2">"HCP"</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"purpose_of_use"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"system"</span><span class="p">:</span><span class="w"> </span><span class="s2">"urn:uuid:2.16.756.5.30.1.127.3.10.5"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"code"</span><span class="p">:</span><span class="w"> </span><span class="s2">"NORM"</span><span class="p">,</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w"> 
    </span><span class="nl">"ch_epr"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"user_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2000000090092"</span><span class="p">,</span><span class="w"> 
      </span><span class="nl">"user_id_qualifier"</span><span class="p">:</span><span class="w"> </span><span class="s2">"urn:gs1:gln"</span><span class="w"> 
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"ch_group"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="p">{</span><span class="w">
        </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Name of group with id urn:oid:2.2.2.1"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"urn:oid:2.2.2.1"</span><span class="w">
      </span><span class="p">},</span><span class="w"> 
      </span><span class="p">{</span><span class="w">
        </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Name of group with id urn:oid:2.2.2.2"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"urn:oid:2.2.2.2"</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="p">{</span><span class="w">
        </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Name of group with id urn:oid:2.2.2.2"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"urn:oid:2.2.2.3"</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">]</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>A JWT access token to be used to access by an assistant acting behalf on a healthcare professional for a patient SHALL have the additional extension ch_delegation:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"iss"</span><span class="p">:</span><span class="w"> </span><span class="s2">"http://issuerAdress.ch"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"sub"</span><span class="p">:</span><span class="w"> </span><span class="s2">"UserId-bfe8a208-b9d0-4012-b2f5-168b949fc3cb"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"aud"</span><span class="p">:</span><span class="w"> </span><span class="s2">"http://mhdResourceServerURL.ch"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"exp"</span><span class="p">:</span><span class="w"> </span><span class="mi">1587294580000</span><span class="p">,</span><span class="w">
  </span><span class="nl">"nbf"</span><span class="p">:</span><span class="w"> </span><span class="mi">1587294460000</span><span class="p">,</span><span class="w">
  </span><span class="nl">"iat"</span><span class="p">:</span><span class="w"> </span><span class="mi">1587294460000</span><span class="p">,</span><span class="w">
  </span><span class="nl">"jti"</span><span class="p">:</span><span class="w"> </span><span class="s2">"c5436729-3f26-4dbf-abd3-2790dc7771a"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"extensions"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">  
    </span><span class="nl">"ihe_iua"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">  
      </span><span class="nl">"subject_name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Dagmar Musterassistent"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"person_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"761337610411353650^^^&amp;amp;2.16.756.5.30.1.127.3.10.3&amp;amp;ISO"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"subject_role"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"system"</span><span class="p">:</span><span class="w"> </span><span class="s2">"urn:oid:2.16.756.5.30.1.127.3.10.6"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"code"</span><span class="p">:</span><span class="w"> </span><span class="s2">"HCP"</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"purpose_of_use"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
          </span><span class="nl">"system"</span><span class="p">:</span><span class="w"> </span><span class="s2">"urn:uuid:2.16.756.5.30.1.127.3.10.5"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"code"</span><span class="p">:</span><span class="w"> </span><span class="s2">"NORM"</span><span class="p">,</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w"> 
    </span><span class="nl">"ch_epr"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"user_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2000000090108"</span><span class="p">,</span><span class="w"> 
      </span><span class="nl">"user_id_qualifier"</span><span class="p">:</span><span class="w"> </span><span class="s2">"urn:gs1:gln"</span><span class="w"> 
    </span><span class="p">},</span><span class="w"> 
    </span><span class="nl">"ch_group"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="p">{</span><span class="w">
        </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Name of group with id urn:oid:2.2.2.1"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"urn:oid:2.2.2.1"</span><span class="w">
      </span><span class="p">},</span><span class="w"> 
      </span><span class="p">{</span><span class="w">
        </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Name of group with id urn:oid:2.2.2.2"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"urn:oid:2.2.2.2"</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="p">{</span><span class="w">
        </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Name of group with id urn:oid:2.2.2.2"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"urn:oid:2.2.2.3"</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">],</span><span class="w">
    </span><span class="nl">"ch_delegation"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"principal"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Martina Musterarzt"</span><span class="p">,</span><span class="w"> 
      </span><span class="nl">"principal_id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2000000090092"</span><span class="w"> 
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h3 id="security-consideration">Security Consideration</h3>

<p>As specified in the IUA profile, the IUA Authorization Client and Authorization Server actors SHALL support the JWS (signed) alternative of the JWT token. Any actor that supports this transaction MAY support the JWE (unsigned but encrypted) alternative of the JWT token.</p>




</div>
        </div>  <!-- /inner-wrapper -->
      </div>  <!-- /row -->
    </div>  <!-- /container -->
  </div>  <!-- /segment-content -->

  <script type="text/javascript" src="assets/js/jquery.js"> </script>     <!-- note keep space here, otherwise it will be transformed to empty tag -> fails -->
  <script type="text/javascript" src="assets/js/jquery-ui.min.js"> </script>

  <script type="text/javascript">
    $(document).ready(function(){
      if(window.location.hash != "") {
          $('a[href="' + window.location.hash + '"]').click()
      }
    });
  </script>
  <a name="bottom"> </a>
  <div id="segment-footer" igtool="footer" class="segment">  <!-- segment-footer -->
    <div class="container">  <!-- container -->

      <div class="inner-wrapper">
        <p>
          IG &#169; 2020+ <a style="color:var(--footer-hyperlink-text-color)" href="https://www.e-health-suisse.ch">eHealth Suisse</a>.  Package ch.fhir.ig.ch-epr-mhealth#1.0.0 based on <a style="color: var(--footer-hyperlink-text-color)" href="http://hl7.org/fhir/R4/">FHIR 4.0.1</a>. Generated <span title="Wed, Dec 22, 2021 14:15+0100">2021-12-22</span>
          <br/>
          <span style="color: var(--footer-highlight-text-color)"></span>
                      Links: <a style="color: var(--footer-hyperlink-text-color)" href="toc.html">Table of Contents</a> |
                 <a style="color: var(--footer-hyperlink-text-color)" href="qa.html">QA Report</a>
                 
                

| <a style="color: #81BEF7" target="_blank" href="https://docs.google.com/forms/d/e/1FAIpQLSffM9HysTOg3VdMOeaFmWiWGH0OQT-FZLmwZaeXgZqUr66Y0A/viewform?usp=sf_link&amp;entry%2E1353807103=ch.fhir.ig.ch-epr-mhealth%231.0.0%20/iti-71.html&amp;entry%2E247644557=Get%20Access%20Token%20[ITI-71]">Propose a change</a>

          </span>
        </p>
      </div>  <!-- /inner-wrapper -->
    </div>  <!-- /container -->
  </div>  <!-- /segment-footer -->
  
  <div id="segment-post-footer" class="segment hidden">  <!-- segment-post-footer -->
    <div class="container">  <!-- container -->
    </div>  <!-- /container -->
  </div>  <!-- /segment-post-footer -->
  
  <!-- JS and analytics only. -->
  <!-- Bootstrap core JavaScript
  ================================================== -->
  <!-- Placed at the end of the document so the pages load faster -->
  <script type="text/javascript" src="assets/js/bootstrap.min.js"> </script>
  <script type="text/javascript" src="assets/js/respond.min.js"> </script>
  <script type="text/javascript" src="assets/js/anchor.min.js"> </script>
  <script>anchors.options.visible = 'hover'
anchors.add()</script>
  
<!-- feedback form - Google forms -->
<!-- v0.1, 2021-01-09 -->


  


  



<!-- / feedback form  -->

  <!-- Analytics Below
  ================================================== -->
  </body>
</html>

